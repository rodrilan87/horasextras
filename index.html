<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA OSDE - FULL</title>
    <style>
        :root { --navy: #003057; --sky: #0076BE; --orange: #E87722; --bg: #f8f9fa; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin: auto; max-width: 800px; border-top: 6px solid var(--navy); }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .btn { width: 100%; padding: 14px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; text-transform: uppercase; }
        .btn-navy { background: var(--navy); }
        .btn-orange { background: var(--orange); margin-top: 10px; }
        .oculto { display: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 13px; }
        th { background: #eee; padding: 10px; text-align: left; }
        td { padding: 10px; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>

    <div id="auth-box" class="card" style="max-width: 400px; margin-top: 50px;">
        <h2 style="text-align: center; color: var(--navy);">OSDE GESTIÃ“N</h2>
        <div id="login-form">
            <input type="email" id="l_email" placeholder="Email corporativo">
            <input type="password" id="l_pass" placeholder="ContraseÃ±a">
            <button class="btn btn-navy" onclick="app.login()">INGRESAR</button>
            <p style="text-align: center; font-size: 13px; cursor: pointer; color: var(--sky);" onclick="app.toggle()">Â¿No tenÃ©s cuenta? Registrate</p>
        </div>
        <div id="reg-form" class="oculto">
            <input type="text" id="r_name" placeholder="Nombre completo">
            <input type="email" id="r_email" placeholder="Email @osde.com.ar">
            <input type="password" id="r_pass" placeholder="ContraseÃ±a">
            <button class="btn" style="background: #27ae60;" onclick="app.register()">CREAR CUENTA</button>
            <p style="text-align: center; font-size: 13px; cursor: pointer; color: var(--sky);" onclick="app.toggle()">Volver al Login</p>
        </div>
    </div>

    <div id="dash" class="card oculto">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3 id="txt_bienvenida"></h3>
            <button onclick="location.reload()" style="background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 5px;">SALIR</button>
        </div>
        <div class="grid">
            <div style="grid-column: span 2;">
                <label>Detalle de Tarea</label>
                <input type="text" id="c_det" placeholder="Ej: Guardia SÃ¡bado 17/01">
            </div>
            <div>
                <label>Horas</label>
                <input type="number" id="c_hs" step="0.5" placeholder="Ej: 2.5">
            </div>
            <div>
                <label>Tipo</label>
                <select id="c_tipo">
                    <option value="50">Al 50%</option>
                    <option value="100">Al 100%</option>
                </select>
            </div>
            <div style="grid-column: span 2;">
                <label>Tickets / Observaciones</label>
                <input type="text" id="c_tk" placeholder="TK-99999">
            </div>
        </div>
        <button class="btn btn-orange" id="btn-save" onclick="app.save()">GUARDAR JORNADA</button>
        
        <div style="margin-top: 30px;">
            <h4>Registros en Base de Datos</h4>
            <input type="text" id="filtro" placeholder="ðŸ” Filtrar..." onkeyup="app.filtrar()" style="padding: 8px;">
            <table>
                <thead>
                    <tr>
                        <th id="th-user" class="oculto">Usuario</th>
                        <th>Fecha</th>
                        <th>Detalle</th>
                        <th>Horas</th>
                        <th>Tipo</th>
                    </tr>
                </thead>
                <tbody id="lista"></tbody>
            </table>
        </div>
    </div>

    <script>
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzIcj0z-zuhlSAIDA4KExZ7y7aoRp4N58KHpLSJvd9rRvyjOFvMUAhjaHy4oWhNIvlZ/exec";

        const app = {
            currentUser: null,
            data: [],
            toggle() {
                document.getElementById('login-form').classList.toggle('oculto');
                document.getElementById('reg-form').classList.toggle('oculto');
            },
            async login() {
                const m = document.getElementById('l_email').value.toLowerCase().trim();
                const p = document.getElementById('l_pass').value;

                // BYPASS ADMIN
                if(m === "rodri@gmx.com" && p === "1234") {
                    this.currentUser = { n: "Admin", m: m, admin: true };
                    return this.entrar();
                }

                try {
                    const res = await fetch(WEB_APP_URL);
                    this.data = await res.json();
                    const u = this.data.find(r => r[0] === "USER" && r[2] === m && String(r[3]) === String(p));
                    if(u) {
                        this.currentUser = { n: u[1], m: u[2], admin: false };
                        this.entrar();
                    } else { alert("Datos incorrectos"); }
                } catch(e) { alert("Error de conexiÃ³n. RevisÃ¡ que el script estÃ© en 'Cualquiera'."); }
            },
            async register() {
                const n = document.getElementById('r_name').value;
                const m = document.getElementById('r_email').value.toLowerCase().trim();
                const p = document.getElementById('r_pass').value;
                if(!m.endsWith("@osde.com.ar")) return alert("Solo @osde.com.ar");
                await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({type: "registro", n, m, p})
                });
                alert("Registrado! Logueate.");
                this.toggle();
            },
            async entrar() {
                document.getElementById('auth-box').classList.add('oculto');
                document.getElementById('dash').classList.remove('oculto');
                document.getElementById('txt_bienvenida').innerText = "Hola, " + this.currentUser.n;
                if(this.currentUser.admin) document.getElementById('th-user').classList.remove('oculto');
                this.render();
            },
            async render() {
                if(this.data.length === 0) {
                    const res = await fetch(WEB_APP_URL);
                    this.data = await res.json();
                }
                const lista = document.getElementById('lista');
                lista.innerHTML = "";
                const filtrados = this.data.filter(r => {
                    if(this.currentUser.admin) return r[0] === "DATA";
                    return r[0] === "DATA" && r[2] === this.currentUser.m;
                });
                filtrados.reverse().forEach(r => {
                    lista.innerHTML += `<tr>
                        ${this.currentUser.admin ? `<td>${r[1]}</td>` : ''}
                        <td>${new Date(r[4]).toLocaleDateString()}</td>
                        <td>${r[5]}</td>
                        <td>${r[6]} hs</td>
                        <td>${r[7]}%</td>
                    </tr>`;
                });
            },
            async save() {
                const d = document.getElementById('c_det').value;
                const h = document.getElementById('c_hs').value;
                const p = document.getElementById('c_tipo').value;
                const tk = document.getElementById('c_tk').value;
                if(!d || !h) return alert("CompletÃ¡ detalle y horas");
                
                document.getElementById('btn-save').innerText = "GUARDANDO...";
                await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({type: "carga", n: this.currentUser.n, u: this.currentUser.m, d, h, p, tk})
                });
                alert("Guardado!");
                location.reload();
            },
            filtrar() {
                const val = document.getElementById('filtro').value.toLowerCase();
                const rows = document.querySelectorAll("#lista tr");
                rows.forEach(r => r.style.display = r.innerText.toLowerCase().includes(val) ? "" : "none");
            }
        };
    </script>
</body>
</html>
