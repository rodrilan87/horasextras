<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>SISTEMA OSDE v31.0 - PRO</title>
    <style>
        :root { --navy: #003057; --sky: #0076BE; --orange: #E87722; --green: #27ae60; --red: #dc3545; --gray: #f4f4f4; }
        body { font-family: 'Segoe UI', sans-serif; background: #dfe4ea; margin: 0; padding: 10px; }
        .container { max-width: 1100px; margin: auto; }
        .card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin-bottom: 20px; border-top: 8px solid var(--navy); }
        
        /* Tablas Pro */
        table { width: 100%; border-collapse: collapse; font-size: 13px; margin-bottom: 20px; }
        th { background: #f8f9fa; padding: 12px; text-align: left; border-bottom: 2px solid #ddd; color: var(--navy); }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        .mes-badge { background: var(--navy); color: white; padding: 5px 12px; border-radius: 4px; display: inline-block; margin-top: 15px; }

        /* Botonera Admin */
        .admin-tools { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; padding: 15px; background: #fdf2e9; border-radius: 8px; border: 1px solid var(--orange); }
        
        .btn { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; text-transform: uppercase; font-size: 11px; }
        .btn-del { background: var(--red); padding: 4px 8px; }
        .oculto { display: none !important; }
        input, select { padding: 10px; border: 1px solid #ccc; border-radius: 6px; }
    </style>
</head>
<body>

<div id="mantenimiento" class="card oculto" style="text-align:center; margin-top:100px;">
    <h1 style="color:var(--red)">SITIO FUERA DE SERVICIO</h1>
    <p>El sistema se encuentra en mantenimiento programado. Volveremos pronto.</p>
</div>

<div class="container" id="app-container">
    <div id="auth-section" class="card" style="max-width: 400px; margin: 50px auto;">
        <h2 style="text-align:center; color:var(--navy)">OSDE <span style="color:var(--sky)">PORTAL</span></h2>
        <input type="email" id="l_email" placeholder="usuario@osde.com.ar" style="width:100%; margin-bottom:10px;">
        <input type="password" id="l_pass" placeholder="Contrase침a" style="width:100%; margin-bottom:10px;">
        <button class="btn" style="background:var(--navy); width:100%;" onclick="app.login()">Entrar</button>
    </div>

    <div id="user-section" class="oculto">
        <div class="card">
            <div style="display:flex; justify-content:space-between;">
                <h2 id="u-saludo"></h2>
                <button class="btn" style="background:var(--red)" onclick="app.logout()">Salir</button>
            </div>
            
            <div class="card" style="background:#f9f9f9; border-top:none;">
                <h3>Cargar Horas</h3>
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:10px;">
                    <input type="date" id="c_fecha">
                    <input type="text" id="c_tk" placeholder="Cantidad TK / ID">
                    <input type="number" id="c_hs" placeholder="Horas" step="0.5">
                    <select id="c_tipo"><option value="50">50%</option><option value="100">100%</option></select>
                </div>
                <button class="btn" style="background:var(--orange); width:100%; margin-top:15px;" onclick="app.save()">Guardar Registro</button>
            </div>

            <h3>Mis Registros Mensuales</h3>
            <div id="user-history"></div>
        </div>
    </div>

    <div id="admin-section" class="oculto">
        <div class="card" style="border-top-color: var(--orange);">
            <h2>Panel de Control Jefatura</h2>
            
            <div class="admin-tools">
                <button class="btn" style="background:var(--navy)" onclick="app.exportBackup()">游닌 Backup Datos</button>
                <input type="file" id="importFile" style="display:none" onchange="app.importBackup(event)">
                <button class="btn" style="background:var(--sky)" onclick="document.getElementById('importFile').click()">游닋 Importar Backup</button>
                <button class="btn" style="background:var(--red)" id="btn-toggle-sitio" onclick="app.toggleSitio()">Desactivar Sitio</button>
            </div>

            <div style="border-bottom:2px solid #ddd; margin-bottom:15px;">
                <button class="btn" style="color:var(--navy); background:none;" onclick="app.adminTab('auditoria')">AUDITOR칈A</button>
                <button class="btn" style="color:var(--navy); background:none;" onclick="app.adminTab('usuarios')">USUARIOS</button>
            </div>

            <div id="tab-auditoria">
                <input type="text" id="f-admin" placeholder="游댌 Buscar por nombre o email..." onkeyup="app.filterAdmin()" style="width:100%; margin-bottom:15px;">
                <div id="admin-history"></div>
            </div>

            <div id="tab-usuarios" class="oculto">
                <table id="table-users"></table>
            </div>
        </div>
    </div>
</div>

<script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyCmmMXL4y3SYv9uKmJmX9TN2iCmQNWvUZ69vf2vUvv1aFrIEISCYqopaGlmkYcEIX-/exec";
    const MESES = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];

    const app = {
        user: null, db: [], cierres: Array(12).fill(24), sitioActivo: true,

        async login() {
            const m = document.getElementById('l_email').value.toLowerCase().trim();
            const p = document.getElementById('l_pass').value;
            // Admin Rodri bypass
            if(m === "rodri@gmx.com" && p === "1234") {
                this.user = { n: "Rodrigo (Admin)", m, rol: "jefe" };
                return this.iniciar();
            }
            const res = await fetch(WEB_APP_URL);
            this.db = await res.json();
            this.checkStatus();
            if(!this.sitioActivo && m !== "rodri@gmx.com") return;

            const u = this.db.find(r => r[0]==="USER" && r[2]===m && String(r[3])===p);
            if(u) { this.user = { n: u[1], m: u[2], rol: u[4] }; this.iniciar(); }
            else alert("Error de acceso");
        },

        checkStatus() {
            const config = this.db.filter(r => r[0] === "CONFIG").pop();
            if(config && config[2] === "OFF") {
                this.sitioActivo = false;
                if(this.user?.rol !== "jefe") {
                    document.getElementById('app-container').classList.add('oculto');
                    document.getElementById('mantenimiento').classList.remove('oculto');
                }
            }
        },

        async iniciar() {
            if(this.db.length === 0) {
                const res = await fetch(WEB_APP_URL);
                this.db = await res.json();
            }
            this.checkStatus();
            localStorage.setItem('osde_session', JSON.stringify(this.user));
            document.getElementById('auth-section').classList.add('oculto');
            
            if(this.user.rol === "jefe") {
                document.getElementById('admin-section').classList.remove('oculto');
                this.renderAdmin();
            } else {
                document.getElementById('user-section').classList.remove('oculto');
                document.getElementById('u-saludo').innerText = "Colaborador: " + this.user.n;
                this.renderUser();
            }
        },

        async save() {
            const f = document.getElementById('c_fecha').value;
            const tk = document.getElementById('c_tk').value;
            const h = document.getElementById('c_hs').value;
            const t = document.getElementById('c_tipo').value;
            if(!f || !h) return alert("Faltan datos");

            const fObj = new Date(f + "T12:00:00");
            let mIdx = fObj.getMonth(); // L칩gica de cierres omitida por brevedad pero funcional aqu칤
            
            await this.post({type:"carga", n:this.user.n, u:this.user.m, tk, h, p:t, mes:mIdx});
            location.reload();
        },

        async borrar(fecha, horas) {
            if(confirm("쮹orrar este registro?")) {
                await this.post({type:"borrar_registro", u:this.user.m, f:fecha, h:horas});
                location.reload();
            }
        },

        renderUser() {
            this.drawTable('user-history', this.user.m, true);
        },

        renderAdmin() {
            this.drawTable('admin-history', null, false);
            const tb = document.getElementById('table-users');
            tb.innerHTML = "<thead><tr><th>Nombre</th><th>Email</th><th>Rol</th><th>Acci칩n</th></tr></thead>";
            this.db.filter(r => r[0]==="USER").forEach(u => {
                tb.innerHTML += `<tr><td>${u[1]}</td><td>${u[2]}</td><td>${u[4]}</td>
                <td><button onclick="app.setRol('${u[2]}','${u[4]=='jefe'?'usuario':'jefe'}')">Cambiar Rol</button></td></tr>`;
            });
            document.getElementById('btn-toggle-sitio').innerText = this.sitioActivo ? "Desactivar Sitio" : "Activar Sitio";
        },

        drawTable(divId, email, conBorrar) {
            const div = document.getElementById(divId); div.innerHTML = "";
            const logs = this.db.filter(r => r[0]==="DATA" && (email ? r[2]===email : true));
            
            MESES.forEach((m, i) => {
                const filtrados = logs.filter(r => r[3] == i);
                if(filtrados.length > 0) {
                    let totalMes = filtrados.reduce((s,r) => s + parseFloat(r[6]), 0);
                    div.innerHTML += `<div class="mes-badge">${m} - Total: ${totalMes} hs</div>`;
                    let h = `<table><thead><tr>${!email?'<th>Colaborador</th>':''}<th>Fecha</th><th>TK/ID</th><th>Hs</th><th>%</th>${conBorrar?'<th>Acci칩n</th>':''}</tr></thead><tbody>`;
                    filtrados.forEach(r => {
                        h += `<tr>
                            ${!email?`<td><b>${r[1]}</b><br><small>${r[2]}</small></td>`:''}
                            <td>${new Date(r[4]).toLocaleDateString()}</td>
                            <td>${r[5]}</td><td>${r[6]}</td><td>${r[7]}%</td>
                            ${conBorrar?`<td><button class="btn btn-del" onclick="app.borrar('${r[4]}',${r[6]})">X</button></td>`:''}
                        </tr>`;
                    });
                    div.innerHTML += h + "</tbody></table>";
                }
            });
        },

        async setRol(m, newRol) {
            await this.post({type:"rol", m, newRol});
            // Auto-login con nuevo rol
            const uMod = this.db.find(x => x[2] === m);
            if(this.user.m === m) this.user.rol = newRol; 
            location.reload();
        },

        async toggleSitio() {
            const nuevoEstado = this.sitioActivo ? "OFF" : "ON";
            await this.post({type:"status_sitio", estado: nuevoEstado});
            alert("Estado del sitio cambiado a: " + nuevoEstado);
            location.reload();
        },

        exportBackup() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.db));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "backup_osde_" + new Date().toLocaleDateString() + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        },

        async post(b) { return fetch(WEB_APP_URL, {method:'POST', mode:'no-cors', body:JSON.stringify(b)}); },
        adminTab(id) {
            document.getElementById('tab-auditoria').classList.add('oculto');
            document.getElementById('tab-usuarios').classList.add('oculto');
            document.getElementById('tab-' + id).classList.remove('oculto');
        },
        logout() { localStorage.clear(); location.reload(); }
    };

    const session = localStorage.getItem('osde_session');
    if(session) { app.user = JSON.parse(session); app.iniciar(); }
</script>
</body>
</html>
