<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Horas Extras</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #f1f6fd;
}

.topbar {
  display: flex;
  justify-content: flex-end;
  padding: 10px 20px;
}

button {
  padding: 8px 14px;
  border-radius: 6px;
  border: 1px solid #ccc;
  cursor: pointer;
}

.logout {
  background: #eee;
}

.container {
  max-width: 1200px;
  margin: auto;
  padding: 10px;
}

.card {
  background: white;
  border-radius: 12px;
  padding: 15px;
  margin-bottom: 20px;
}

.row {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

input, select, textarea {
  padding: 8px;
  border-radius: 6px;
  border: 1px solid #ccc;
}

textarea {
  width: 100%;
  height: 80px;
  resize: none;
}

.save {
  background: #0b1b2b;
  color: white;
  font-weight: bold;
}

.semaforo {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}

.semaforo div {
  flex: 1;
  padding: 12px;
  border-radius: 10px;
  text-align: center;
  font-weight: bold;
  opacity: .3;
}

.verde { background: #c9f7cf; }
.amarillo { background: #ffeaa7; }
.rojo { background: #ffcccc; }

.activo {
  opacity: 1;
  outline: 2px solid #333;
}

.mes {
  background: #c9f7cf;
  padding: 8px;
  border-radius: 8px;
  font-weight: bold;
  margin-top: 15px;
}

.item {
  background: #ecfff0;
  padding: 10px;
  border-radius: 8px;
  margin-top: 6px;
  display: flex;
  justify-content: space-between;
}

.borrar {
  color: red;
  font-weight: bold;
  cursor: pointer;
}

.total {
  text-align: right;
  font-weight: bold;
  margin-top: 6px;
}
</style>
</head>

<body>

<script>
/* ====== BLOQUEO DE SESIÓN ====== */
const emailLogueado = localStorage.getItem("email");
if (!emailLogueado) {
  window.location.href = "login.html";
}
</script>

<div class="topbar">
  <button class="logout" onclick="logout()">Cerrar sesión</button>
</div>

<div class="container">

<div class="card">
  <div class="row">
    <input id="usuario" readonly />
    <input id="fecha" type="date" />
    <input id="desde" type="time" />
    <input id="hasta" type="time" />
    <input id="tk" placeholder="TK" />
    <select id="porcentaje">
      <option>50%</option>
      <option selected>100%</option>
    </select>
    <button class="save" onclick="guardar()">Guardar</button>
  </div>

  <textarea id="sugerencia" placeholder="Sugerencias (hasta 50 palabras)"></textarea>

  <div class="semaforo">
    <div id="s0" class="verde">0–15 hs</div>
    <div id="s1" class="amarillo">16–25 hs</div>
    <div id="s2" class="rojo">26+ hs</div>
  </div>
</div>

<div class="card" id="listado"></div>

</div>

<script>
/* ===== CONFIG ===== */
const API_URL = "PEGÁ_ACÁ_TU_URL_DE_APPS_SCRIPT";

/* ===== INIT ===== */
usuario.value = emailLogueado;

/* ===== HELPERS ===== */
function logout() {
  localStorage.clear();
  location.href = "login.html";
}

function hoyISO() {
  return new Date().toISOString().split("T")[0];
}

fecha.max = hoyISO();

/* ===== GUARDAR ===== */
function guardar() {
  if (fecha.value > hoyISO()) {
    alert("No se pueden cargar horas a futuro");
    return;
  }

  const data = {
    action: "guardar",
    email: emailLogueado,
    fecha: fecha.value,
    desde: desde.value,
    hasta: hasta.value,
    tk: tk.value,
    porcentaje: porcentaje.value,
    sugerencia: sugerencia.value
  };

  fetch(API_URL, { method: "POST", body: JSON.stringify(data) })
    .then(r => r.json())
    .then(() => cargar());
}

/* ===== BORRADO LÓGICO ===== */
function borrar(id) {
  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({ action: "borrar", id })
  }).then(() => cargar());
}

/* ===== SEMÁFORO ===== */
function actualizarSemaforo(horas) {
  s0.classList.remove("activo");
  s1.classList.remove("activo");
  s2.classList.remove("activo");

  if (horas <= 15) s0.classList.add("activo");
  else if (horas <= 25) s1.classList.add("activo");
  else s2.classList.add("activo");
}

/* ===== CARGAR ===== */
function cargar() {
  fetch(`${API_URL}?action=listar&email=${emailLogueado}`)
    .then(r => r.json())
    .then(data => render(data));
}

function render(data) {
  listado.innerHTML = "";
  let mesActivo = new Date().toISOString().slice(0,7);
  let horasMesActivo = 0;

  Object.keys(data).forEach(mes => {
    const m = document.createElement("div");
    m.className = "mes";
    m.innerText = mes;
    listado.appendChild(m);

    let totalHs = 0;
    let totalTk = 0;

    data[mes].forEach(r => {
      if (r.horas > 0) {
        totalHs += r.horas;
        totalTk++;
        if (mes === mesActivo) horasMesActivo += r.horas;
      }

      const i = document.createElement("div");
      i.className = "item";
      i.innerHTML = `
        <div>
          ${r.fecha} · ${r.horas} hs · TK ${r.tk}
          ${r.horas === 0 ? "<br><i>Este registro se puso en 0</i>" : ""}
        </div>
        <div class="borrar" onclick="borrar('${r.id}')">✕</div>
      `;
      listado.appendChild(i);
    });

    const t = document.createElement("div");
    t.className = "total";
    t.innerText = `Total mes: ${totalHs} hs · ${totalTk} TK`;
    listado.appendChild(t);
  });

  actualizarSemaforo(horasMesActivo);
}

cargar();
</script>

</body>
</html>
