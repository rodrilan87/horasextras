<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA OSDE - GESTI√ìN TOTAL v30</title>
    <style>
        :root { --navy: #003057; --sky: #0076BE; --orange: #E87722; --green: #27ae60; --red: #dc3545; --gray: #f4f4f4; }
        body { font-family: 'Segoe UI', sans-serif; background: #dfe4ea; margin: 0; padding: 10px; }
        .container { max-width: 1100px; margin: auto; }
        .card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin-bottom: 20px; border-top: 8px solid var(--navy); }
        
        /* Sem√°foro */
        .semaforo-bar { height: 20px; background: #eee; border-radius: 10px; overflow: hidden; margin: 10px 0; border: 1px solid #ccc; }
        .progress { height: 100%; transition: 0.5s; width: 0%; }
        .verde { background: var(--green); }
        .naranja { background: var(--orange); }
        .rojo { background: var(--red); }

        /* Tabs */
        .nav-tabs { display: flex; gap: 5px; overflow-x: auto; padding-bottom: 10px; border-bottom: 2px solid #ddd; }
        .tab-btn { padding: 10px 20px; border: none; background: #eee; cursor: pointer; font-weight: bold; border-radius: 8px 8px 0 0; }
        .tab-btn.active { background: var(--navy); color: white; }

        /* Form */
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        input, select, textarea { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .btn { padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; text-transform: uppercase; }
        
        .mes-group { background: var(--navy); color: white; padding: 8px 15px; margin-top: 20px; border-radius: 5px; }
        table { width: 100%; border-collapse: collapse; background: white; margin-top: 5px; font-size: 13px; }
        th { background: #f8f9fa; padding: 10px; border-bottom: 2px solid #ddd; text-align: left; }
        td { padding: 10px; border-bottom: 1px solid #eee; }
        
        .oculto { display: none; }
        .cierre-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; margin-top: 15px; }
        .cierre-box { background: var(--gray); padding: 10px; border-radius: 8px; text-align: center; }
    </style>
</head>
<body>

<div class="container">
    <div id="auth-section" class="card" style="max-width: 400px; margin: 50px auto;">
        <h2 style="text-align:center; color:var(--navy)">OSDE <span style="color:var(--sky)">PORTAL</span></h2>
        <div id="login-form">
            <input type="email" id="l_email" placeholder="Email corporativo">
            <input type="password" id="l_pass" placeholder="Contrase√±a">
            <button class="btn" style="background:var(--navy); width:100%; margin-top:10px;" onclick="app.login()">Entrar</button>
            <p style="text-align:center; font-size:12px; cursor:pointer; color:var(--sky)" onclick="app.toggleAuth()">Solicitar acceso</p>
        </div>
        <div id="reg-form" class="oculto">
            <input type="text" id="r_name" placeholder="Nombre completo">
            <input type="email" id="r_email" placeholder="Email @osde.com.ar">
            <input type="password" id="r_pass" placeholder="Contrase√±a">
            <button class="btn" style="background:var(--green); width:100%;" onclick="app.register()">Registrarme</button>
            <p style="text-align:center; font-size:12px; cursor:pointer" onclick="app.toggleAuth()">Volver</p>
        </div>
    </div>

    <div id="main-section" class="oculto">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center">
                <div>
                    <h2 id="user-name" style="margin:0">Hola</h2>
                    <span id="user-rol" style="font-size:12px; color:var(--sky); font-weight:bold; text-transform:uppercase"></span>
                </div>
                <button class="btn" style="background:var(--red); font-size:11px;" onclick="app.logout()">Cerrar Sesi√≥n</button>
            </div>

            <div id="semaforo-container">
                <div style="display:flex; justify-content:space-between; margin-top:15px; font-size:13px;">
                    <span>Estado mensual de Horas Extras:</span>
                    <b id="hs-count">0 / 30hs</b>
                </div>
                <div class="semaforo-bar"><div id="bar" class="progress"></div></div>
            </div>

            <div class="nav-tabs" style="margin-top:20px;">
                <button class="tab-btn active" onclick="app.tab(event, 'carga')">Cargar Horas</button>
                <button class="tab-btn" onclick="app.tab(event, 'mis-datos')">Mis Registros</button>
                <button id="admin-btn" class="tab-btn oculto" style="color:var(--orange)" onclick="app.tab(event, 'admin')">Panel Jefe ‚òÖ</button>
            </div>

            <div id="tab-carga" class="tab-content active">
                <div class="grid" style="margin-top:15px;">
                    <div>
                        <label>Fecha:</label>
                        <div style="display:flex; gap:5px;">
                            <input type="date" id="c_fecha">
                            <button class="btn" style="background:var(--sky); padding:5px 10px;" onclick="app.setToday()">Hoy</button>
                        </div>
                    </div>
                    <div>
                        <label>Horas:</label>
                        <input type="number" id="c_hs" step="0.5" placeholder="Ej: 3">
                    </div>
                    <div>
                        <label>Compensaci√≥n:</label>
                        <select id="c_tipo"><option value="50">50%</option><option value="100">100%</option></select>
                    </div>
                    <div class="full">
                        <label>Detalle de tarea:</label>
                        <input type="text" id="c_det" placeholder="¬øQu√© hiciste?">
                    </div>
                </div>
                <button class="btn" style="background:var(--orange); width:100%; margin-top:20px;" id="save-btn" onclick="app.save()">Guardar Jornada</button>
            </div>

            <div id="tab-mis-datos" class="tab-content">
                <div id="lista-user"></div>
            </div>

            <div id="tab-admin" class="tab-content">
                <div class="nav-tabs" style="border:none; background:#f9f9f9; padding:5px; border-radius:8px;">
                    <button class="tab-btn" onclick="app.subTab('auditoria')">Auditor√≠a</button>
                    <button class="tab-btn" onclick="app.subTab('usuarios')">Usuarios</button>
                    <button class="tab-btn" onclick="app.subTab('cierres')">Calendario Cierres</button>
                </div>

                <div id="sub-auditoria" class="sub-tab">
                    <input type="text" id="filtro-admin" placeholder="üîç Buscar por nombre..." onkeyup="app.filtrarAdmin()" style="margin:10px 0;">
                    <div id="lista-admin"></div>
                </div>

                <div id="sub-usuarios" class="sub-tab oculto">
                    <table style="margin-top:15px;">
                        <thead><tr><th>Nombre</th><th>Email</th><th>Rol</th><th>Acci√≥n</th></tr></thead>
                        <tbody id="tabla-usuarios"></tbody>
                    </table>
                </div>

                <div id="sub-cierres" class="sub-tab oculto">
                    <h4>Configurar D√≠as de Cierre Mensual</h4>
                    <div class="cierre-grid" id="cierre-grid-ui"></div>
                    <button class="btn" style="background:var(--navy); margin-top:15px;" onclick="app.saveCierres()">Guardar Calendario</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyEuihBYqH50gIeUYNnDN67Fri86-08comxpbkvpP3DCPeEV_JwgTJBZEiGwCtF8LUb/exec";
    const MESES = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];

    const app = {
        user: null, db: [], cierres: Array(12).fill(24),
        
        async login() {
            const m = document.getElementById('l_email').value.toLowerCase().trim();
            const p = document.getElementById('l_pass').value;
            if(m === "rodri@gmx.com" && p === "1234") {
                this.user = { n: "Rodrigo (Admin)", m, rol: "jefe" };
                return this.iniciar();
            }
            try {
                const res = await fetch(WEB_APP_URL);
                this.db = await res.json();
                this.cargarCierres();
                const u = this.db.find(r => r[0]==="USER" && r[2]===m && String(r[3])===p);
                if(u) {
                    this.user = { n: u[1], m: u[2], rol: u[4] };
                    this.iniciar();
                } else alert("Credenciales incorrectas");
            } catch(e) { alert("Error de base de datos"); }
        },

        iniciar() {
            localStorage.setItem('osde_session', JSON.stringify(this.user));
            document.getElementById('auth-section').classList.add('oculto');
            document.getElementById('main-section').classList.remove('oculto');
            document.getElementById('user-name').innerText = "Hola, " + this.user.n;
            document.getElementById('user-rol').innerText = this.user.rol;
            if(this.user.rol === "jefe") document.getElementById('admin-btn').classList.remove('oculto');
            this.render();
            this.renderCierresUI();
        },

        async save() {
            const f = document.getElementById('c_fecha').value;
            const h = parseFloat(document.getElementById('c_hs').value);
            const t = document.getElementById('c_tipo').value;
            const d = document.getElementById('c_det').value;
            if(!f || !h || !d) return alert("Completa todos los campos");

            const fechaObj = new Date(f + "T12:00:00");
            const mesIdx = fechaObj.getMonth();
            const diaCierre = this.cierres[mesIdx];
            
            // L√≥gica de Mes de Pertenencia
            let mesPertenencia = (fechaObj.getDate() > diaCierre) ? (mesIdx + 1) : mesIdx;
            if(mesPertenencia > 11) mesPertenencia = 0; // Salto de a√±o

            // Calcular acumulado
            const acumulado = this.getAcumulado(this.user.m, mesPertenencia);
            let hMesActual = h;
            let hExcedente = 0;

            if(acumulado + h > 30) {
                hMesActual = 30 - acumulado;
                hExcedente = h - hMesActual;
                alert(`Tope superado. Se cargan ${hMesActual}hs este mes y ${hExcedente}hs como EXCEDENTE al mes siguiente.`);
            }

            const btn = document.getElementById('save-btn');
            btn.innerText = "GUARDANDO..."; btn.disabled = true;

            // Carga 1
            if(hMesActual > 0) {
                await this.post({type:"carga", n:this.user.n, u:this.user.m, d, h:hMesActual, p:t, mes:mesPertenencia, tk:""});
            }
            // Carga 2 (Sobrante)
            if(hExcedente > 0) {
                let mesSiguiente = mesPertenencia + 1;
                if(mesSiguiente > 11) mesSiguiente = 0;
                await this.post({type:"carga", n:this.user.n, u:this.user.m, d: d + " (SOBRANTE)", h:hExcedente, p:t, mes:mesSiguiente, tk:""});
            }

            location.reload();
        },

        getAcumulado(m, mesIdx) {
            return this.db.filter(r => r[0]==="DATA" && r[2]===m && r[3]===mesIdx)
                          .reduce((sum, r) => sum + parseFloat(r[6]), 0);
        },

        render() {
            const mActual = new Date().getMonth();
            const total = this.getAcumulado(this.user.m, mActual);
            document.getElementById('hs-count').innerText = `${total} / 30hs`;
            const bar = document.getElementById('bar');
            const porc = (total / 30) * 100;
            bar.style.width = porc + "%";
            bar.className = "progress " + (total < 20 ? "verde" : total < 30 ? "naranja" : "rojo");

            this.renderLista('lista-user', this.user.m);
            if(this.user.rol === "jefe") {
                this.renderLista('lista-admin', null);
                this.renderUsuarios();
            }
        },

        renderLista(divId, emailFiltro) {
            const div = document.getElementById(divId);
            div.innerHTML = "";
            const data = this.db.filter(r => r[0]==="DATA" && (emailFiltro ? r[2]===emailFiltro : true));
            
            MESES.forEach((m, idx) => {
                const mesData = data.filter(r => r[3] == idx);
                if(mesData.length > 0) {
                    div.innerHTML += `<div class="mes-group">Horas de ${m}</div>`;
                    let html = `<table><thead><tr>${!emailFiltro?'<th>User</th>':''}<th>Fecha</th><th>Tarea</th><th>Hs</th></tr></thead><tbody>`;
                    mesData.forEach(r => {
                        html += `<tr>${!emailFiltro?`<td><b>${r[1]}</b></td>`:''}<td>${new Date(r[4]).toLocaleDateString()}</td><td>${r[5]}</td><td>${r[6]} hs (${r[7]}%)</td></tr>`;
                    });
                    div.innerHTML += html + `</tbody></table>`;
                }
            });
        },

        renderUsuarios() {
            const t = document.getElementById('tabla-usuarios');
            t.innerHTML = "";
            this.db.filter(r => r[0]==="USER").forEach(u => {
                t.innerHTML += `<tr>
                    <td>${u[1]}</td><td>${u[2]}</td><td>${u[4]}</td>
                    <td>
                        <button onclick="app.setRol('${u[2]}','${u[4]=='jefe'?'usuario':'jefe'}')">Cambiar Rol</button>
                        <button style="color:red" onclick="app.deleteUser('${u[2]}')">Eliminar</button>
                    </td>
                </tr>`;
            });
        },

        async post(body) { return fetch(WEB_APP_URL, {method:'POST', mode:'no-cors', body:JSON.stringify(body)}); },
        setToday() { document.getElementById('c_fecha').valueAsDate = new Date(); },
        tab(e, id) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-' + id).classList.add('active');
            e.currentTarget.classList.add('active');
        },
        subTab(id) {
            document.querySelectorAll('.sub-tab').forEach(c => c.classList.add('oculto'));
            document.getElementById('sub-' + id).classList.remove('oculto');
        },
        toggleAuth() {
            document.getElementById('login-form').classList.toggle('oculto');
            document.getElementById('reg-form').classList.toggle('oculto');
        },
        cargarCierres() {
            this.db.filter(r => r[0]==="CIERRE").forEach(c => { this.cierres[c[1]] = c[2]; });
        },
        renderCierresUI() {
            const grid = document.getElementById('cierre-grid-ui');
            grid.innerHTML = "";
            this.cierres.forEach((dia, i) => {
                grid.innerHTML += `<div class="cierre-box"><span>${MESES[i].substring(0,3)}</span><input type="number" class="dia-val" data-idx="${i}" value="${dia}"></div>`;
            });
        },
        async saveCierres() {
            const inputs = document.querySelectorAll('.dia-val');
            for(let i=0; i<inputs.length; i++) {
                await this.post({type:"cierre", mes:i, dia:inputs[i].value});
            }
            alert("Calendario actualizado"); location.reload();
        },
        async setRol(m, newRol) { await this.post({type:"rol", m, newRol}); location.reload(); },
        async deleteUser(m) { if(confirm("¬øBorrar usuario y todas sus horas?")) { await this.post({type:"delete_user", m}); location.reload(); }},
        logout() { localStorage.clear(); location.reload(); }
    };

    // Auto-login
    const session = localStorage.getItem('osde_session');
    if(session) { 
        app.user = JSON.parse(session);
        fetch(WEB_APP_URL).then(res => res.json()).then(data => { app.db = data; app.cargarCierres(); app.iniciar(); });
    }
</script>
</body>
</html>
