<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>OSDE - Control Horas Extras</title>
    <style>
        /* ESTILOS VISUALES */
        :root { --osde: #00548f; --rojo: #d9534f; --verde: #5cb85c; }
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f9; padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 12px; max-width: 700px; margin: auto; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        /* SEM√ÅFORO: Cambia de color seg√∫n las horas */
        .semaforo { padding: 15px; border-radius: 8px; color: white; font-weight: bold; text-align: center; margin-bottom: 20px; transition: 0.3s; }
        .verde { background: var(--verde); }
        .rojo { background: var(--rojo); }

        /* GRILLA PARA EL FORMULARIO */
        .grid-form { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        input, select, textarea, button { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        
        button { background: var(--osde); color: white; border: none; font-weight: bold; cursor: pointer; }
        .hidden { display: none; } /* Para ocultar secciones */
        
        .audit-item { background: #f9fcff; border-left: 5px solid var(--osde); padding: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>

    <div class="card" id="login-box">
        <h2 style="color:var(--osde)">Ingreso Seguro</h2>
        <input type="email" id="email" placeholder="Email @osde.com.ar o @gmx.com">
        <input type="password" id="pass" placeholder="Tu Contrase√±a">
        <button onclick="ejecutarLogin()">INGRESAR</button>
    </div>

    <div class="card hidden" id="panel-principal">
        <h2 id="saludo">Hola!</h2>
        
        <div id="status-hs" class="semaforo verde">Cargando horas del mes...</div>

        <div id="zona-carga">
            <div class="grid-form">
                <div><label>Fecha:</label><input type="date" id="fecha-hs"></div>
                <div><label>Ticket ID:</label><input type="text" id="tk-hs" placeholder="Ej: 99882"></div>
                <div><label>Desde:</label><input type="time" id="hora-ini"></div>
                <div><label>Hasta:</label><input type="time" id="hora-fin"></div>
                <div><label>Cant. Horas:</label><input type="number" id="cant-hs" placeholder="Ej: 2"></div>
                <div><label>Tipo:</label>
                    <select id="tipo-hs">
                        <option value="50%">50%</option>
                        <option value="100%">100%</option>
                    </select>
                </div>
            </div>
            <select id="mes-hs">
                <option value="Enero">Enero 2026</option>
                <option value="Febrero">Febrero 2026</option>
                <option value="Marzo">Marzo 2026</option>
            </select>
            <textarea id="sug-hs" maxlength="300" placeholder="Sugerencias (m√°x 50 palabras)..."></textarea>
            <button onclick="enviarRegistro()">CARGAR HORAS</button>
        </div>

        <h3 style="margin-top:30px; color:var(--osde)">Listado de Registros</h3>
        <div id="lista-auditoria"></div>
    </div>

    <script>
        const URL_API = "https://script.google.com/macros/s/AKfycbysAlWcMMTkvlT8rH0h7z6S5bdOtS72nmtuhaxvXq7nCifXILEg7SZdzNP4UGxUMd4w/exec"; // <-- REEMPLAZAR AQU√ç
        let miEmail = ""; let miNombre = ""; let miRol = "";

        // FUNCI√ìN: LOGIN CON CLAVE
        async function ejecutarLogin() {
            const u = document.getElementById('email').value.trim();
            const p = document.getElementById('pass').value;

            // Petici√≥n al servidor para validar usuario y contrase√±a
            const res = await fetch(URL_API, { method: 'POST', body: JSON.stringify({type: "login", u, p}) });
            const data = await res.json();

            if (data.status === "OK") {
                miEmail = u; miRol = data.rol;
                miNombre = u.split('@')[0].toUpperCase();
                
                // Cambiar de vista
                document.getElementById('login-box').classList.add('hidden');
                document.getElementById('panel-principal').classList.remove('hidden');
                document.getElementById('saludo').innerText = `Bienvenido, ${miNombre} (${miRol})`;
                
                // Poner la fecha de hoy autom√°ticamente
                document.getElementById('fecha-hs').valueAsDate = new Date();
                
                actualizarPanel(); // Carga la lista de horas
            } else {
                alert("Acceso Incorrecto. Verifica Email y Clave.");
            }
        }

        // FUNCI√ìN: CARGAR HORAS
        async function enviarRegistro() {
            const hs = document.getElementById('cant-hs').value;
            if(!hs) return alert("Ingresa la cantidad de horas");

            const payload = {
                type: "carga",
                n: miNombre, u: miEmail,
                fecha: document.getElementById('fecha-hs').value,
                tk: document.getElementById('tk-hs').value,
                desde: document.getElementById('hora-ini').value,
                hasta: document.getElementById('hora-fin').value,
                h: hs,
                tipo: document.getElementById('tipo-hs').value,
                mes: document.getElementById('mes-hs').value,
                sug: document.getElementById('sug-hs').value
            };

            await fetch(URL_API, { method: 'POST', body: JSON.stringify(payload) });
            alert("Registro guardado correctamente");
            actualizarPanel();
        }

        // FUNCI√ìN: ACTUALIZAR LISTA Y SEM√ÅFORO
        async function actualizarPanel() {
            const res = await fetch(URL_API + "?action=read");
            const registros = await res.json();
            
            const lista = document.getElementById('lista-auditoria');
            const semaforo = document.getElementById('status-hs');
            lista.innerHTML = "";
            
            let totalMensual = 0;
            const mesActual = document.getElementById('mes-hs').value;

            registros.forEach(r => {
                if (r[0] === "DATA") {
                    const [tag, nom, email, mes, fecha, tk, ini, fin, horas, tipo] = r;

                    // REGLA DE VISIBILIDAD: Admin ve todo, User solo lo suyo
                    if (miRol === "ADMIN" || email === miEmail) {
                        
                        // Si es el mes seleccionado, sumamos para el sem√°foro
                        if (mes === mesActual) totalMensual += parseFloat(horas);

                        // Crear elemento visual en la lista
                        lista.innerHTML += `
                            <div class="audit-item">
                                <div>
                                    <strong>${nom}</strong> (${mes})<br>
                                    <small>${fecha} | TK: ${tk} | ${horas}hs (${tipo})</small>
                                </div>
                                ${miRol === "ADMIN" ? `<button style="width:auto; background:red" onclick="borrarRegistro('${email}','${tk}')">üóëÔ∏è</button>` : ''}
                            </div>`;
                    }
                }
            });

            // L√ìGICA DEL SEM√ÅFORO (Tope 30hs)
            semaforo.innerText = `Total Horas ${mesActual}: ${totalMensual}hs`;
            if (totalMensual > 30) {
                semaforo.className = "semaforo rojo";
                semaforo.innerText += " - ¬°L√çMITE EXCEDIDO!";
            } else {
                semaforo.className = "semaforo verde";
                semaforo.innerText += " - Dentro del l√≠mite permitido";
            }
        }

        // FUNCI√ìN: BORRAR (Solo para el Admin)
        async function borrarRegistro(u, tk) {
            if(!confirm("¬øConfirmas borrar este registro?")) return;
            await fetch(URL_API, { method: 'POST', body: JSON.stringify({type: "borrar_registro", u: u, tk: tk}) });
            actualizarPanel();
        }
    </script>
</body>
</html>
