<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Horas Extras</title>
<style>
body { font-family: Arial; max-width: 800px; margin: auto; }
input, select, textarea, button { width: 100%; margin: 5px 0; }
.hidden { display: none; }
.ok { color: green; }
.err { color: red; }
</style>
</head>

<body>

<h2>Login</h2>

<input id="email" placeholder="email">
<input id="clave" type="password" placeholder="clave">

<button onclick="login()">Entrar</button>
<button onclick="registrar()">Registrarse</button>

<p id="msg"></p>

<hr>

<div id="app" class="hidden">
  <h3>Cargar horas</h3>

  <input type="date" id="fecha">
  <input type="time" id="desde">
  <input type="time" id="hasta">

  <select id="porcentaje">
    <option value="50%">50%</option>
    <option value="100%">100%</option>
  </select>

  <input id="tk" placeholder="TK / ID">
  <textarea id="sugerencia" maxlength="50"></textarea>

  <button onclick="guardar()">Guardar</button>

  <h3>Mis horas</h3>
  <div id="tabla"></div>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbyx12wVbgiRP1hQTkDNDY0SJwZF2JJnORaBT653QpzbUFpZVzOhH7lFZyRy4DBJzgDrog/exec";
let EMAIL = "";

function login() {
  fetch(`${API}?action=login&email=${email.value}&clave=${clave.value}`)
    .then(r => r.json())
    .then(d => {
      if (!d.ok) {
        msg.innerHTML = `<span class="err">${d.error}</span>`;
        return;
      }
      EMAIL = d.email;
      app.classList.remove("hidden");
      msg.innerHTML = `<span class="ok">Login OK (${d.rol})</span>`;
      listar();
    });
}

function registrar() {
  fetch(`${API}?action=register&email=${email.value}&clave=${clave.value}`)
    .then(r => r.json())
    .then(d => {
      msg.innerHTML = d.ok
        ? `<span class="ok">Registrado</span>`
        : `<span class="err">${d.error}</span>`;
    });
}

function guardar() {
  const horas =
    (new Date(`1970-01-01T${hasta.value}`) -
     new Date(`1970-01-01T${desde.value}`)) / 3600000;

  fetch(`${API}?action=cargarHoras&email=${EMAIL}&fecha=${fecha.value}&desde=${desde.value}&hasta=${hasta.value}&horas=${horas}&porcentaje=${porcentaje.value}&sugerencia=${sugerencia.value}&tk=${tk.value}`)
    .then(r => r.json())
    .then(() => listar());
}

function listar() {
  fetch(`${API}?action=listar&email=${EMAIL}`)
    .then(r => r.json())
    .then(data => {
      let html = "<table border=1><tr><th>Fecha</th><th>Horas</th><th>%</th><th>Mes</th></tr>";
      data.forEach(r => {
        html += `<tr><td>${r[3]}</td><td>${r[6]}</td><td>${r[7]}</td><td>${r[9]}</td></tr>`;
      });
      tabla.innerHTML = html + "</table>";
    });
}
</script>

</body>
</html>
