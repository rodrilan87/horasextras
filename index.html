<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSDE - Control de Horas Pro</title>
    <style>
        :root { --osde: #00548f; --rojo: #d9534f; --verde: #5cb85c; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f0f4f7; padding: 20px; }
        .container { max-width: 800px; margin: auto; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        /* Sem√°foro */
        .semaforo { padding: 15px; border-radius: 10px; color: white; font-weight: bold; text-align: center; margin-bottom: 20px; font-size: 1.2em; }
        .verde { background: var(--verde); }
        .rojo { background: var(--rojo); }

        /* Formulario */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        input, select, textarea, button { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 14px; box-sizing: border-box; }
        button { background: var(--osde); color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:hover { opacity: 0.8; }
        
        /* Auditor√≠a */
        .registro-card { border-left: 6px solid var(--osde); background: #f9fcff; padding: 15px; margin-bottom: 10px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }
        .hidden { display: none; }
        label { font-size: 12px; font-weight: bold; color: var(--osde); }
    </style>
</head>
<body>

<div class="container">
    <div class="card" id="view-login">
        <h2 style="color:var(--osde); text-align:center;">Acceso Seguro OSDE</h2>
        <input type="email" id="log-u" placeholder="Email (@osde.com.ar / @gmx.com)">
        <input type="password" id="log-p" placeholder="Contrase√±a">
        <button onclick="login()">INGRESAR AL SISTEMA</button>
    </div>

    <div class="card hidden" id="view-panel">
        <h2 id="txt-user">Bienvenido</h2>
        
        <div id="status-semaforo" class="semaforo verde">Calculando horas mensuales...</div>

        <div id="form-carga">
            <div class="grid">
                <div><label>Fecha del trabajo</label><input type="date" id="f-fecha"></div>
                <div><label>Ticket ID</label><input type="text" id="f-tk" placeholder="Ej: 10293"></div>
                <div><label>Desde</label><input type="time" id="f-ini"></div>
                <div><label>Hasta</label><input type="time" id="f-fin"></div>
                <div><label>Horas Totales</label><input type="number" id="f-hs" step="0.5" placeholder="Ej: 2.5"></div>
                <div><label>Tipo de Recargo</label>
                    <select id="f-tipo">
                        <option value="100%">Recargo 100%</option>
                        <option value="50%">Recargo 50%</option>
                    </select>
                </div>
            </div>
            <label>Mes de Imputaci√≥n</label>
            <select id="f-mes">
                <option value="Enero">Enero 2026</option>
                <option value="Febrero">Febrero 2026</option>
                <option value="Marzo">Marzo 2026</option>
            </select>
            <textarea id="f-sug" maxlength="250" placeholder="Sugerencias o comentarios (m√°x 50 palabras)"></textarea>
            <button onclick="enviarRegistro()">GUARDAR CARGA</button>
        </div>

        <hr style="margin: 30px 0; border: 0; border-top: 1px solid #eee;">

        <div id="admin-tools" class="hidden" style="background:#fff3cd; padding:15px; border-radius:10px; border: 1px solid #ffeeba;">
            <h3 style="margin:0 0 10px 0;">Panel de Control Admin</h3>
            <div style="display:flex; gap:10px;">
                <button onclick="setEstado('BLOQUEADO')" style="background:#856404;">Bloquear Sitio</button>
                <button onclick="setEstado('ACTIVO')" style="background:#155724;">Activar Sitio</button>
            </div>
        </div>

        <h3>Mis Registros / Auditor√≠a</h3>
        <div id="lista-auditoria"></div>
    </div>
</div>

<script>
    const API = "https://script.google.com/macros/s/AKfycbwlUwUYZy2f-WxcdVL3VZkR0uCU_9TK9GNmvp2RVRHxf731Lu6Wo3dGrKEyqy4Bp6u6/exec"; // REEMPLAZAR CON LA URL DE GOOGLE APPS SCRIPT
    let uEmail = "", uNombre = "", uRol = "";

    // 1. LOGIN CON RESPUESTA REAL
    async function login() {
        const u = document.getElementById('log-u').value.trim();
        const p = document.getElementById('log-p').value.trim();
        if(!u || !p) return alert("Completa los datos");

        try {
            const res = await fetch(`${API}?action=login&u=${encodeURIComponent(u)}&p=${encodeURIComponent(p)}`);
            const data = await res.json();

            if (data.status === "OK") {
                uEmail = u; uRol = data.rol;
                uNombre = u.split('@')[0].toUpperCase();
                
                document.getElementById('view-login').className = "hidden";
                document.getElementById('view-panel').className = "card";
                document.getElementById('txt-user').innerText = `Panel: ${uNombre}`;
                document.getElementById('f-fecha').valueAsDate = new Date();

                if(uRol === "ADMIN") document.getElementById('admin-tools').className = "";
                
                cargarDatos();
            } else { alert("Credenciales incorrectas"); }
        } catch(e) { alert("Error de conexi√≥n con el script."); }
    }

    // 2. ENVIAR CARGA
    async function enviarRegistro() {
        const payload = {
            type: "carga", n: uNombre, u: uEmail,
            fecha: document.getElementById('f-fecha').value,
            tk: document.getElementById('f-tk').value,
            desde: document.getElementById('f-ini').value,
            hasta: document.getElementById('f-fin').value,
            h: document.getElementById('f-hs').value,
            tipo: document.getElementById('f-tipo').value,
            mes: document.getElementById('f-mes').value,
            sug: document.getElementById('f-sug').value
        };
        await fetch(API, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
        alert("¬°Registro enviado!");
        cargarDatos();
    }

    // 3. ACTUALIZAR LISTA Y SEM√ÅFORO
    async function cargarDatos() {
        const res = await fetch(`${API}?action=read`);
        const registros = await res.json();
        const lista = document.getElementById('lista-auditoria');
        const semaforo = document.getElementById('status-semaforo');
        const mesFiltro = document.getElementById('f-mes').value;
        
        lista.innerHTML = "";
        let sumaHoras = 0;

        registros.forEach(r => {
            if (r[0] === "DATA") {
                const [tag, nom, email, mes, fecha, tk, ini, fin, hs, tipo, sug] = r;

                // Solo ve lo suyo, o el Admin ve todo
                if (uRol === "ADMIN" || email === uEmail) {
                    if (mes === mesFiltro) sumaHoras += parseFloat(hs);

                    lista.innerHTML += `
                        <div class="registro-card">
                            <div>
                                <strong>${nom}</strong> <span style="font-size:10px;">(${mes})</span><br>
                                <small>${fecha} | TK: ${tk} | ${hs}hs (${tipo})</small><br>
                                <em style="font-size:11px; color:#777;">${sug || ''}</em>
                            </div>
                            ${uRol === "ADMIN" ? `<button style="width:auto; padding:5px 10px; background:red;" onclick="borrar('${email}','${tk}')">üóëÔ∏è</button>` : ''}
                        </div>`;
                }
            }
        });

        semaforo.innerText = `Horas en ${mesFiltro}: ${sumaHoras}hs`;
        semaforo.className = sumaHoras > 30 ? "semaforo rojo" : "semaforo verde";
    }

    async function borrar(u, tk) {
        if(!confirm("¬øBorrar?")) return;
        await fetch(API, { method: 'POST', mode: 'no-cors', body: JSON.stringify({type:"borrar_registro", u:u, tk:tk}) });
        cargarDatos();
    }

    async function setEstado(est) {
        await fetch(API, { method: 'POST', mode: 'no-cors', body: JSON.stringify({type:"toggle_sitio", estado:est}) });
        alert("Sitio: " + est);
    }
</script>

</body>
</html>
