<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA GESTI칍N OSDE v30.5</title>
    
    <style>
        /* --- ESTILOS VISUALES (CSS) --- */
        :root { 
            --navy: #003057; --sky: #0076BE; --orange: #E87722; 
            --green: #27ae60; --red: #dc3545; --gray: #f4f4f4; 
        }

        body { font-family: 'Segoe UI', sans-serif; background: #dfe4ea; margin: 0; padding: 10px; }
        .container { max-width: 1000px; margin: auto; }
        
        /* Estilo de tarjetas blancas */
        .card { 
            background: white; border-radius: 12px; padding: 25px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin-bottom: 20px; 
            border-top: 8px solid var(--navy); 
        }

        /* Sem치foro de Horas */
        .semaforo-box { background: #fff; padding: 15px; border-radius: 10px; border: 1px solid #ddd; margin: 15px 0; }
        .bar-bg { background: #eee; height: 15px; border-radius: 10px; overflow: hidden; margin-top: 10px; }
        .bar-fill { height: 100%; transition: 0.8s; width: 0%; } /* Animaci칩n de la barra */
        .verde { background: var(--green); }
        .naranja { background: var(--orange); }
        .rojo { background: var(--red); }

        /* Estilos de tablas de registros */
        .mes-label { background: var(--navy); color: white; padding: 8px 15px; border-radius: 5px; margin-top: 20px; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; font-size: 13px; }
        th { background: #f8f9fa; padding: 12px; text-align: left; border-bottom: 2px solid #ddd; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        
        /* Sistema de pesta침as (Tabs) */
        .tab-nav { display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 2px solid #ddd; }
        .tab-btn { padding: 10px 20px; border: none; background: none; cursor: pointer; font-weight: bold; color: #666; }
        .tab-btn.active { color: var(--sky); border-bottom: 3px solid var(--sky); }

        /* Helpers */
        .oculto { display: none !important; }
        input, select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .btn { padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; text-transform: uppercase; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
    </style>
</head>
<body>

<div class="container">
    <div id="auth-section" class="card" style="max-width: 400px; margin: 50px auto;">
        <h2 style="text-align:center; color:var(--navy)">OSDE <span style="color:var(--sky)">PORTAL</span></h2>
        <div id="login-form">
            <input type="email" id="l_email" placeholder="usuario@osde.com.ar">
            <input type="password" id="l_pass" placeholder="Contrase침a">
            <button class="btn" style="background:var(--navy); width:100%; margin-top:10px;" onclick="app.login()">Entrar</button>
            <p onclick="app.toggleAuth()" style="text-align:center; font-size:12px; color:var(--sky); cursor:pointer; margin-top:15px;">Registrar cuenta @osde.com.ar</p>
        </div>
        <div id="reg-form" class="oculto">
            <input type="text" id="r_name" placeholder="Nombre completo">
            <input type="email" id="r_email" placeholder="Email @osde.com.ar">
            <input type="password" id="r_pass" placeholder="Contrase침a">
            <button class="btn" style="background:var(--green); width:100%;" onclick="app.register()">Crear Cuenta</button>
            <p onclick="app.toggleAuth()" style="text-align:center; font-size:12px; cursor:pointer; margin-top:15px;">Volver al login</p>
        </div>
    </div>

    <div id="user-section" class="oculto">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center">
                <h2 id="u-saludo" style="margin:0"></h2>
                <button class="btn" style="background:var(--red); padding:5px 15px; font-size:11px;" onclick="app.logout()">SALIR</button>
            </div>

            <div class="semaforo-box">
                <div style="display:flex; justify-content:space-between; font-size:14px;">
                    <span>Horas consumidas este mes:</span>
                    <b id="hs-txt">0 / 30hs</b>
                </div>
                <div class="bar-bg"><div id="hs-bar" class="bar-fill"></div></div>
            </div>

            <h3>Nueva Jornada</h3>
            <div class="grid">
                <div>
                    <label>Fecha:</label>
                    <div style="display:flex; gap:5px;">
                        <input type="date" id="c_fecha">
                        <button class="btn" style="background:var(--sky); padding:5px 10px;" onclick="app.setToday()">HOY</button>
                    </div>
                </div>
                <div><label>Horas:</label><input type="number" id="c_hs" step="0.5"></div>
                <div><label>Tipo:</label><select id="c_tipo"><option value="50">50%</option><option value="100">100%</option></select></div>
                <div style="grid-column: span 2;"><label>Tarea:</label><input type="text" id="c_det" placeholder="Descripci칩n"></div>
            </div>
            <button class="btn" style="background:var(--orange); width:100%; margin-top:20px;" id="btn-save" onclick="app.save()">Guardar Jornada</button>

            <h3 style="margin-top:40px;">Mi Historial</h3>
            <div id="user-history"></div>
        </div>
    </div>

    <div id="admin-section" class="oculto">
        <div class="card" style="border-top-color: var(--orange);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="margin:0; color:var(--orange)">PANEL JEFE</h2>
                <button class="btn" style="background:var(--red); padding:5px 15px; font-size:11px;" onclick="app.logout()">SALIR</button>
            </div>

            <div class="tab-nav">
                <button class="tab-btn active" onclick="app.tab(event, 'auditoria')">AUDITOR칈A</button>
                <button class="tab-btn" onclick="app.tab(event, 'usuarios')">USUARIOS</button>
                <button class="tab-btn" onclick="app.tab(event, 'cierres')">CIERRES</button>
            </div>

            <div id="tab-auditoria" class="admin-content">
                <input type="text" id="f-admin" placeholder="游댌 Buscar colaborador..." onkeyup="app.filterAdmin()">
                <div id="admin-history"></div>
            </div>

            <div id="tab-usuarios" class="admin-content oculto">
                <table>
                    <thead><tr><th>Nombre</th><th>Email</th><th>Rol</th><th>Acciones</th></tr></thead>
                    <tbody id="u-body"></tbody>
                </table>
            </div>

            <div id="tab-cierres" class="admin-content oculto">
                <h4>Configuraci칩n de Cierre Mensual</h4>
                <div class="grid" id="cierres-ui"></div>
                <button class="btn" style="background:var(--navy); margin-top:20px;" onclick="app.saveCierres()">Actualizar Calendario</button>
            </div>
        </div>
    </div>
</div>

<script>
    /* --- L칍GICA DE PROGRAMACI칍N (JAVASCRIPT) --- */
    
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxARQBTrOA561DEjv-LIEjTA_0Uusc6luTTGVXq2k30z2hUkeGCwHnqRyxLFfiZpGgA/exec";
    const MESES = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];

    const app = {
        user: null, // Almacena el usuario logueado
        db: [],     // Copia de los datos de la planilla
        cierres: Array(12).fill(24), // D칤as de cierre por defecto

        // Funci칩n para validar email y contrase침a
        async login() {
            const m = document.getElementById('l_email').value.toLowerCase().trim();
            const p = document.getElementById('l_pass').value;

            // Bypass para el Administrador Principal
            if(m === "rodri@gmx.com" && p === "1234") {
                this.user = { n: "Rodrigo (Admin)", m, rol: "jefe" };
                return this.iniciar();
            }

            try {
                const res = await fetch(WEB_APP_URL);
                this.db = await res.json();
                const u = this.db.find(r => r[0]==="USER" && r[2]===m && String(r[3])===p);
                if(u) {
                    this.user = { n: u[1], m: u[2], rol: u[4] };
                    this.iniciar();
                } else alert("Credenciales inv치lidas");
            } catch(e) { alert("Error de conexi칩n con la base de datos."); }
        },

        // Arranca la interfaz seg칰n el rol
        async iniciar() {
            if(this.db.length === 0) {
                const res = await fetch(WEB_APP_URL);
                this.db = await res.json();
            }
            // Cargar los d칤as de cierre desde la planilla
            this.db.filter(r => r[0]==="CIERRE").forEach(c => this.cierres[c[1]] = c[2]);
            
            localStorage.setItem('osde_session', JSON.stringify(this.user)); // Guarda sesi칩n
            document.getElementById('auth-section').classList.add('oculto');

            if(this.user.rol === "jefe") {
                document.getElementById('admin-section').classList.remove('oculto');
                this.renderAdmin();
            } else {
                document.getElementById('user-section').classList.remove('oculto');
                document.getElementById('u-saludo').innerText = "Bienvenido, " + this.user.n;
                this.renderUser();
            }
        },

        // Guarda la jornada y maneja los TOPES de 30hs
        async save() {
            const f = document.getElementById('c_fecha').value;
            const h = parseFloat(document.getElementById('c_hs').value);
            const t = document.getElementById('c_tipo').value;
            const d = document.getElementById('c_det').value;
            if(!f || isNaN(h) || !d) return alert("Completa todos los datos");

            const fObj = new Date(f + "T12:00:00");
            const mesActReal = new Date().getMonth();
            
            // Seguridad: No permitir meses futuros
            if(fObj.getMonth() > mesActReal) return alert("No puedes cargar meses futuros.");

            // L칩gica de Cierre: Si la fecha es mayor al d칤a de cierre, pasa al mes siguiente
            const dCierre = this.cierres[fObj.getMonth()];
            let mesPertenencia = (fObj.getDate() > dCierre) ? (fObj.getMonth() + 1) : fObj.getMonth();
            if(mesPertenencia > 11) mesPertenencia = 0;

            // Calcular cu치nto lleva cargado en ese mes de pertenencia
            const totalCargado = this.db.filter(r => r[0]==="DATA" && r[2]===this.user.m && r[3]===mesPertenencia)
                                         .reduce((s,r) => s + parseFloat(r[6]), 0);
            
            let hHoy = h, hSobrante = 0;
            if(totalCargado + h > 30) {
                hHoy = 30 - totalCargado;
                hSobrante = h - hHoy;
                alert(`춰Tope alcanzado! ${hHoy}hs van a este mes y ${hSobrante}hs al mes siguiente.`);
            }

            document.getElementById('btn-save').innerText = "GUARDANDO...";
            // Guardar registro principal
            if(hHoy > 0) await this.post({type:"carga", n:this.user.n, u:this.user.m, d, h:hHoy, p:t, mes:mesPertenencia});
            // Guardar excedente si existe
            if(hSobrante > 0) {
                let mSig = mesPertenencia + 1; if(mSig > 11) mSig = 0;
                await this.post({type:"carga", n:this.user.n, u:this.user.m, d: d + " (SOBRANTE)", h:hSobrante, p:t, mes:mSig});
            }
            location.reload();
        },

        // Dibuja el sem치foro y la tabla del usuario
        renderUser() {
            const mesActual = new Date().getMonth();
            const total = this.db.filter(r => r[0]==="DATA" && r[2]===this.user.m && r[3]===mesActual)
                                 .reduce((s,r) => s + parseFloat(r[6]), 0);
            
            document.getElementById('hs-txt').innerText = `${total} / 30hs`;
            const bar = document.getElementById('hs-bar');
            bar.style.width = (total/30*100) + "%";
            bar.className = "bar-fill " + (total < 20 ? 'verde' : total < 30 ? 'naranja' : 'rojo');
            
            this.drawTable('user-history', this.user.m);
        },

        // Dibuja el panel de control del Jefe
        renderAdmin() {
            this.drawTable('admin-history', null);
            // Lista de usuarios para gesti칩n
            const tbody = document.getElementById('u-body'); tbody.innerHTML = "";
            this.db.filter(r => r[0]==="USER").forEach(u => {
                tbody.innerHTML += `<tr><td>${u[1]}</td><td>${u[2]}</td><td><b>${u[4]}</b></td>
                <td><button onclick="app.setRol('${u[2]}','${u[4]=='jefe'?'usuario':'jefe'}')">Cambiar Rol</button>
                <button style="color:red; margin-left:5px;" onclick="app.delUser('${u[2]}')">Borrar</button></td></tr>`;
            });
            // Cuadraditos de configuraci칩n de cierres
            const gui = document.getElementById('cierres-ui'); gui.innerHTML = "";
            this.cierres.forEach((d, i) => {
                gui.innerHTML += `<div style="text-align:center; background:#eee; padding:10px; border-radius:8px;">
                    <small>${MESES[i]}</small><input type="number" class="c-val" data-idx="${i}" value="${d}">
                </div>`;
            });
        },

        // Genera las tablas de registros agrupadas por mes
        drawTable(divId, email) {
            const div = document.getElementById(divId); div.innerHTML = "";
            const logs = this.db.filter(r => r[0]==="DATA" && (email ? r[2]===email : true));
            MESES.forEach((m, i) => {
                const filtrados = logs.filter(r => r[3] == i);
                if(filtrados.length > 0) {
                    div.innerHTML += `<div class="mes-label">Horas de ${m}</div>`;
                    let h = `<table><thead><tr>${!email?'<th>Colaborador</th>':''}<th>Fecha</th><th>Tarea</th><th>Horas</th></tr></thead><tbody>`;
                    filtrados.forEach(r => {
                        h += `<tr>${!email?`<td><b>${r[1]}</b></td>`:''}<td>${new Date(r[4]).toLocaleDateString()}</td><td>${r[5]}</td><td>${r[6]} hs (${r[7]}%)</td></tr>`;
                    });
                    div.innerHTML += h + "</tbody></table>";
                }
            });
        },

        /* --- UTILIDADES --- */
        async post(b) { return fetch(WEB_APP_URL, {method:'POST', mode:'no-cors', body:JSON.stringify(b)}); },
        async setRol(m, newRol) { await this.post({type:"rol", m, newRol}); location.reload(); },
        async delUser(m) { if(confirm("쮹orrar usuario definitivamente?")) { await this.post({type:"delete_user", m}); location.reload(); }},
        async saveCierres() { 
            const inputs = document.querySelectorAll('.c-val'); 
            for(let i=0; i<inputs.length; i++){ await this.post({type:"cierre", mes:i, dia:inputs[i].value}); } 
            alert("Calendario actualizado"); location.reload(); 
        },
        async register() {
            const n = document.getElementById('r_name').value;
            const m = document.getElementById('r_email').value.toLowerCase().trim();
            const p = document.getElementById('r_pass').value;
            if(!m.endsWith("@osde.com.ar")) return alert("Solo emails @osde.com.ar");
            await this.post({type:"registro", n, m, p});
            alert("Cuenta enviada. Inici치 sesi칩n."); this.toggleAuth();
        },
        setToday() { document.getElementById('c_fecha').valueAsDate = new Date(); },
        tab(e, id) {
            document.querySelectorAll('.admin-content').forEach(c => c.classList.add('oculto'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-' + id).classList.remove('oculto');
            e.currentTarget.classList.add('active');
        },
        filterAdmin() {
            const val = document.getElementById('f-admin').value.toLowerCase();
            document.querySelectorAll('#admin-history tr').forEach(tr => tr.style.display = tr.innerText.toLowerCase().includes(val) ? "" : "none");
        },
        toggleAuth() { document.getElementById('login-form').classList.toggle('oculto'); document.getElementById('reg-form').classList.toggle('oculto'); },
        logout() { localStorage.clear(); location.reload(); }
    };

    // Auto-login si ya existe sesi칩n
    const session = localStorage.getItem('osde_session');
    if(session) { app.user = JSON.parse(session); app.iniciar(); }
</script>
</body>
</html>
