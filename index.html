<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>OSDE - Gestión de Horas</title>
    <style>
        :root { --osde: #00548f; --rojo: #d9534f; --verde: #5cb85c; --fondo: #f0f4f7; }
        body { font-family: sans-serif; background: var(--fondo); padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 12px; max-width: 500px; margin: auto; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        input, select, textarea, button { width: 100%; padding: 12px; margin: 10px 0; border-radius: 6px; border: 1px solid #ccc; box-sizing: border-box; }
        button { background: var(--osde); color: white; font-weight: bold; cursor: pointer; border: none; }
        .semaforo { padding: 10px; border-radius: 6px; text-align: center; color: white; font-weight: bold; margin-bottom: 15px; }
        .verde { background: var(--verde); }
        .rojo { background: var(--rojo); }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="card" id="view-login">
        <h2 style="color:var(--osde); text-align:center;">Gestión OSDE 2026</h2>
        <div id="box-login">
            <input type="email" id="email" placeholder="Email (@osde.com.ar / @gmx.com)">
            <input type="password" id="pass" placeholder="Contraseña">
            <button onclick="login()">INGRESAR</button>
            <p style="text-align:center; font-size:14px">¿No tienes cuenta? <a href="#" onclick="toggle(true)">Regístrate</a></p>
        </div>
        <div id="box-reg" class="hidden">
            <input type="email" id="remail" placeholder="Tu Email">
            <input type="password" id="rpass" placeholder="Tu Contraseña">
            <button onclick="registrar()" style="background:var(--verde)">CREAR CUENTA</button>
            <p style="text-align:center; font-size:14px"><a href="#" onclick="toggle(false)">Volver al Login</a></p>
        </div>
    </div>

    <div class="card hidden" id="view-panel">
        <h3 id="txt-hola">Hola</h3>
        <div id="semaforo" class="semaforo verde">0 Horas acumuladas</div>
        <input type="date" id="f-fecha">
        <input type="text" id="f-tk" placeholder="Número de Ticket">
        <input type="number" id="f-hs" placeholder="Cantidad de Horas">
        <select id="f-mes" onchange="actualizar()">
            <option value="Enero">Enero 2026</option>
            <option value="Febrero">Febrero 2026</option>
        </select>
        <button onclick="enviar()">CARGAR REGISTRO</button>
        <div id="lista" style="margin-top:20px; font-size:14px; border-top:1px solid #eee;"></div>
    </div>

    <script>
        // PEGA AQUÍ TU URL DE GOOGLE (La que generaste recién)
        const API_URL = "https://script.google.com/macros/s/AKfycbyRZm4pnodorMsBKN47x5lIH-ZLSlQqxZZhea45Fgm4ndU1_5wR-uV7RdxOuCHiepdZ/exec"; 

        let userEmail = "", userRol = "";

        function toggle(show) {
            document.getElementById('box-login').className = show ? 'hidden' : '';
            document.getElementById('box-reg').className = show ? '' : 'hidden';
        }

        // --- CONEXIÓN JSONP (EVITA ERROR DE CONEXIÓN) ---
        function callAPI(params, callback) {
            const cbName = 'cb_' + Math.floor(Math.random() * 100000);
            window[cbName] = function(data) {
                callback(data);
                delete window[cbName];
                document.body.removeChild(script);
            };
            const script = document.createElement('script');
            script.src = `${API_URL}?callback=${cbName}&${params}`;
            document.body.appendChild(script);
        }

        function login() {
            const u = document.getElementById('email').value;
            const p = document.getElementById('pass').value;
            callAPI(`action=login&u=${u}&p=${p}`, (data) => {
                if(data.status === "OK") {
                    userEmail = u; userRol = data.rol;
                    document.getElementById('txt-hola').innerText = "Hola, " + u.split('@')[0].toUpperCase();
                    document.getElementById('view-login').classList.add('hidden');
                    document.getElementById('view-panel').classList.remove('hidden');
                    actualizar();
                } else { alert("Credenciales incorrectas"); }
            });
        }

        async function registrar() {
            const u = document.getElementById('remail').value.trim().toLowerCase();
            const p = document.getElementById('rpass').value;
            if(!u.endsWith("@osde.com.ar") && u !== "rodri@gmx.com") return alert("Email no permitido");
            
            await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({type: "registro_usuario", u: u, p: p}) });
            alert("Usuario creado. Intenta ingresar.");
            toggle(false);
        }

        async function enviar() {
            const payload = {
                type: "carga", u: userEmail, n: userEmail.split('@')[0],
                fecha: document.getElementById('f-fecha').value,
                tk: document.getElementById('f-tk').value,
                h: document.getElementById('f-hs').value,
                mes: document.getElementById('f-mes').value
            };
            await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
            alert("Carga realizada");
            actualizar();
        }

        function actualizar() {
            callAPI("action=read", (data) => {
                const lista = document.getElementById('lista');
                const sem = document.getElementById('semaforo');
                const mesSel = document.getElementById('f-mes').value;
                lista.innerHTML = "";
                let total = 0;

                data.forEach(r => {
                    if(r[0] === "DATA" && (userRol === "ADMIN" || r[2] === userEmail)) {
                        if(r[3] === mesSel) total += parseFloat(r[8]);
                        lista.innerHTML += `<div style="padding:5px; border-bottom:1px solid #eee;">${r[4]} | TK:${r[5]} | ${r[8]}hs</div>`;
                    }
                });
                sem.innerText = `${total} Horas acumuladas en ${mesSel}`;
                sem.className = total > 30 ? "semaforo rojo" : "semaforo verde";
            });
        }
    </script>
</body>
</html>
