<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSDE - Gesti√≥n de Horas Extras</title>
    <style>
        :root {
            --osde-blue: #00548f;
            --danger: #d9534f;
            --bg-gray: #f4f7f6;
        }

        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-gray); padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 700px; margin: auto; }
        h2, h3 { color: var(--osde-blue); margin-top: 0; }

        /* Formulario */
        input, select, button { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        button { background: var(--osde-blue); color: white; border: none; cursor: pointer; font-weight: bold; }
        button:hover { opacity: 0.9; }

        /* Badges Azules */
        .badge-area { display: flex; flex-wrap: wrap; gap: 8px; margin: 15px 0; }
        .badge-azul { 
            background: var(--osde-blue); color: white; padding: 6px 14px; 
            border-radius: 20px; font-size: 0.85em; font-weight: 500;
        }

        /* Auditor√≠a */
        .registro-row { 
            border-left: 5px solid var(--osde-blue); background: #f9fcff;
            padding: 12px; margin-bottom: 10px; border-radius: 4px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .info-emp strong { font-size: 1.1em; color: #222; }
        .info-emp small { color: #666; display: block; }
        .btn-del { background: none; color: var(--danger); width: auto; font-size: 1.2em; padding: 0 10px; }

        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="card" id="login-section">
        <h2>Ingreso OSDE</h2>
        <input type="email" id="email-user" placeholder="tu-email@osde.com.ar">
        <button onclick="intentarIngresar()">INGRESAR AL PANEL</button>
    </div>

    <div class="card hidden" id="main-section">
        <h2 id="txt-bienvenida"></h2>
        
        <div style="background: #f0f4f7; padding: 15px; border-radius: 8px;">
            <input type="text" id="tk-id" placeholder="N√∫mero de Ticket">
            <input type="number" id="hs-cant" placeholder="Cantidad de Horas">
            <select id="mes-sel">
                <option value="Enero">Enero 2026</option>
                <option value="Febrero">Febrero 2026</option>
                <option value="Marzo">Marzo 2026</option>
            </select>
            <button onclick="registrarHoras()">CARGAR REGISTRO</button>
        </div>

        <hr style="margin: 25px 0; border: 0; border-top: 1px solid #eee;">

        <h3>Auditor√≠a de Jefatura</h3>
        <div id="badges-container" class="badge-area"></div>
        <div id="lista-registros"></div>
    </div>

    <script>
        // CONFIGURACI√ìN: REEMPLAZA ESTA URL
        const MI_URL_APPSCRIPT = "https://script.google.com/macros/s/AKfycbzXHrhmpQabBjJAY-mGInniz9Hinuspvhf2jLh1ujZR0sp9eDZQWaF7CJWS2VtN-9JQ/exec"; 
        
        let sesionEmail = "";
        let sesionNombre = "";

        // 1. L√ìGICA DE LOGIN
        function intentarIngresar() {
            const correo = document.getElementById('email-user').value.toLowerCase().trim();
            
            if (correo.endsWith("@osde.com.ar") || correo === "rodri@gmx.com") {
                sesionEmail = correo;
                sesionNombre = correo.split('@')[0].toUpperCase();
                
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('main-section').classList.remove('hidden');
                document.getElementById('txt-bienvenida').innerText = "Hola, " + sesionNombre;
                
                obtenerDatosServidor();
            } else {
                alert("ERROR: El correo debe ser @osde.com.ar o rodri@gmx.com");
            }
        }

        // 2. CARGAR DATOS A LA PLANILLA
        async function registrarHoras() {
            const tk = document.getElementById('tk-id').value;
            const hs = document.getElementById('hs-cant').value;
            const mes = document.getElementById('mes-sel').value;

            if(!tk || !hs) return alert("Por favor, completa Ticket y Horas.");

            const payload = {
                type: "carga",
                n: sesionNombre,
                u: sesionEmail,
                mes: mes,
                tk: tk,
                h: hs,
                p: "100%"
            };

            await fetch(MI_URL_APPSCRIPT, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify(payload)
            });

            alert("Horas enviadas con √©xito.");
            location.reload();
        }

        // 3. LEER Y DIBUJAR AUDITOR√çA + BADGES
        async function obtenerDatosServidor() {
            try {
                const res = await fetch(MI_URL_APPSCRIPT);
                const filas = await res.json();
                
                const contenedor = document.getElementById('lista-registros');
                const badgeArea = document.getElementById('badges-container');
                contenedor.innerHTML = "";
                badgeArea.innerHTML = "";

                let totales = {}; // Para Badges

                filas.forEach(fila => {
                    if (fila[0] === "DATA") {
                        const [etiqueta, nombre, email, mes, fecha, ticket, horas] = fila;

                        // Acumular para Badge Azul
                        const key = nombre + " (" + mes + ")";
                        totales[key] = (totales[key] || 0) + parseFloat(horas);

                        // Crear Fila de Auditor√≠a
                        const div = document.createElement('div');
                        div.className = "registro-row";
                        div.innerHTML = `
                            <div class="info-emp">
                                <strong>${nombre}</strong>
                                <small>${email}</small>
                                <div style="font-size: 0.85em; margin-top: 4px;">
                                    üìÖ ${new Date(fecha).toLocaleDateString()} | üéüÔ∏è TK: ${ticket} | ‚è±Ô∏è ${horas}hs
                                </div>
                            </div>
                            <button class="btn-del" onclick="borrarRegistro('${email}', '${fecha}', '${horas}')">üóëÔ∏è</button>
                        `;
                        contenedor.appendChild(div);
                    }
                });

                // Crear Badges Azules
                for (let k in totales) {
                    const b = document.createElement('div');
                    b.className = "badge-azul";
                    b.innerText = "üîµ " + k + ": " + totales[k] + "hs totales";
                    badgeArea.appendChild(b);
                }

            } catch (error) {
                console.error("Error al cargar auditor√≠a:", error);
            }
        }

        // 4. BORRAR REGISTRO
        async function borrarRegistro(email, fecha, horas) {
            if(!confirm("¬øDeseas borrar este registro?")) return;

            const datosBorrado = {
                type: "borrar_registro",
                u: email,
                f: fecha,
                h: horas
            };

            await fetch(MI_URL_APPSCRIPT, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify(datosBorrado)
            });

            alert("Registro eliminado.");
            location.reload();
        }
    </script>
</body>
</html>
