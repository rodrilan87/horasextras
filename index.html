<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Horas Extras</title>

<style>
:root{
  --azul:#0a1a2f;
  --azul-claro:#eef3fb;
  --verde:#c7f5cf;
  --amarillo:#ffe9a6;
  --rojo:#ffb3b3;
}
*{box-sizing:border-box;font-family:Arial,sans-serif}
body{margin:0;background:var(--azul-claro)}

#loginBox{
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
}
.login-card{
  background:#fff;
  width:380px;
  padding:30px;
  border-radius:16px;
  box-shadow:0 10px 30px rgba(0,0,0,.15);
  text-align:center;
}
.login-card input{
  width:100%;
  padding:12px;
  margin-bottom:12px;
  border-radius:8px;
  border:1px solid #ccc;
}
.login-card button{
  width:100%;
  padding:12px;
  background:var(--azul);
  color:#fff;
  border:none;
  border-radius:8px;
  cursor:pointer;
}
.login-card .link{margin-top:10px;font-size:14px}
.login-card .link span{color:#1e5eff;cursor:pointer}
#error{color:red;margin-top:10px}

#app{display:none;padding:25px}
.card{background:#fff;border-radius:14px;padding:20px;margin-bottom:20px}

.form-row{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:10px;
}
.form-row input,.form-row select{
  padding:10px;border-radius:8px;border:1px solid #ccc
}
.form-row button{
  background:var(--azul);color:#fff;border:none;border-radius:8px;cursor:pointer
}

textarea{
  width:100%;min-height:80px;margin-top:10px;
  padding:12px;border-radius:10px;border:1px solid #ccc
}

.semaforo{
  display:grid;grid-template-columns:1fr 1fr 1fr;
  gap:15px;margin-top:15px
}
.semaforo div{
  padding:15px;text-align:center;border-radius:12px;
  font-weight:bold;opacity:.3
}
.verde{background:var(--verde)}
.amarillo{background:var(--amarillo)}
.rojo{background:var(--rojo)}

.mes{
  background:var(--verde);
  padding:10px;border-radius:10px;
  font-weight:bold;text-align:center;margin-top:25px
}
.registro{
  background:#ecfff0;padding:12px;border-radius:10px;
  margin-top:10px;display:flex;
  justify-content:space-between;align-items:center
}
.registro button{
  border:none;background:transparent;color:red;
  font-size:18px;cursor:pointer
}
.resumen{
  margin-top:8px;font-weight:bold;text-align:right
}
</style>
</head>

<body>

<div id="loginBox">
  <div class="login-card">
    <h2>Bienvenido</h2>
    <p>Ingresá para gestionar tus horas extras</p>
    <input id="email" placeholder="email">
    <input id="clave" type="password" placeholder="clave">
    <button onclick="doLogin()">Iniciar sesión</button>
    <div class="link">¿No tenés cuenta?
      <span onclick="doRegister()">Registrate aquí</span>
    </div>
    <div id="error"></div>
  </div>
</div>

<div id="app">

  <div style="display:flex;justify-content:flex-end;margin-bottom:15px">
    <button onclick="logout()" style="background:#ddd;border:none;padding:8px 14px;border-radius:8px">
      Cerrar sesión
    </button>
  </div>

  <div class="card">
    <div class="form-row">
      <input id="usuario" disabled>
      <input type="date" id="fecha">
      <input type="time" id="desde">
      <input type="time" id="hasta">
      <input id="tk" placeholder="TK">
      <select id="porcentaje">
        <option value="50%">50%</option>
        <option value="100%">100%</option>
      </select>
      <button onclick="guardar()">Guardar</button>
    </div>

    <textarea id="sugerencia" maxlength="50"
      placeholder="Sugerencias (hasta 50 palabras)"></textarea>

    <div class="semaforo">
      <div class="verde">0 a 15 hs</div>
      <div class="amarillo">16 a 25 hs</div>
      <div class="rojo">26 a 30 hs</div>
    </div>
  </div>

  <div class="card" id="listado"></div>
</div>

<script>
const API="https://script.google.com/macros/s/AKfycbyiFERs6AduXngSs4XnY1CwzTPJjtqv5G-dFut2GqBtmPwjZh5HnO1dE_s3jIYpSaUXHQ/exec";

function fFecha(v){return new Date(v).toLocaleDateString("es-AR")}
function fHora(v){return new Date(v).toLocaleTimeString("es-AR",{hour:"2-digit",minute:"2-digit"})}

function getDeleted(){
  return JSON.parse(localStorage.getItem("deletedRows")||"[]");
}
function markDeleted(id){
  const d=getDeleted();
  if(!d.includes(id)){d.push(id)}
  localStorage.setItem("deletedRows",JSON.stringify(d));
  cargar();
}

/* LOGIN */
function doLogin(){
  fetch(`${API}?action=login&email=${encodeURIComponent(email.value)}&clave=${encodeURIComponent(clave.value)}`)
  .then(r=>r.json())
  .then(d=>{
    if(!d.ok){error.textContent=d.error;return}
    usuario.value=d.email;
    loginBox.style.display="none";
    app.style.display="block";
    cargar();
  });
}
function doRegister(){
  fetch(`${API}?action=register&email=${encodeURIComponent(email.value)}&clave=${encodeURIComponent(clave.value)}`)
  .then(r=>r.json())
  .then(d=>error.textContent=d.ok?"Usuario registrado":d.error);
}
function logout(){
  app.style.display="none";
  loginBox.style.display="flex";
}

/* GUARDAR */
function guardar(){
  const h=(new Date(`1970-01-01T${hasta.value}`)-new Date(`1970-01-01T${desde.value}`))/3600000;
  if(h<=0)return alert("Horario inválido");
  fetch(`${API}?action=cargarHoras&email=${encodeURIComponent(usuario.value)}&fecha=${fecha.value}&desde=${desde.value}&hasta=${hasta.value}&horas=${h}&porcentaje=${porcentaje.value}&sugerencia=${encodeURIComponent(sugerencia.value)}&tk=${tk.value}`)
  .then(()=>cargar());
}

/* SEMÁFORO */
function semaforo(total){
  const b=document.querySelectorAll(".semaforo div");
  b.forEach(x=>{x.style.opacity=".3";x.style.border="none"});
  let i= total<=15?0: total<=25?1:2;
  b[i].style.opacity="1";
  b[i].style.border="2px solid #333";
}

/* LISTADO */
function cargar(){
  fetch(`${API}?action=listar&email=${encodeURIComponent(usuario.value)}`)
  .then(r=>r.json())
  .then(data=>{
    listado.innerHTML="";
    const deleted=getDeleted();

    let mesRef=null;
    if(fecha.value){
      mesRef=new Date(fecha.value)
        .toLocaleString("en-US",{month:"long",year:"numeric"});
    }

    const porMes={};
    let totalMesRef=0;

    data.forEach((r,i)=>{
      if(deleted.includes(i)) return;
      porMes[r[9]]=porMes[r[9]]||[];
      porMes[r[9]].push({r,id:i});
    });

    Object.keys(porMes).forEach(m=>{
      let th=0,tkc=0;
      porMes[m].forEach(o=>{
        th+=Number(o.r[6])||0;
        if(o.r[10])tkc++;
      });
      if(m===mesRef) totalMesRef=th;

      listado.innerHTML+=`<div class="mes">${m}</div>`;
      porMes[m].forEach(o=>{
        const r=o.r;
        listado.innerHTML+=`
          <div class="registro">
            <div>
              <b>${fFecha(r[3])}</b> · ${fHora(r[4])} a ${fHora(r[5])}
              · ${r[6]} hs · TK ${r[10]}
              <br><small>${r[8]||""}</small>
            </div>
            <button onclick="markDeleted(${o.id})">✖</button>
          </div>`;
      });
      listado.innerHTML+=`<div class="resumen">Total mes: ${th} hs · ${tkc} TK</div>`;
    });

    if(mesRef) semaforo(totalMesRef);
  });
}
</script>

</body>
</html>
