<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Horas Extras</title>

<style>
:root{
  --azul:#0a1a2f;
  --azul-claro:#eef3fb;
  --card:#ffffff;
  --borde:#d9e2f2;

  --verde-soft:#ecfff0;
  --verde:#2f9d55;
  --rosa:#ff4d87;

  --barra-bg:#e8eef7;
  --rojo:#e44b4b;
  --amarillo:#d2a10b;
}
*{box-sizing:border-box;font-family:Arial,sans-serif}
body{margin:0;background:var(--azul-claro);color:#0b1220}

/* LOGIN */
#loginBox{
  min-height:100vh; display:flex; justify-content:center; align-items:center;
}
.login-card{
  background:var(--card);
  width:380px;
  padding:30px;
  border-radius:16px;
  box-shadow:0 10px 30px rgba(0,0,0,.12);
  text-align:center;
}
.login-card h2{margin:0 0 8px}
.login-card p{margin:0 0 18px;color:#4c5567}
.login-card input{
  width:100%;
  padding:12px;
  margin-bottom:12px;
  border-radius:10px;
  border:1px solid #cfd6e6;
  background:#eef4ff;
  outline:none;
}
.login-card button{
  width:100%;
  padding:12px;
  background:var(--azul);
  color:#fff;
  border:none;
  border-radius:10px;
  cursor:pointer;
}
.login-card .link{margin-top:12px;font-size:14px}
.login-card .link span{color:#1e5eff;cursor:pointer}
#error{color:#b00020;margin-top:10px;font-size:14px}

/* APP */
#app{display:none;padding:22px;max-width:1400px;margin:0 auto}
.card{
  background:var(--card);
  border:1px solid var(--borde);
  border-radius:16px;
  padding:18px;
  margin-bottom:18px;
  box-shadow:0 6px 18px rgba(11,18,32,.06);
}
.topbar{
  display:flex; justify-content:flex-end; margin-bottom:12px;
}
.btn-ghost{
  background:#e9e9e9; border:none; padding:8px 14px; border-radius:10px;
  cursor:pointer;
}
.btn-primary{
  background:var(--azul); color:#fff; border:none; border-radius:12px;
  cursor:pointer; font-weight:700;
}
.btn-primary:disabled{opacity:.6;cursor:not-allowed}

/* FORM */
.form-row{
  display:grid;
  grid-template-columns: 260px 190px 140px 140px 1fr 260px 240px;
  gap:10px;
  align-items:center;
}
.form-row input,.form-row select{
  padding:12px 12px;
  border-radius:12px;
  border:1px solid #cfd6e6;
  background:#fff;
  outline:none;
}
.form-row input:disabled{background:#f2f5fb;color:#5b667a}
textarea{
  width:100%;
  min-height:120px;
  margin-top:10px;
  padding:12px;
  border-radius:14px;
  border:1px solid #cfd6e6;
  resize:vertical;
  outline:none;
}

/* selector de % con color */
.select-pct.p100{border-color:rgba(47,157,85,.35); box-shadow:0 0 0 3px rgba(47,157,85,.08) inset}
.select-pct.p50 {border-color:rgba(255,77,135,.35); box-shadow:0 0 0 3px rgba(255,77,135,.08) inset}

/* PROGRESO / DISPONIBILIDAD */
.avail{
  margin-top:12px;
  padding:14px;
  border-radius:14px;
  border:1px solid #e2e9f6;
  background:#fbfcff;
}
.avail-head{
  display:flex; justify-content:space-between; align-items:flex-end;
  gap:10px;
}
.avail-title{font-size:22px;font-weight:800;margin:0}
.avail-sub{margin:6px 0 0;color:#4c5567}
.avail-right{font-weight:800}
.progress{
  height:16px;
  background:var(--barra-bg);
  border-radius:999px;
  overflow:hidden;
  margin-top:12px;
  border:1px solid #e1e8f5;
}
.progress > div{
  height:100%;
  width:0%;
  background:var(--verde);
}
.progress.warn > div{background:var(--amarillo)}
.progress.danger > div{background:var(--rojo)}

/* LISTADO */
.mes{
  background:#c7f5cf;
  padding:10px;
  border-radius:12px;
  font-weight:800;
  text-align:center;
  margin-top:14px;
  text-transform:lowercase;
}
.registro{
  background:var(--verde-soft);
  padding:12px 14px;
  border-radius:12px;
  margin-top:10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
  border:1px solid #def2e2;
}
.registro .left{
  display:flex;
  flex-direction:column;
  gap:4px;
}
.registro .line1{
  font-size:16px;
  font-weight:700;
}
.registro .line2{
  font-size:13px;
  color:#4c5567;
  font-style:italic;
}
.registro .right{
  display:flex; align-items:center; gap:12px;
}
.registro button{
  border:none;
  background:transparent;
  color:#ff0000;
  font-size:22px;
  cursor:pointer;
  line-height:1;
}

/* fila según % */
.registro.p100{border-left:6px solid rgba(47,157,85,.65)}
.registro.p50 {border-left:6px solid rgba(255,77,135,.65)}
.registro.p0  {opacity:.65; filter:saturate(.7); border-left:6px solid rgba(150,160,180,.55)}

/* badge % */
.badge{
  display:inline-flex; align-items:center; justify-content:center;
  min-width:54px;
  padding:6px 10px;
  border-radius:999px;
  font-weight:800;
  font-size:12px;
  border:1px solid transparent;
  background:#eef4ff;
  color:#0b1220;
}
.badge.p100{background:rgba(47,157,85,.12); border-color:rgba(47,157,85,.25); color:var(--verde)}
.badge.p50 {background:rgba(255,77,135,.12); border-color:rgba(255,77,135,.25); color:var(--rosa)}
.badge.none{background:rgba(80,90,110,.10); border-color:rgba(80,90,110,.18); color:#4c5567}

/* resumen */
.resumen{
  margin-top:8px;
  font-weight:900;
  text-align:right;
  font-size:18px;
}

@media (max-width: 1100px){
  .form-row{
    grid-template-columns:1fr 1fr;
  }
  .btn-primary{width:100%}
}
</style>
</head>

<body>

<div id="loginBox">
  <div class="login-card">
    <h2>Bienvenido</h2>
    <p>Ingresá para gestionar tus horas extras</p>
    <input id="email" placeholder="email" autocomplete="username" />
    <input id="clave" type="password" placeholder="clave" autocomplete="current-password" />
    <button onclick="doLogin()">Iniciar sesión</button>
    <div class="link">¿No tenés cuenta?
      <span onclick="doRegister()">Registrate aquí</span>
    </div>
    <div id="error"></div>
  </div>
</div>

<div id="app">

  <div class="topbar">
    <button class="btn-ghost" onclick="logout()">Cerrar sesión</button>
  </div>

  <div class="card">
    <div class="form-row">
      <input id="usuario" disabled />

      <input type="date" id="fecha" />
      <input type="time" id="desde" />
      <input type="time" id="hasta" />

      <input id="tk" placeholder="TK" inputmode="numeric" />

      <select id="porcentaje" class="select-pct" onchange="paintPctSelect()">
        <option value="50%">50%</option>
        <option value="100%">100%</option>
      </select>

      <button id="btnGuardar" class="btn-primary" onclick="guardar()">Guardar</button>
    </div>

    <textarea id="sugerencia" maxlength="350"
      placeholder="Sugerencias (hasta 50 palabras)"></textarea>

    <!-- disponibilidad -->
    <div class="avail" id="availBox" style="display:none">
      <div class="avail-head">
        <div>
          <div class="avail-title" id="availTitle">Disponibilidad</div>
          <div class="avail-sub" id="availSub">—</div>
        </div>
        <div class="avail-right" id="availRight">0 / 30 hs</div>
      </div>
      <div class="progress" id="availBar"><div id="availFill"></div></div>
    </div>
  </div>

  <div class="card" id="listado"></div>
</div>

<script>
/* =========================
   CONFIG
========================= */
const API="https://script.google.com/macros/s/AKfycbyiFERs6AduXngSs4XnY1CwzTPJjtqv5G-dFut2GqBtmPwjZh5HnO1dE_s3jIYpSaUXHQ/exec";
const TOPE_MENSUAL = 30;

/* =========================
   HELPERS FECHA/HORA (ES)
========================= */
const ES = "es-AR";

function pad2(n){ return String(n).padStart(2,"0"); }

function fFecha(v){
  // v suele venir como fecha ISO o Date; usamos es-AR
  const d = new Date(v);
  if(Number.isNaN(d.getTime())) return String(v||"");
  return d.toLocaleDateString(ES);
}

function fHora(v){
  const d = new Date(v);
  if(Number.isNaN(d.getTime())) return "";
  return d.toLocaleTimeString(ES,{hour:"2-digit",minute:"2-digit"});
}

function mesAnioES(d){
  // d = Date
  return d.toLocaleDateString(ES,{month:"long",year:"numeric"}).toLowerCase();
}

function keyMes(d){
  // clave estable para agrupar: YYYY-MM
  return d.getFullYear()+"-"+pad2(d.getMonth()+1);
}

function labelMesFromKey(k){
  // k "YYYY-MM" -> "enero de 2026"
  const [yy,mm] = k.split("-");
  const d = new Date(Number(yy), Number(mm)-1, 1);
  return mesAnioES(d);
}

/* =========================
   BORRADOS (LOCAL)
========================= */
function getDeleted(){
  return JSON.parse(localStorage.getItem("deletedRows")||"[]");
}
function markDeleted(id){
  const d=getDeleted();
  if(!d.includes(id)) d.push(id);
  localStorage.setItem("deletedRows",JSON.stringify(d));
  cargar();
}

/* =========================
   % (mostrar 100 / 50)
========================= */
function pctToText(pctRaw){
  const p = String(pctRaw ?? "").trim().toLowerCase();
  if(!p) return "";
  if(p.includes("100") || p === "1" || p === "1.0") return "100%";
  if(p.includes("50")  || p === "0.5" || p === "0,5") return "50%";
  const n = Number(p.replace(",", "."));
  if(!Number.isNaN(n)){
    if(n === 1) return "100%";
    if(n === 0.5) return "50%";
    if(n > 0 && n <= 1) return Math.round(n*100) + "%";
    if(n > 1 && n <= 100) return Math.round(n) + "%";
  }
  return p;
}

function pctBadge(pctRaw){
  const txt = pctToText(pctRaw);
  if(!txt) return `<span class="badge none">sin %</span>`;
  const is50 = txt.startsWith("50");
  return `<span class="badge ${is50?"p50":"p100"}">${txt}</span>`;
}

function rowClassByPct(pctRaw, isZero){
  if(isZero) return "p0";
  const txt = pctToText(pctRaw);
  if(txt.startsWith("50")) return "p50";
  return "p100";
}

function paintPctSelect(){
  const sel = document.getElementById("porcentaje");
  sel.classList.remove("p50","p100");
  if(sel.value === "50%") sel.classList.add("p50");
  else sel.classList.add("p100");
}

/* =========================
   RESTRICCIÓN: NO FUTURO
========================= */
function clampNoFuturo(){
  // set max del input date al día de hoy
  const today = new Date();
  const max = today.getFullYear()+"-"+pad2(today.getMonth()+1)+"-"+pad2(today.getDate());
  fecha.max = max;
  // si el usuario tenía una fecha futura cargada, la bajamos a hoy
  if(fecha.value && fecha.value > max) fecha.value = max;
}

/* =========================
   LOGIN / REGISTRO
========================= */
function doLogin(){
  error.textContent="";
  fetch(`${API}?action=login&email=${encodeURIComponent(email.value)}&clave=${encodeURIComponent(clave.value)}`)
    .then(r=>r.json())
    .then(d=>{
      if(!d.ok){ error.textContent=d.error || "No se pudo iniciar sesión"; return; }
      usuario.value = d.email;
      loginBox.style.display="none";
      app.style.display="block";
      // default fecha hoy
      clampNoFuturo();
      if(!fecha.value) fecha.value = fecha.max;
      paintPctSelect();
      cargar();
    })
    .catch(()=> error.textContent="Error de conexión");
}

function doRegister(){
  error.textContent="";
  fetch(`${API}?action=register&email=${encodeURIComponent(email.value)}&clave=${encodeURIComponent(clave.value)}`)
    .then(r=>r.json())
    .then(d=> error.textContent = d.ok ? "Usuario registrado ✅" : (d.error || "No se pudo registrar"))
    .catch(()=> error.textContent="Error de conexión");
}

function logout(){
  app.style.display="none";
  loginBox.style.display="flex";
  // limpieza liviana de UI
  listado.innerHTML="";
}

/* =========================
   GUARDAR
========================= */
function horasDiff(desdeStr, hastaStr){
  const a = new Date(`1970-01-01T${desdeStr}`);
  const b = new Date(`1970-01-01T${hastaStr}`);
  return (b - a)/3600000;
}

function guardar(){
  // Validaciones básicas
  if(!usuario.value) return alert("Iniciá sesión.");
  if(!fecha.value) return alert("Elegí una fecha.");
  clampNoFuturo();
  if(fecha.max && fecha.value > fecha.max) return alert("No se pueden cargar horas a futuro.");

  const h = horasDiff(desde.value, hasta.value);
  if(!desde.value || !hasta.value) return alert("Completá desde y hasta.");
  if(!(h>0)) return alert("Horario inválido.");

  btnGuardar.disabled = true;

  fetch(`${API}?action=cargarHoras&email=${encodeURIComponent(usuario.value)}&fecha=${fecha.value}&desde=${desde.value}&hasta=${hasta.value}&horas=${h}&porcentaje=${encodeURIComponent(porcentaje.value)}&sugerencia=${encodeURIComponent(sugerencia.value)}&tk=${encodeURIComponent(tk.value)}`)
    .then(r=>r.json?.() ?? r.text())
    .then(()=> {
      // limpiar campos que molesten
      sugerencia.value="";
      tk.value="";
      cargar();
    })
    .catch(()=> alert("No se pudo guardar."))
    .finally(()=> btnGuardar.disabled = false);
}

/* =========================
   DISPONIBILIDAD (barra)
========================= */
function setDisponibilidad(mesLabel, usadas){
  const box = document.getElementById("availBox");
  const title = document.getElementById("availTitle");
  const sub = document.getElementById("availSub");
  const right = document.getElementById("availRight");
  const bar = document.getElementById("availBar");
  const fill = document.getElementById("availFill");

  box.style.display="block";

  const usadasClamped = Math.max(0, Number(usadas||0));
  const restantes = Math.max(0, TOPE_MENSUAL - usadasClamped);

  title.textContent = `Disponibilidad — ${mesLabel}`;
  right.textContent = `${usadasClamped} / ${TOPE_MENSUAL} hs`;
  sub.textContent = `Te quedan ${restantes} hs para cargar este mes.`;

  const pct = Math.min(100, (usadasClamped/TOPE_MENSUAL)*100);
  fill.style.width = pct + "%";

  bar.classList.remove("warn","danger");
  if(usadasClamped >= 26) bar.classList.add("danger");
  else if(usadasClamped >= 16) bar.classList.add("warn");
}

/* =========================
   LISTADO
========================= */
function cargar(){
  if(!usuario.value) return;

  clampNoFuturo();

  fetch(`${API}?action=listar&email=${encodeURIComponent(usuario.value)}`)
    .then(r=>r.json())
    .then(data=>{
      listado.innerHTML="";
      const deleted = getDeleted();

      // mes activo = el del input fecha (si está), sino mes actual
      const base = fecha.value ? new Date(fecha.value) : new Date();
      const activeKey = keyMes(base);
      const activeLabel = mesAnioES(new Date(base.getFullYear(), base.getMonth(), 1));

      // agrupar por mes (YYYY-MM)
      const porMes = {};
      // guardamos además horas totales del mes activo para barra
      let totalMesActivo = 0;

      // data: cada fila es array. En tu backup:
      // r[3]=fecha, r[4]=desde, r[5]=hasta, r[6]=horas, r[8]=sugerencia, r[9]=mes (texto), r[10]=TK, r[7]=porcentaje (puede variar según tu GS)
      // Para ser robustos: detectamos porcentaje en r[7] o r[11] si existe.
      data.forEach((r,i)=>{
        if(deleted.includes(i)) return;

        const fechaRaw = r[3];
        const d = new Date(fechaRaw);
        if(Number.isNaN(d.getTime())) return;

        const k = keyMes(d);
        if(!porMes[k]) porMes[k] = [];
        porMes[k].push({r, id:i});
      });

      // Orden meses DESC (más nuevo arriba)
      const mesesOrdenados = Object.keys(porMes).sort((a,b)=> b.localeCompare(a));

      // render
      mesesOrdenados.forEach(k=>{
        const arr = porMes[k];

        // ordenar registros DESC por fecha/hora
        arr.sort((a,b)=>{
          const da = new Date(a.r[3]).getTime();
          const db = new Date(b.r[3]).getTime();
          return db - da;
        });

        // totales
        let th = 0;
        let tkSum = 0;

        // Calculamos totales teniendo en cuenta: si el registro está "en 0" (suele ser r[6]==0) no suma
        arr.forEach(o=>{
          const r = o.r;
          const horas = Number(r[6]) || 0;
          const tkVal = Number(String(r[10]||"").replace(/[^\d]/g,"")) || 0;
          if(horas > 0){
            th += horas;
            tkSum += tkVal; // suma real de TK (no conteo)
          }
        });

        if(k === activeKey) totalMesActivo = th;

        listado.innerHTML += `<div class="mes">${labelMesFromKey(k)}</div>`;

        arr.forEach(o=>{
          const r = o.r;
          const horas = Number(r[6]) || 0;
          const tkValRaw = r[10] ?? "";
          const tkText = String(tkValRaw).trim() ? `TK ${tkValRaw}` : "TK -";
          const sug = (r[8]||"").trim();

          // porcentaje: en distintos intentos puede venir en r[7] o r[11] o literal "50%" / "100%"
          const pctRaw = (r[7] ?? r[11] ?? r[12] ?? "");
          const isZero = horas <= 0;

          const rowCls = rowClassByPct(pctRaw, isZero);

          const extraZero = isZero
            ? `<div class="line2">Este registro se puso en 0 y no se suma a tus horas cargadas</div>`
            : (sug ? `<div class="line2">${escapeHtml(sug)}</div>` : "");

          listado.innerHTML += `
            <div class="registro ${rowCls}">
              <div class="left">
                <div class="line1">
                  <b>${fFecha(r[3])}</b> · ${fHora(r[4])} a ${fHora(r[5])} · ${horas} hs · ${tkText}
                </div>
                ${extraZero}
              </div>
              <div class="right">
                ${pctBadge(pctRaw)}
                <button title="Poner en 0" onclick="markDeleted(${o.id})">✖</button>
              </div>
            </div>`;
        });

        listado.innerHTML += `<div class="resumen">Total mes: ${th} hs · ${tkSum} TK</div>`;
      });

      // barra disponibilidad
      setDisponibilidad(activeLabel, totalMesActivo);

      // mantengo selector pintado
      paintPctSelect();
    })
    .catch(()=> {
      listado.innerHTML = `<div style="padding:10px;color:#b00020;font-weight:700">No se pudo cargar el listado.</div>`;
    });
}

/* =========================
   Seguridad básica
========================= */
function escapeHtml(str){
  return String(str).replace(/[&<>"']/g, s => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[s]));
}

/* =========================
   INIT UI
========================= */
document.addEventListener("DOMContentLoaded", ()=>{
  // defaults
  clampNoFuturo();
  paintPctSelect();
  // si cambia fecha, recalcular barra (mes activo)
  fecha.addEventListener("change", ()=> {
    clampNoFuturo();
    cargar();
  });
});
</script>

</body>
</html>
