<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Horas Extras</title>

<style>
:root{
  --azul:#0a1a2f;
  --azul-claro:#eef3fb;
  --card:#ffffff;
  --borde:#d9e2f2;

  --verde-soft:#ecfff0;
  --verde:#2f9d55;
  --rosa:#ff4d87;

  --barra-bg:#e8eef7;
  --rojo:#e44b4b;
  --amarillo:#d2a10b;
}
*{box-sizing:border-box;font-family:Arial,sans-serif}
body{margin:0;background:var(--azul-claro);color:#0b1220}

/* LOGIN */
#loginBox{
  min-height:100vh; display:flex; justify-content:center; align-items:center;
}
.login-card{
  background:var(--card);
  width:380px;
  padding:30px;
  border-radius:16px;
  box-shadow:0 10px 30px rgba(0,0,0,.12);
  text-align:center;
}
.login-card h2{margin:0 0 8px}
.login-card p{margin:0 0 18px;color:#4c5567}
.login-card input{
  width:100%;
  padding:12px;
  margin-bottom:12px;
  border-radius:10px;
  border:1px solid #cfd6e6;
  background:#eef4ff;
  outline:none;
}
.login-card button{
  width:100%;
  padding:12px;
  background:var(--azul);
  color:#fff;
  border:none;
  border-radius:10px;
  cursor:pointer;
  font-weight:800;
}
.login-card .link{margin-top:12px;font-size:14px}
.login-card .link span{color:#1e5eff;cursor:pointer}
#error{color:#b00020;margin-top:10px;font-size:14px}

/* APP */
#app{display:none;padding:22px;max-width:1400px;margin:0 auto}
.card{
  background:var(--card);
  border:1px solid var(--borde);
  border-radius:16px;
  padding:18px;
  margin-bottom:18px;
  box-shadow:0 6px 18px rgba(11,18,32,.06);
}

/* TOPBAR */
.topbar{
  position:sticky;
  top:0;
  z-index:50;
  display:flex;
  justify-content:flex-end;
  padding:10px 6px;
  margin:-10px 0 8px;
  background:linear-gradient(to bottom, rgba(238,243,251,.95), rgba(238,243,251,.65));
  backdrop-filter: blur(6px);
}
.btn-corp{
  background:var(--azul);
  color:#fff;
  border:none;
  padding:10px 16px;
  border-radius:999px;
  cursor:pointer;
  font-weight:900;
  box-shadow:0 10px 22px rgba(10,26,47,.16);
}
.btn-corp:hover{filter:brightness(1.05)}

/* ✅ FIX DEFINITIVO: FORM en flex + wrap (el botón nunca se pierde) */
.form-row{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  align-items:center;
}

/* cada campo con ancho “corporativo” */
.form-row input,
.form-row select{
  padding:12px 12px;
  border-radius:12px;
  border:1px solid #cfd6e6;
  background:#fff;
  outline:none;
  height:46px;
}

/* anchos sugeridos por campo (se adaptan, y si no entran bajan) */
#usuario{flex: 1 1 260px; min-width:220px;}
#fecha  {flex: 0 1 190px; min-width:160px;}
#desde  {flex: 0 1 140px; min-width:120px;}
#hasta  {flex: 0 1 140px; min-width:120px;}
#tk     {flex: 1 1 220px; min-width:180px;}
#porcentaje{flex: 0 1 160px; min-width:140px;}

/* ✅ Guardar: ancho fijo mínimo, y si no entra baja y ocupa 100% */
.btn-primary{
  flex: 0 0 220px;     /* ancho normal */
  min-width: 200px;
  height:46px;

  background:var(--azul);
  color:#fff;
  border:none;
  border-radius:12px;
  cursor:pointer;
  font-weight:900;
  padding:12px 16px;
  box-shadow:0 10px 22px rgba(10,26,47,.14);
}
.btn-primary:hover{filter:brightness(1.05)}
.btn-primary:disabled{opacity:.6;cursor:not-allowed}

/* cuando la pantalla es más chica, Guardar baja y ocupa todo */
@media (max-width: 900px){
  .btn-primary{flex: 1 1 100%;}
}

/* textarea */
textarea{
  width:100%;
  min-height:120px;
  margin-top:10px;
  padding:12px;
  border-radius:14px;
  border:1px solid #cfd6e6;
  resize:vertical;
  outline:none;
}

/* selector de % con color */
.select-pct.p100{border-color:rgba(47,157,85,.35); box-shadow:0 0 0 3px rgba(47,157,85,.08) inset}
.select-pct.p50 {border-color:rgba(255,77,135,.35); box-shadow:0 0 0 3px rgba(255,77,135,.08) inset}

/* PROGRESO / DISPONIBILIDAD */
.avail{
  margin-top:12px;
  padding:14px;
  border-radius:14px;
  border:1px solid #e2e9f6;
  background:#fbfcff;
}
.avail-head{
  display:flex; justify-content:space-between; align-items:flex-end;
  gap:10px;
}
.avail-title{font-size:22px;font-weight:900;margin:0}
.avail-sub{margin:6px 0 0;color:#4c5567}
.avail-right{font-weight:900}
.progress{
  height:16px;
  background:var(--barra-bg);
  border-radius:999px;
  overflow:hidden;
  margin-top:12px;
  border:1px solid #e1e8f5;
}
.progress > div{
  height:100%;
  width:0%;
  background:var(--verde);
}
.progress.warn > div{background:var(--amarillo)}
.progress.danger > div{background:var(--rojo)}

/* LISTADO */
.mes{
  background:#c7f5cf;
  padding:10px;
  border-radius:12px;
  font-weight:900;
  text-align:center;
  margin-top:14px;
  text-transform:lowercase;
}
.registro{
  background:var(--verde-soft);
  padding:12px 14px;
  border-radius:12px;
  margin-top:10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
  border:1px solid #def2e2;
}
.registro .left{display:flex; flex-direction:column; gap:4px;}
.registro .line1{font-size:16px;font-weight:800;}
.registro .line2{font-size:13px;color:#4c5567;font-style:italic;}
.registro .right{display:flex; align-items:center; gap:12px;}
.registro button{
  border:none;background:transparent;color:#ff0000;
  font-size:22px;cursor:pointer;line-height:1;
}

/* fila según % */
.registro.p100{border-left:6px solid rgba(47,157,85,.65)}
.registro.p50 {border-left:6px solid rgba(255,77,135,.65)}
.registro.p0  {opacity:.65; filter:saturate(.7); border-left:6px solid rgba(150,160,180,.55)}

/* badge % */
.badge{
  display:inline-flex; align-items:center; justify-content:center;
  min-width:54px; padding:6px 10px; border-radius:999px;
  font-weight:900; font-size:12px;
  border:1px solid transparent;
  background:#eef4ff; color:#0b1220;
}
.badge.p100{background:rgba(47,157,85,.12); border-color:rgba(47,157,85,.25); color:var(--verde)}
.badge.p50 {background:rgba(255,77,135,.12); border-color:rgba(255,77,135,.25); color:var(--rosa)}
.badge.none{background:rgba(80,90,110,.10); border-color:rgba(80,90,110,.18); color:#4c5567}

/* resumen */
.resumen{margin-top:8px;font-weight:900;text-align:right;font-size:18px}
</style>
</head>

<body>

<div id="loginBox">
  <div class="login-card">
    <h2>Bienvenido</h2>
    <p>Ingresá para gestionar tus horas extras</p>
    <input id="email" placeholder="email" autocomplete="username" />
    <input id="clave" type="password" placeholder="clave" autocomplete="current-password" />
    <button onclick="doLogin()">Iniciar sesión</button>
    <div class="link">¿No tenés cuenta?
      <span onclick="doRegister()">Registrate aquí</span>
    </div>
    <div id="error"></div>
  </div>
</div>

<div id="app">
  <div class="topbar">
    <button class="btn-corp" onclick="logout()">Cerrar sesión</button>
  </div>

  <div class="card">
    <div class="form-row">
      <input id="usuario" disabled />

      <input type="date" id="fecha" />
      <input type="time" id="desde" />
      <input type="time" id="hasta" />

      <input id="tk" placeholder="TK" inputmode="numeric" />

      <select id="porcentaje" class="select-pct" onchange="paintPctSelect()">
        <option value="50%">50%</option>
        <option value="100%">100%</option>
      </select>

      <button id="btnGuardar" class="btn-primary" onclick="guardar()">Guardar</button>
    </div>

    <textarea id="sugerencia" maxlength="350"
      placeholder="Sugerencias (hasta 50 palabras)"></textarea>

    <div class="avail" id="availBox" style="display:none">
      <div class="avail-head">
        <div>
          <div class="avail-title" id="availTitle">Disponibilidad</div>
          <div class="avail-sub" id="availSub">—</div>
        </div>
        <div class="avail-right" id="availRight">0 / 30 hs</div>
      </div>
      <div class="progress" id="availBar"><div id="availFill"></div></div>
    </div>
  </div>

  <div class="card" id="listado"></div>
</div>

<script>
const API="https://script.google.com/macros/s/AKfycbyiFERs6AduXngSs4XnY1CwzTPJjtqv5G-dFut2GqBtmPwjZh5HnO1dE_s3jIYpSaUXHQ/exec";
const TOPE_MENSUAL = 30;
const ES = "es-AR";

function pad2(n){ return String(n).padStart(2,"0"); }
function fFecha(v){ const d=new Date(v); if(Number.isNaN(d.getTime())) return String(v||""); return d.toLocaleDateString(ES); }
function fHora(v){ const d=new Date(v); if(Number.isNaN(d.getTime())) return ""; return d.toLocaleTimeString(ES,{hour:"2-digit",minute:"2-digit"}); }
function mesAnioES(d){ return d.toLocaleDateString(ES,{month:"long",year:"numeric"}).toLowerCase(); }
function keyMes(d){ return d.getFullYear()+"-"+pad2(d.getMonth()+1); }
function labelMesFromKey(k){ const [yy,mm]=k.split("-"); const d=new Date(Number(yy),Number(mm)-1,1); return mesAnioES(d); }

function getDeleted(){ return JSON.parse(localStorage.getItem("deletedRows")||"[]"); }
function markDeleted(id){ const d=getDeleted(); if(!d.includes(id)) d.push(id); localStorage.setItem("deletedRows",JSON.stringify(d)); cargar(); }

/* % */
function pctToNumber(pctRaw){
  const s=String(pctRaw??"").trim().toLowerCase();
  if(!s) return null;
  if(s.includes("100")) return 1;
  if(s.includes("50")) return 0.5;
  const n=Number(s.replace(",","."));
  if(Number.isNaN(n)) return null;
  if(n===1||n===0.5) return n;
  if(n===100) return 1;
  if(n===50) return 0.5;
  if(n>0&&n<=1) return n;
  if(n>1&&n<=100) return n/100;
  return null;
}
function pctToText(pctRaw){
  const n=pctToNumber(pctRaw);
  if(n===1) return "100%";
  if(n===0.5) return "50%";
  if(n&&n>0) return Math.round(n*100)+"%";
  return "";
}
function pctBadge(pctRaw){
  const txt=pctToText(pctRaw);
  if(!txt) return `<span class="badge none">sin %</span>`;
  const n=pctToNumber(pctRaw);
  return `<span class="badge ${n===0.5?"p50":"p100"}">${txt}</span>`;
}
function rowClassByPct(pctRaw,isZero){
  if(isZero) return "p0";
  const n=pctToNumber(pctRaw);
  return (n===0.5) ? "p50" : "p100";
}
function paintPctSelect(){
  const sel=document.getElementById("porcentaje");
  sel.classList.remove("p50","p100");
  if(sel.value==="50%") sel.classList.add("p50"); else sel.classList.add("p100");
}

/* no futuro */
function clampNoFuturo(){
  const today=new Date();
  const max=today.getFullYear()+"-"+pad2(today.getMonth()+1)+"-"+pad2(today.getDate());
  fecha.max=max;
  if(fecha.value && fecha.value>max) fecha.value=max;
}

/* login */
function doLogin(){
  error.textContent="";
  fetch(`${API}?action=login&email=${encodeURIComponent(email.value)}&clave=${encodeURIComponent(clave.value)}`)
    .then(r=>r.json())
    .then(d=>{
      if(!d.ok){ error.textContent=d.error||"No se pudo iniciar sesión"; return; }
      usuario.value=d.email;
      loginBox.style.display="none";
      app.style.display="block";
      clampNoFuturo();
      if(!fecha.value) fecha.value=fecha.max;
      paintPctSelect();
      cargar();
    })
    .catch(()=> error.textContent="Error de conexión");
}
function doRegister(){
  error.textContent="";
  fetch(`${API}?action=register&email=${encodeURIComponent(email.value)}&clave=${encodeURIComponent(clave.value)}`)
    .then(r=>r.json())
    .then(d=> error.textContent = d.ok ? "Usuario registrado ✅" : (d.error||"No se pudo registrar"))
    .catch(()=> error.textContent="Error de conexión");
}
function logout(){
  app.style.display="none";
  loginBox.style.display="flex";
  listado.innerHTML="";
}

/* guardar */
function horasDiff(desdeStr,hastaStr){
  const a=new Date(`1970-01-01T${desdeStr}`);
  const b=new Date(`1970-01-01T${hastaStr}`);
  return (b-a)/3600000;
}
function guardar(){
  if(!usuario.value) return alert("Iniciá sesión.");
  if(!fecha.value) return alert("Elegí una fecha.");
  clampNoFuturo();
  if(fecha.max && fecha.value>fecha.max) return alert("No se pueden cargar horas a futuro.");

  const h=horasDiff(desde.value,hasta.value);
  if(!desde.value||!hasta.value) return alert("Completá desde y hasta.");
  if(!(h>0)) return alert("Horario inválido.");

  btnGuardar.disabled=true;

  fetch(`${API}?action=cargarHoras&email=${encodeURIComponent(usuario.value)}&fecha=${fecha.value}&desde=${desde.value}&hasta=${hasta.value}&horas=${h}&porcentaje=${encodeURIComponent(porcentaje.value)}&sugerencia=${encodeURIComponent(sugerencia.value)}&tk=${encodeURIComponent(tk.value)}`)
    .then(()=> { sugerencia.value=""; tk.value=""; cargar(); })
    .catch(()=> alert("No se pudo guardar."))
    .finally(()=> btnGuardar.disabled=false);
}

/* disponibilidad */
function setDisponibilidad(mesLabel, usadas){
  const box=document.getElementById("availBox");
  const title=document.getElementById("availTitle");
  const sub=document.getElementById("availSub");
  const right=document.getElementById("availRight");
  const bar=document.getElementById("availBar");
  const fill=document.getElementById("availFill");

  box.style.display="block";
  const usadasClamped=Math.max(0, Number(usadas||0));
  const restantes=Math.max(0, TOPE_MENSUAL-usadasClamped);

  title.textContent=`Disponibilidad — ${mesLabel}`;
  right.textContent=`${usadasClamped} / ${TOPE_MENSUAL} hs`;
  sub.textContent=`Te quedan ${restantes} hs para cargar este mes.`;

  const pct=Math.min(100,(usadasClamped/TOPE_MENSUAL)*100);
  fill.style.width=pct+"%";

  bar.classList.remove("warn","danger");
  if(usadasClamped>=26) bar.classList.add("danger");
  else if(usadasClamped>=16) bar.classList.add("warn");
}

/* listado */
function cargar(){
  if(!usuario.value) return;

  clampNoFuturo();

  fetch(`${API}?action=listar&email=${encodeURIComponent(usuario.value)}`)
    .then(r=>r.json())
    .then(data=>{
      listado.innerHTML="";
      const deleted=getDeleted();

      const base=fecha.value ? new Date(fecha.value) : new Date();
      const activeKey=keyMes(base);
      const activeLabel=mesAnioES(new Date(base.getFullYear(), base.getMonth(), 1));

      const porMes={};
      let totalMesActivo=0;

      data.forEach((r,i)=>{
        if(deleted.includes(i)) return;
        const d=new Date(r[3]);
        if(Number.isNaN(d.getTime())) return;
        const k=keyMes(d);
        if(!porMes[k]) porMes[k]=[];
        porMes[k].push({r,id:i});
      });

      const mesesOrdenados=Object.keys(porMes).sort((a,b)=> b.localeCompare(a));

      mesesOrdenados.forEach(k=>{
        const arr=porMes[k];
        arr.sort((a,b)=> new Date(b.r[3]).getTime()-new Date(a.r[3]).getTime());

        let th=0;
        let tkSum=0;

        arr.forEach(o=>{
          const r=o.r;
          const horas=Number(r[6])||0;
          const tkVal=Number(String(r[10]||"").replace(/[^\d]/g,""))||0;
          if(horas>0){
            th+=horas;
            tkSum+=tkVal;
          }
        });

        if(k===activeKey) totalMesActivo=th;

        listado.innerHTML+=`<div class="mes">${labelMesFromKey(k)}</div>`;

        arr.forEach(o=>{
          const r=o.r;
          const horas=Number(r[6])||0;
          const tkText=String(r[10]||"").trim() ? `${r[10]} TK` : "TK -";
          const sug=(r[8]||"").trim();

          const pctRaw=(r[7] ?? r[11] ?? r[12] ?? r[2] ?? "");
          const isZero=horas<=0;
          const rowCls=rowClassByPct(pctRaw,isZero);

          const extraZero=isZero
            ? `<div class="line2">Este registro se puso en 0 y no se suma a tus horas cargadas</div>`
            : (sug ? `<div class="line2">${escapeHtml(sug)}</div>` : "");

          listado.innerHTML+=`
            <div class="registro ${rowCls}">
              <div class="left">
                <div class="line1">
                  <b>${fFecha(r[3])}</b> · ${fHora(r[4])} a ${fHora(r[5])} · ${horas} hs · ${tkText}
                </div>
                ${extraZero}
              </div>
              <div class="right">
                ${pctBadge(pctRaw)}
                <button title="Poner en 0" onclick="markDeleted(${o.id})">✖</button>
              </div>
            </div>`;
        });

        listado.innerHTML+=`<div class="resumen">Total mes: ${th} hs · ${tkSum} TK</div>`;
      });

      setDisponibilidad(activeLabel,totalMesActivo);
      paintPctSelect();
    })
    .catch(()=> {
      listado.innerHTML=`<div style="padding:10px;color:#b00020;font-weight:800">No se pudo cargar el listado.</div>`;
    });
}

function escapeHtml(str){
  return String(str).replace(/[&<>"']/g, s => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[s]));
}

/* init */
document.addEventListener("DOMContentLoaded", ()=>{
  clampNoFuturo();
  paintPctSelect();
  fecha.addEventListener("change", ()=> { clampNoFuturo(); cargar(); });
});
</script>

</body>
</html>
