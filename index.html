<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Horas Extras</title>

<style>
:root{
  --azul:#0a1a2f;
  --azul-claro:#eef3fb;

  --verde-soft:#ecfff0;
  --verde:#36a853;

  --rosa-soft:#ffe8f1;
  --rosa:#e84d8a;

  --gris:#e9eef6;
  --texto:#0b1220;
  --borde:#d5dbe6;
}
*{box-sizing:border-box;font-family:Arial,sans-serif}
body{margin:0;background:var(--azul-claro);color:var(--texto)}

#loginBox{
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
}
.login-card{
  background:#fff;
  width:380px;
  padding:30px;
  border-radius:16px;
  box-shadow:0 10px 30px rgba(0,0,0,.15);
  text-align:center;
}
.login-card input{
  width:100%;
  padding:12px;
  margin-bottom:12px;
  border-radius:8px;
  border:1px solid #ccc;
}
.login-card button{
  width:100%;
  padding:12px;
  background:var(--azul);
  color:#fff;
  border:none;
  border-radius:8px;
  cursor:pointer;
}
.login-card .link{margin-top:10px;font-size:14px}
.login-card .link span{color:#1e5eff;cursor:pointer}
#error{color:red;margin-top:10px}

#app{display:none;padding:25px}
.card{
  background:#fff;border-radius:14px;padding:20px;margin-bottom:20px;
  box-shadow:0 6px 18px rgba(10,26,47,.06);
}

.topbar{
  display:flex;
  justify-content:flex-end;
  align-items:center;
  margin-bottom:15px;
}
.topbar button{
  background:#ddd;border:none;padding:8px 14px;border-radius:8px;cursor:pointer
}

.form-row{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:10px;
}
.form-row input,.form-row select{
  padding:10px;border-radius:10px;border:1px solid var(--borde);
  outline:none;
}
.form-row input:disabled{background:#f4f6fb}
.form-row button{
  background:var(--azul);color:#fff;border:none;border-radius:10px;cursor:pointer;
  font-weight:700;
}

textarea{
  width:100%;
  min-height:96px;
  margin-top:10px;
  padding:12px;
  border-radius:12px;
  border:1px solid var(--borde);
  resize:vertical;
}

/* Selector % con color */
.select-wrap{ position:relative; }
#porcentaje{
  font-weight:800;
}
#porcentaje.p100{
  background:rgba(54,168,83,.10);
  border-color:rgba(54,168,83,.45);
  color:#0b5f2f;
}
#porcentaje.p50{
  background:rgba(232,77,138,.10);
  border-color:rgba(232,77,138,.45);
  color:#8a0f42;
}

/* Disponibilidad */
.avail{
  margin-top:14px;
  border:1px solid #e6ebf4;
  border-radius:14px;
  padding:14px;
  background:#fff;
}
.avail-head{
  display:flex;
  justify-content:space-between;
  align-items:flex-end;
  gap:10px;
  margin-bottom:6px;
}
.avail-title{
  font-size:18px;
  font-weight:800;
  text-transform:lowercase;
}
.avail-sub{
  font-size:13px;color:#45526a;margin-bottom:10px;
}
.avail-right{
  font-weight:800;
  font-size:16px;
}
.progress{
  height:16px;
  border-radius:999px;
  background:var(--gris);
  overflow:hidden;
  border:1px solid #e0e6f2;
}
.progress > div{
  height:100%;
  width:0%;
  background:var(--verde);
  transition:width .25s ease;
}
.progress.warn > div{ background:#f1b400; }
.progress.danger > div{ background:#e14444; }

.mes{
  background:#c7f5cf;
  padding:10px;border-radius:12px;
  font-weight:800;text-align:center;margin-top:20px;
  text-transform:lowercase;
}

/* Registro por porcentaje */
.registro{
  padding:12px 14px;
  border-radius:12px;
  margin-top:10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
  border:1px solid rgba(0,0,0,.03);
}
.registro.p100{ background:var(--verde-soft); }
.registro.p50{ background:var(--rosa-soft); }

.registro small{color:#5b6b7e}
.registro .mainline{font-weight:700}
.registro button{
  border:none;background:transparent;color:#e00;
  font-size:20px;cursor:pointer;line-height:1;
}

.resumen{
  margin-top:10px;font-weight:800;text-align:right
}

.badge{
  display:inline-block;
  margin-left:8px;
  padding:2px 8px;
  border-radius:999px;
  font-size:12px;
  font-weight:800;
  vertical-align:middle;
  border:1px solid transparent;
}
.badge.p100{
  background:rgba(54,168,83,.12);
  border-color:rgba(54,168,83,.35);
  color:#0b5f2f;
}
.badge.p50{
  background:rgba(232,77,138,.12);
  border-color:rgba(232,77,138,.35);
  color:#8a0f42;
}
.badge.none{
  background:#eef3fb;border-color:#d5dbe6;color:#3c4a61;
}
</style>
</head>

<body>

<div id="loginBox">
  <div class="login-card">
    <h2>Bienvenido</h2>
    <p>Ingresá para gestionar tus horas extras</p>
    <input id="email" placeholder="email" autocomplete="username">
    <input id="clave" type="password" placeholder="clave" autocomplete="current-password">
    <button onclick="doLogin()">Iniciar sesión</button>
    <div class="link">¿No tenés cuenta?
      <span onclick="doRegister()">Registrate aquí</span>
    </div>
    <div id="error"></div>
  </div>
</div>

<div id="app">

  <div class="topbar">
    <button onclick="logout()">Cerrar sesión</button>
  </div>

  <div class="card">
    <div class="form-row">
      <input id="usuario" disabled>
      <input type="date" id="fecha" max="">
      <input type="time" id="desde">
      <input type="time" id="hasta">
      <input id="tk" placeholder="TK">
      <select id="porcentaje">
        <option value="50%">50%</option>
        <option value="100%">100%</option>
      </select>
      <button onclick="guardar()">Guardar</button>
    </div>

    <textarea id="sugerencia" placeholder="Sugerencias (hasta 50 palabras)"></textarea>

    <div class="avail" id="availBox" style="display:none">
      <div class="avail-head">
        <div class="avail-title" id="availTitle">Disponibilidad</div>
        <div class="avail-right" id="availRight">0 / 30 hs</div>
      </div>
      <div class="avail-sub" id="availSub">Te quedan 30 hs para cargar este mes.</div>
      <div class="progress" id="prog">
        <div id="progFill"></div>
      </div>
    </div>
  </div>

  <div class="card" id="listado"></div>
</div>

<script>
const API="https://script.google.com/macros/s/AKfycbyiFERs6AduXngSs4XnY1CwzTPJjtqv5G-dFut2GqBtmPwjZh5HnO1dE_s3jIYpSaUXHQ/exec";
const TOPE_MENSUAL = 30;

// ===== Helpers ES-AR =====
function fFecha(v){
  try { return new Date(v).toLocaleDateString("es-AR"); }
  catch { return String(v || ""); }
}
function fHora(v){
  try { return new Date(v).toLocaleTimeString("es-AR",{hour:"2-digit",minute:"2-digit"}); }
  catch { return ""; }
}
function todayISO(){
  return new Date().toISOString().split("T")[0];
}
function monthLabelFromDate(dateStr){
  const d = new Date(dateStr + "T00:00:00");
  // IMPORTANTE: esto te lo da SIEMPRE en español (si no, no pasaría por acá)
  return d.toLocaleString("es-AR",{month:"long",year:"numeric"}).toLowerCase();
}

// Convierte "January 2026" / "january 2026" / "enero 2026" / "enero de 2026" -> "enero de 2026"
function normalizeMonthLabel(label){
  const s = String(label || "").trim().toLowerCase();

  const map = {
    "january":"enero",
    "february":"febrero",
    "march":"marzo",
    "april":"abril",
    "may":"mayo",
    "june":"junio",
    "july":"julio",
    "august":"agosto",
    "september":"septiembre",
    "october":"octubre",
    "november":"noviembre",
    "december":"diciembre"
  };

  const mEn = s.match(/^(january|february|march|april|may|june|july|august|september|october|november|december)[,\s]+(\d{4})$/);
  if(mEn) return `${map[mEn[1]]} de ${mEn[2]}`;

  const mEs = s.match(/^(enero|febrero|marzo|abril|mayo|junio|julio|agosto|septiembre|octubre|noviembre|diciembre)(?:\s+de)?\s+(\d{4})$/);
  if(mEs) return `${mEs[1]} de ${mEs[2]}`;

  // Si viene "january 2026 — algo raro", devolvemos lo que haya
  return s;
}

// ===== Borrado local por índice =====
function getDeleted(){
  return JSON.parse(localStorage.getItem("deletedRows")||"[]");
}
function markDeleted(id){
  const d=getDeleted();
  if(!d.includes(id)){ d.push(id); }
  localStorage.setItem("deletedRows",JSON.stringify(d));
  cargar();
}

// ===== no cargar a futuro =====
function setDateLimits(){
  fecha.max = todayISO();
}

// ===== Selector % coloreado =====
function syncPctUI(){
  porcentaje.classList.remove("p50","p100");
  if(String(porcentaje.value).includes("50")) porcentaje.classList.add("p50");
  else porcentaje.classList.add("p100");
}
porcentaje?.addEventListener?.("change", syncPctUI);

// ===== Login =====
function doLogin(){
  error.textContent = "";
  fetch(`${API}?action=login&email=${encodeURIComponent(email.value)}&clave=${encodeURIComponent(clave.value)}`)
    .then(r=>r.json())
    .then(d=>{
      if(!d.ok){ error.textContent=d.error || "Credenciales inválidas"; return; }
      usuario.value=d.email;
      loginBox.style.display="none";
      app.style.display="block";
      setDateLimits();
      if(!fecha.value) fecha.value = todayISO();
      syncPctUI();
      cargar();
    })
    .catch(()=> error.textContent="No se pudo conectar al servidor.");
}
function doRegister(){
  error.textContent = "";
  fetch(`${API}?action=register&email=${encodeURIComponent(email.value)}&clave=${encodeURIComponent(clave.value)}`)
    .then(r=>r.json())
    .then(d=> error.textContent = d.ok ? "Usuario registrado" : (d.error || "Error al registrar"))
    .catch(()=> error.textContent="No se pudo conectar al servidor.");
}
function logout(){
  app.style.display="none";
  loginBox.style.display="flex";
}

// ===== Guardar =====
function guardar(){
  if(!usuario.value) return alert("No hay usuario logueado.");
  if(!fecha.value) return alert("Ingresá una fecha.");

  const hoy = new Date(todayISO() + "T00:00:00");
  const f = new Date(fecha.value + "T00:00:00");
  if(f > hoy) return alert("No se pueden cargar horas a futuro.");

  if(!desde.value || !hasta.value) return alert("Completá desde/hasta.");

  const h=(new Date(`1970-01-01T${hasta.value}`)-new Date(`1970-01-01T${desde.value}`))/3600000;
  if(!(h>0)) return alert("Horario inválido.");

  const sug = (sugerencia.value || "").trim();

  fetch(`${API}?action=cargarHoras&email=${encodeURIComponent(usuario.value)}&fecha=${encodeURIComponent(fecha.value)}&desde=${encodeURIComponent(desde.value)}&hasta=${encodeURIComponent(hasta.value)}&horas=${encodeURIComponent(h)}&porcentaje=${encodeURIComponent(porcentaje.value)}&sugerencia=${encodeURIComponent(sug)}&tk=${encodeURIComponent(tk.value||"")}`)
    .then(r=>r.json().catch(()=>({ok:true})))
    .then(()=> cargar())
    .catch(()=> alert("No se pudo guardar. Revisá la conexión."));
}

// ===== Barra de disponibilidad (ARREGLADA) =====
function setDisponibilidadUI(mesRef, totalMes){
  availBox.style.display = mesRef ? "block" : "none";
  if(!mesRef) return;

  const usado = Math.max(0, Number(totalMes)||0);
  const restante = Math.max(0, TOPE_MENSUAL - usado);
  const pct = Math.min(100, (usado/TOPE_MENSUAL)*100);

  availTitle.textContent = `Disponibilidad — ${mesRef}`;
  availRight.textContent = `${usado} / ${TOPE_MENSUAL} hs`;
  availSub.textContent = `Te quedan ${restante} hs para cargar este mes.`;

  progFill.style.width = pct + "%";

  prog.classList.remove("warn","danger");
  if(usado >= 26) prog.classList.add("danger");
  else if(usado >= 16) prog.classList.add("warn");
}

// ===== Badge porcentaje =====
function pctBadge(pct){
  const p = String(pct || "").trim();
  if(!p) return `<span class="badge none">sin %</span>`;
  const is50 = p.includes("50");
  const cls = is50 ? "badge p50" : "badge p100";
  return `<span class="${cls}">${p}</span>`;
}
function rowClassByPct(pct){
  const p = String(pct||"").trim();
  if(p.includes("50")) return "p50";
  if(p.includes("100")) return "p100";
  return "p100"; // default visual si está vacío
}

// ===== Listado =====
function cargar(){
  if(!usuario.value) return;

  fetch(`${API}?action=listar&email=${encodeURIComponent(usuario.value)}`)
    .then(r=>r.json())
    .then(data=>{
      listado.innerHTML="";
      const deleted=getDeleted();

      // Mes activo según la fecha elegida (español)
      const mesRef = fecha.value ? normalizeMonthLabel(monthLabelFromDate(fecha.value)) : null;

      const porMes={};
      let totalMesRef=0;

      data.forEach((r,i)=>{
        if(deleted.includes(i)) return;

        const mes = normalizeMonthLabel(r[9] || "");
        porMes[mes]=porMes[mes]||[];
        porMes[mes].push({r,id:i, mes});
      });

      Object.keys(porMes).forEach(m=>{
        let th=0, tkSum=0;

        porMes[m].forEach(o=>{
          th += Number(o.r[6]) || 0;
          tkSum += Number(o.r[10]) || 0;
        });

        if(mesRef && m === mesRef) totalMesRef = th;

        listado.innerHTML += `<div class="mes">${m}</div>`;

        porMes[m].forEach(o=>{
          const r=o.r;

          // r[7]=porcentaje, r[8]=sugerencia, r[10]=TK
          const pct = (r[7] && String(r[7]).trim()) ? String(r[7]).trim() : "";
          const sug = (r[8] || "").trim();
          const rowCls = rowClassByPct(pct);

          // IMPORTANTE: tu GAS a veces guarda el mes (r[9]) en inglés
          // Lo de abajo se muestra todo en español igual.
          listado.innerHTML += `
            <div class="registro ${rowCls}">
              <div>
                <div class="mainline">
                  <b>${fFecha(r[3])}</b> · ${fHora(r[4])} a ${fHora(r[5])}
                  · ${r[6]} hs · ${Number(r[10])||0} TK
                  ${pctBadge(pct)}
                </div>
                ${sug ? `<small>${sug}</small>` : ``}
              </div>
              <button title="Poner este registro en 0 (no se suma)" onclick="markDeleted(${o.id})">✖</button>
            </div>`;
        });

        listado.innerHTML += `<div class="resumen">Total mes: ${th} hs · ${tkSum} TK</div>`;
      });

      // ===== FIX clave: antes se te quedaba en 0 porque mesRef no matcheaba con la key del listado =====
      // Ahora ambos están normalizados y coinciden -> vuelve la barra.
      setDisponibilidadUI(mesRef, totalMesRef);
    })
    .catch(()=> {
      listado.innerHTML = "<b>No se pudo cargar el listado.</b>";
    });
}

// Inicial
setDateLimits();
syncPctUI();
</script>

</body>
</html>
