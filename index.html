<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Horas Extras</title>

<style>
:root{
  --azul:#0a1a2f;
  --azul-claro:#eef3fb;
  --verde:#c7f5cf;
  --verde-fuerte:#48b86a;
  --rosa:#ffd6df;
  --rosa-fuerte:#ff6b8a;
  --rojo:#e74c3c;
}

*{box-sizing:border-box;font-family:Arial,sans-serif}
body{margin:0;background:var(--azul-claro)}

button{cursor:pointer}

/* LOGIN */
#loginBox{
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
}
.login-card{
  background:#fff;
  width:380px;
  padding:30px;
  border-radius:16px;
  box-shadow:0 10px 30px rgba(0,0,0,.15);
  text-align:center;
}
.login-card input{
  width:100%;
  padding:12px;
  margin-bottom:12px;
  border-radius:8px;
  border:1px solid #ccc;
}
.login-card button{
  width:100%;
  padding:12px;
  background:var(--azul);
  color:#fff;
  border:none;
  border-radius:8px;
}
.login-card span{color:#1e5eff;cursor:pointer}
#error{color:red;margin-top:10px}

/* APP */
#app{display:none;padding:25px}

.topbar{
  display:flex;
  justify-content:flex-end;
  margin-bottom:15px;
}
.btn-logout{
  background:var(--azul);
  color:#fff;
  border:none;
  padding:10px 18px;
  border-radius:999px;
}

.card{
  background:#fff;
  border-radius:16px;
  padding:20px;
  margin-bottom:20px;
}

.form-row{
  display:grid;
  grid-template-columns:2fr 1.3fr repeat(4,1fr) 1.2fr auto;
  gap:10px;
  align-items:center;
}
.form-row input,
.form-row select{
  padding:10px;
  border-radius:10px;
  border:1px solid #cdd7f0;
}
.btn-guardar{
  background:var(--azul);
  color:#fff;
  border:none;
  padding:12px 28px;
  border-radius:12px;
  font-weight:bold;
}

textarea{
  width:100%;
  min-height:80px;
  margin-top:10px;
  padding:12px;
  border-radius:12px;
  border:1px solid #cdd7f0;
}

/* DISPONIBILIDAD */
.disponibilidad{
  margin-top:15px;
}
.barra{
  height:14px;
  background:#e5ecf6;
  border-radius:999px;
  overflow:hidden;
}
.barra > div{
  height:100%;
  background:var(--verde-fuerte);
  width:0%;
  transition:.3s;
}
.barra.roja > div{background:var(--rojo)}
.resumen-dispo{
  display:flex;
  justify-content:space-between;
  font-weight:bold;
  margin-top:6px;
}

/* LISTADO */
.mes{
  background:var(--verde);
  padding:10px;
  border-radius:12px;
  text-align:center;
  font-weight:bold;
  margin-bottom:10px;
}
.registro{
  background:#ecfff0;
  padding:12px;
  border-radius:12px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:8px;
}
.registro[data-pct="50%"]{
  border-left:6px solid var(--rosa-fuerte);
}
.registro[data-pct="100%"]{
  border-left:6px solid var(--verde-fuerte);
}
.badge{
  font-size:12px;
  padding:4px 10px;
  border-radius:999px;
  font-weight:bold;
}
.badge.verde{
  background:var(--verde);
  color:#1c6b3c;
}
.badge.rosa{
  background:var(--rosa);
  color:#b0003a;
}
.btn-borrar{
  background:none;
  border:none;
  color:red;
  font-size:18px;
}
.total-mes{
  text-align:right;
  font-weight:bold;
  margin-top:8px;
}
</style>
</head>

<body>

<div id="loginBox">
  <div class="login-card">
    <h2>Bienvenido</h2>
    <p>Ingresá para gestionar tus horas extras</p>
    <input id="email" placeholder="email">
    <input id="clave" type="password" placeholder="clave">
    <button onclick="doLogin()">Iniciar sesión</button>
    <p>¿No tenés cuenta? <span onclick="doRegister()">Registrate</span></p>
    <div id="error"></div>
  </div>
</div>

<div id="app">

  <div class="topbar">
    <button class="btn-logout" onclick="logout()">Cerrar sesión</button>
  </div>

  <div class="card">
    <div class="form-row">
      <input id="usuario" disabled>
      <input type="date" id="fecha">
      <select id="desde"></select>
      <select id="hasta"></select>
      <input id="tk" placeholder="TK">
      <select id="porcentaje">
        <option value="100%">100%</option>
        <option value="50%">50%</option>
      </select>
      <button class="btn-guardar" onclick="guardar()">Guardar</button>
    </div>

    <textarea id="sugerencia" maxlength="50"
      placeholder="Sugerencias (hasta 50 palabras)"></textarea>

    <div class="disponibilidad">
      <h3 id="tituloMes"></h3>
      <div class="barra" id="barra"><div></div></div>
      <div class="resumen-dispo">
        <span id="restante"></span>
        <span id="totalMes"></span>
      </div>
    </div>
  </div>

  <div class="card" id="listado"></div>

</div>

<script>
const API="https://script.google.com/macros/s/AKfycbyiFERs6AduXngSs4XnY1CwzTPJjtqv5G-dFut2GqBtmPwjZh5HnO1dE_s3jIYpSaUXHQ/exec";
const LIMITE=30;

const desde=document.getElementById("desde");
const hasta=document.getElementById("hasta");
const porcentajeSelect=document.getElementById("porcentaje");

/* HORARIOS EN MULTIPLOS DE 10 */
function cargarHoras(){
  for(let h=0;h<24;h++){
    for(let m=0;m<60;m+=10){
      const v=`${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`;
      desde.innerHTML+=`<option>${v}</option>`;
      hasta.innerHTML+=`<option>${v}</option>`;
    }
  }
}
cargarHoras();

/* LOGIN */
function doLogin(){
  fetch(`${API}?action=login&email=${email.value}&clave=${clave.value}`)
  .then(r=>r.json()).then(d=>{
    if(!d.ok){error.textContent=d.error;return}
    usuario.value=d.email;
    loginBox.style.display="none";
    app.style.display="block";
    cargar();
  });
}
function doRegister(){
  fetch(`${API}?action=register&email=${email.value}&clave=${clave.value}`)
  .then(r=>r.json()).then(d=>error.textContent=d.ok?"Usuario creado":d.error);
}
function logout(){
  app.style.display="none";
  loginBox.style.display="flex";
}

/* GUARDAR */
function guardar(){
  const h1=new Date(`1970-01-01T${desde.value}`);
  const h2=new Date(`1970-01-01T${hasta.value}`);
  let horas=(h2-h1)/3600000;
  if(horas<=0){alert("Horario inválido");return}

  const factor=porcentajeSelect.value==="100%"?1:0.5;
  const horasCalc=horas*factor;

  fetch(`${API}?action=cargarHoras
  &email=${usuario.value}
  &fecha=${fecha.value}
  &desde=${desde.value}
  &hasta=${hasta.value}
  &horas=${horasCalc}
  &porcentaje=${porcentajeSelect.value}
  &sugerencia=${sugerencia.value}
  &tk=${tk.value}`)
  .then(()=>cargar());
}

/* LISTADO */
function cargar(){
  fetch(`${API}?action=listar&email=${usuario.value}`)
  .then(r=>r.json()).then(data=>{
    listado.innerHTML="";
    let total=0,tkTotal=0;

    const mes=new Date().toLocaleString("es-AR",{month:"long",year:"numeric"});
    tituloMes.textContent=`Disponibilidad — ${mes}`;

    data.forEach(r=>{
      total+=Number(r[6])||0;
      tkTotal+=Number(r[10])||0;

      const pct=r[7]||"100%";
      listado.innerHTML+=`
      <div class="registro" data-pct="${pct}">
        <div>
          <b>${r[3]}</b> · ${r[4]} a ${r[5]} · ${r[6]} hs · TK ${r[10]||"-"}
        </div>
        <span class="badge ${pct==="100%"?"verde":"rosa"}">${pct}</span>
        <button class="btn-borrar" onclick="borrar(${r[0]})">✖</button>
      </div>`;
    });

    const pctBarra=Math.min(total/LIMITE*100,100);
    barra.firstElementChild.style.width=pctBarra+"%";
    barra.className="barra"+(total>=26?" roja":"");

    restante.textContent=`Te quedan ${(LIMITE-total).toFixed(1)} hs`;
    totalMes.textContent=`${total.toFixed(1)} / ${LIMITE} hs`;
    listado.innerHTML+=`<div class="total-mes">Total mes: ${total.toFixed(1)} hs · ${tkTotal} TK</div>`;
  });
}
</script>

</body>
</html>
