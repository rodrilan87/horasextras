<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Horas Extras</title>

<!--
  Horas Extras (index.html Ãºnico)
  - Vista Usuario: carga, listado, barra disponibilidad (cap 30 hs)
  - Vista AuditorÃ­a: (admin y jefe) resumen por mes + detalle por mes
  - Panel Admin: (solo admin) gestiÃ³n usuarios + cortes mensuales + bloqueo sitio/registro + backup/import

  NOTA IMPORTANTE:
  Este front depende de un Apps Script (codigo.gs) que exponga acciones:
  - estadoPublico, register, login, config, ping
  - cargarHoras, listar
  - auditoriaResumen, auditoriaDetalle
  - adminListUsuarios, adminCrearUsuario, adminSetRol, adminSetActivo
  - listarCortes, setCortes
  - adminEstadoGet, adminEstadoSet
  - adminBackup, adminImport

  VersiÃ³n UI: 2026-01-18r2
-->

<style>
:root{
  --azul:#0a1a2f;
  --azul-2:#0b2340;
  --azul-claro:#eef3fb;

  --verde:#c7f5cf;
  --verde-2:#36b37e;

  --rosa:#ffd1dc;
  --rosa-2:#ff4d7d;

  --gris:#e9eef7;
  --texto:#0b1220;
  --muted:#6b7280;

  --card:#ffffff;
  --shadow:0 12px 30px rgba(0,0,0,.10);
  --radius:16px;
}

*{box-sizing:border-box;font-family:Arial,system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
body{margin:0;background:var(--azul-claro);color:var(--texto)}
a{color:#1e5eff;text-decoration:none}
button{cursor:pointer}
small{color:var(--muted)}

/* ===== Login ===== */
#loginBox{
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  padding:24px;
}
.login-card{
  background:var(--card);
  width:min(520px,100%);
  padding:30px;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  text-align:center;
}
.login-card input{
  width:100%;
  padding:12px;
  margin-bottom:12px;
  border-radius:10px;
  border:1px solid #cbd5e1;
  outline:none;
}
.login-card button{
  width:100%;
  padding:12px;
  background:var(--azul);
  color:#fff;
  border:none;
  border-radius:10px;
}
.login-card .row{
  display:flex;
  gap:10px;
  margin-top:10px;
  flex-wrap:wrap;
  justify-content:center;
}
.btn-sec{
  background:#fff;
  border:1px solid #d7e3f5;
  color:var(--azul);
  padding:10px 12px;
  border-radius:10px;
  font-weight:800;
}
.btn-sec:hover{background:#f6f9ff}
.link{margin-top:10px;font-size:14px}
.link span{color:#1e5eff;cursor:pointer;font-weight:800}
#error{color:#b91c1c;margin-top:10px;min-height:18px;white-space:pre-wrap}

/* ===== App ===== */
#app{display:none;padding:25px}
.card{
  background:var(--card);
  border-radius:var(--radius);
  padding:20px;
  margin-bottom:20px;
  box-shadow:var(--shadow);
}
.topbar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
  flex-wrap:wrap;
  margin-bottom:15px;
}

.pill{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:8px 12px;
  border-radius:999px;
  border:1px solid #d7e3f5;
  background:#fff;
  font-weight:800;
}
.pill small{font-weight:700}

.btn-logout{
  background:var(--azul);
  color:#fff;
  border:none;
  padding:10px 16px;
  border-radius:999px;
  box-shadow:0 10px 24px rgba(10,26,47,.25);
}
.btn-logout:hover{background:var(--azul-2)}

.btn-panel{
  background:#fff;
  color:var(--azul);
  border:1px solid #d7e3f5;
  padding:10px 14px;
  border-radius:999px;
  font-weight:900;
}
.btn-panel:hover{background:#f6f9ff}

.form-row{
  display:grid;
  grid-template-columns: 1.2fr .9fr .8fr .8fr .8fr .9fr 1fr;
  gap:10px;
  align-items:center;
}
@media (max-width: 1100px){
  .form-row{grid-template-columns: 1fr 1fr 1fr; }
}
.input, select, textarea{
  padding:12px;
  border-radius:12px;
  border:1px solid #cbd5e1;
  outline:none;
  background:#fff;
}
#usuario{background:#f3f6fb}

.btn-guardar{
  background:var(--azul);
  color:#fff;
  border:none;
  border-radius:14px;
  padding:12px 16px;
  font-weight:900;
  min-height:44px;
}
.btn-guardar:hover{background:var(--azul-2)}
.btn-guardar:disabled{opacity:.45;cursor:not-allowed}

textarea{
  width:100%;
  min-height:110px;
  margin-top:10px;
  resize:vertical;
}

.porcentaje-100{border:2px solid rgba(54,179,126,.35); background:rgba(54,179,126,.08)}
.porcentaje-50{border:2px solid rgba(255,77,125,.35); background:rgba(255,77,125,.08); color:#7a0b2a}

.hr{height:1px;background:#e6edf7;margin:14px 0}

/* ===== Barra disponibilidad ===== */
.bar-card{margin-top:12px;padding:16px;border-radius:14px;border:1px solid #d7e3f5;background:#fff}
.bar-head{display:flex;justify-content:space-between;align-items:flex-end;gap:10px;flex-wrap:wrap}
.bar-title{font-size:28px;font-weight:900}
.bar-sub{margin-top:6px;color:var(--muted)}
.progress{margin-top:14px;width:100%;height:16px;background:var(--gris);border-radius:999px;overflow:hidden;border:1px solid #d7e3f5}
.progress > div{height:100%;width:0%;transition:width .25s ease}
.p-green{background:var(--verde-2)}
.p-yellow{background:#f4b400}
.p-red{background:#ef4444}

/* ===== Listado ===== */
.toolbar{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
.toggle{display:flex;gap:8px;align-items:center;padding:10px 12px;border-radius:999px;border:1px solid #d7e3f5;background:#fff}
.toggle input{transform:scale(1.2)}
.badge{display:inline-flex;align-items:center;justify-content:center;min-width:54px;padding:6px 10px;border-radius:999px;font-weight:900;font-size:12px;border:1px solid transparent}
.badge-100{background:rgba(54,179,126,.14);color:#0b5b3d;border-color:rgba(54,179,126,.35)}
.badge-50{background:rgba(255,77,125,.14);color:#7a0b2a;border-color:rgba(255,77,125,.35)}

.mes{background:var(--verde);padding:12px;border-radius:12px;font-weight:900;text-align:center;margin-top:18px;text-transform:lowercase}
.registro{background:#ecfff0;padding:14px;border-radius:14px;margin-top:10px;display:flex;justify-content:space-between;align-items:center;gap:14px;border-left:6px solid rgba(54,179,126,.55)}
.registro.p50{border-left-color: rgba(255,77,125,.60)}
.registro .left{flex:1;display:flex;gap:14px;align-items:flex-start;justify-content:space-between}
.registro .meta{flex:1}
.registro button{border:none;background:transparent;color:#ef4444;font-size:22px;padding:6px 10px;border-radius:10px}
.registro button:hover{background:rgba(239,68,68,.08)}

.resumen{margin-top:10px;font-weight:900;text-align:right;font-size:18px}
.resumen small{font-weight:600}

/* ===== Toast ===== */
.toast{position:fixed;right:18px;bottom:18px;z-index:9999;display:none;background:#0b1220;color:#fff;padding:12px 14px;border-radius:14px;box-shadow:0 14px 40px rgba(0,0,0,.25);max-width:420px}
.toast.ok{background:#0b3b2b}
.toast.err{background:#4a0b0b}
.undo{margin-top:10px;display:flex;gap:10px;align-items:center}
.btn-undo{background:#fff;border:1px solid rgba(255,255,255,.35);color:#fff;padding:8px 12px;border-radius:999px;font-weight:900}

/* ===== Panel (admin / jefe) ===== */
#panelBox{display:none}
.tabs{display:flex;gap:10px;flex-wrap:wrap}
.tab{padding:10px 12px;border-radius:999px;border:1px solid #d7e3f5;background:#fff;font-weight:900;cursor:pointer}
.tab.active{background:var(--azul);color:#fff;border-color:transparent}

.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width: 900px){.grid2{grid-template-columns:1fr}}

.table{width:100%;border-collapse:collapse;margin-top:10px}
.table th,.table td{border-bottom:1px solid #e6edf7;padding:10px;text-align:left;font-size:14px}
.table th{color:var(--muted);font-weight:900}

.chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.chip{padding:8px 10px;border-radius:999px;background:#fff;border:1px solid #d7e3f5;font-weight:900;cursor:pointer}
.chip.active{background:var(--azul);color:#fff;border-color:transparent}

.kpi{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
.kpi .pill{background:#fff}

.small-note{color:var(--muted);font-size:12px;margin-top:6px}

</style>
</head>

<body>

<div id="loginBox">
  <div class="login-card">
    <h2 style="margin:0 0 6px">Bienvenido</h2>
    <p style="margin:0 0 14px">IngresÃ¡ para gestionar tus horas extras</p>

    <div id="publicMsg" class="small-note" style="margin-bottom:10px"></div>

    <input id="email" placeholder="email" autocomplete="username">
    <input id="clave" type="password" placeholder="clave" autocomplete="current-password">

    <button id="btnLogin" onclick="doLogin()">Iniciar sesiÃ³n</button>

    <div class="row">
      <button class="btn-sec" type="button" onclick="prefillAdmin()">Acceso administrador</button>
      <button class="btn-sec" type="button" onclick="hardRefreshHelp()">Â¿Cache? Actualizar</button>
    </div>

    <div class="link" id="registerLink">Â¿No tenÃ©s cuenta?
      <span onclick="doRegister()">Registrate aquÃ­</span>
    </div>

    <div id="error"></div>
  </div>
</div>

<div id="app">

  <div class="topbar">
    <div class="pill">
      <span id="who">â€”</span>
      <small id="rolePill" style="opacity:.8">â€”</small>
    </div>

    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <button id="btnPanel" class="btn-panel" style="display:none" onclick="togglePanel(true)">Panel</button>
      <button class="btn-logout" onclick="logout()">Cerrar sesiÃ³n</button>
    </div>
  </div>

  <!-- PANEL ADMIN / JEFE -->
  <div id="panelBox" class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
      <div style="font-weight:900;font-size:18px">Panel de auditorÃ­a y administraciÃ³n</div>
      <button class="btn-sec" onclick="togglePanel(false)">Cerrar panel</button>
    </div>

    <div class="hr"></div>

    <div class="tabs" id="tabs"></div>

    <div id="tabContent" style="margin-top:12px"></div>
  </div>

  <!-- FORMULARIO USUARIO -->
  <div class="card">
    <div class="form-row">
      <input class="input" id="usuario" disabled>
      <input class="input" type="date" id="fecha">

      <div style="display:flex;gap:8px">
        <select class="input" id="desdeH" aria-label="Hora desde"></select>
        <select class="input" id="desdeM" aria-label="Min desde"></select>
      </div>

      <div style="display:flex;gap:8px">
        <select class="input" id="hastaH" aria-label="Hora hasta"></select>
        <select class="input" id="hastaM" aria-label="Min hasta"></select>
      </div>

      <input class="input" id="tk" placeholder="TK">

      <select class="input" id="porcentaje" onchange="pintarPorcentajeSelect()">
        <option value="100%">100%</option>
        <option value="50%">50%</option>
      </select>

      <button class="btn-guardar" id="btnGuardar" onclick="guardar()" disabled>Guardar</button>
    </div>

    <textarea id="sugerencia" maxlength="50" placeholder="Sugerencias (hasta 50 palabras)"></textarea>

    <div class="hr"></div>

    <div class="bar-card" id="barCard" style="display:none">
      <div class="bar-head">
        <div>
          <div class="bar-title" id="barTitle">Disponibilidad â€”</div>
          <div class="bar-sub" id="barSub"></div>
        </div>
        <div style="font-weight:900;font-size:18px" id="barRight"></div>
      </div>
      <div class="progress" aria-label="barra de progreso">
        <div id="barFill" class="p-green"></div>
      </div>
      <div class="small-note" id="barNote"></div>
    </div>
  </div>

  <div class="card">
    <div class="toolbar">
      <div class="toggle">
        <input type="checkbox" id="soloMes" onchange="cargar()">
        <label for="soloMes"><b>Ver solo mes activo</b></label>
      </div>
      <small>Tip: Enter = Guardar Â· Esc = limpiar TK y sugerencia</small>
    </div>

    <div id="listado"></div>
  </div>

</div>

<div id="toast" class="toast"></div>

<script>
// ================================
// CONFIG FRONT
// ================================

// âš ï¸ CambiÃ¡ SOLO este link cuando vuelvas a desplegar el Apps Script.
const API = "https://script.google.com/macros/s/AKfycbw293ze16Qn6-mlNLpmCiWYT4vHMYowwU92_8_LUg7MUMbKhdCmEPQGooEgl3RQj3Wd/exec";

const minuteStep = 10;
const MESES_ES = ["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"];

// SesiÃ³n
let SESSION = { token:"", email:"", rol:"", cap:30, cortes:{}, registroHabilitado:true, sitioBloqueado:false };
let keepAliveTimer = null;

// ================================
// Helpers fecha/hora
// ================================
function hoyISO(){
  const d = new Date();
  const z = new Date(d.getTime() - d.getTimezoneOffset()*60000);
  return z.toISOString().slice(0,10);
}
function isFutureDate(isoDate){
  return isoDate > hoyISO();
}
function fFechaISO(iso){
  // iso yyyy-mm-dd
  const d = new Date(iso+"T12:00:00");
  return d.toLocaleDateString("es-AR");
}
function fHoraHHMM(hhmm){
  return hhmm || "â€”";
}
function round1(n){
  return Math.round((Number(n)||0)*10)/10;
}
function escapeHtml(str){
  return String(str||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

// ===== Corte mensual (front) =====
function getCutForMonthIdx(idx){
  const mes = MESES_ES[idx];
  const v = SESSION.cortes?.[mes];
  const n = Number(v);
  if(Number.isFinite(n) && n>=1 && n<=31) return n;
  return 24;
}
function monthKeyByCutFromISO(isoDate){
  const d = new Date(isoDate+"T12:00:00");
  const idx = d.getMonth();
  const corte = getCutForMonthIdx(idx);
  const dia = d.getDate();
  // Mes por corte (mes "de sueldo"): 
  // - Si la fecha estÃ¡ hasta el dÃ­a de corte del mes, pertenece a ese mes.
  // - Si supera el corte, pasa al mes siguiente.
  let y = d.getFullYear();
  let m = idx;
  if(dia > corte){
    m = m + 1;
    if(m>11){ m=0; y=y+1; }
  }
  return `${MESES_ES[m]} de ${y}`;
}

// ================================
// Toast
// ================================
let undoTimer=null;
let undoData=null;
function showToast(msg,type="ok",withUndo=false){
  const t=document.getElementById("toast");
  t.className="toast "+(type==="ok"?"ok":"err");
  t.innerHTML = `
    <div style="font-weight:900">${escapeHtml(msg)}</div>
    ${withUndo ? `
      <div class="undo">
        <button class="btn-undo" onclick="undoDelete()">Deshacer</button>
        <small style="opacity:.85">10s</small>
      </div>
    ` : ``}
  `;
  t.style.display="block";
  clearTimeout(t._hide);
  t._hide=setTimeout(()=>{ t.style.display="none"; }, withUndo?10000:2200);
}

// ================================
// Cache / refresco
// ================================
function hardRefreshHelp(){
  showToast("Para borrar cache: Ctrl+F5 (Windows) o Cmd+Shift+R (Mac)", "ok");
}

function prefillAdmin(){
  email.value = (localStorage.getItem("last_admin") || "").trim();
  if(!email.value) email.value = "rodri@gmx.com"; // sugerencia editable
  clave.focus();
  showToast("Listo: completÃ¡ la clave y entrÃ¡.", "ok");
}

// ================================
// DeletedRows (local)
// ================================
function delKey(){
  return `deletedRows_${SESSION.email || ""}`;
}
function getDeleted(){
  return JSON.parse(localStorage.getItem(delKey())||"[]");
}
function setDeleted(arr){
  localStorage.setItem(delKey(),JSON.stringify(arr));
}
function markDeleted(id){
  const d=getDeleted();
  if(!d.includes(id)) d.push(id);
  setDeleted(d);

  undoData={id};
  clearTimeout(undoTimer);
  showToast("Registro eliminado (no suma).","ok",true);
  undoTimer=setTimeout(()=>{ undoData=null; }, 10000);

  cargar();
}
function undoDelete(){
  if(!undoData) return;
  const d=getDeleted().filter(x=>x!==undoData.id);
  setDeleted(d);
  undoData=null;
  showToast("Listo: se deshizo la eliminaciÃ³n.","ok");
  cargar();
}

// ================================
// Fetch helper
// ================================
async function jget(params){
  const u = new URL(API);
  Object.keys(params||{}).forEach(k=>u.searchParams.set(k, params[k]));
  u.searchParams.set('_', Date.now());
  const r = await fetch(u.toString(), { cache:'no-store' });
  return await r.json();
}
async function jpost(action, payload){
  const u = new URL(API);
  u.searchParams.set('action', action);
  u.searchParams.set('_', Date.now());
  const r = await fetch(u.toString(), {
    method:'POST',
    cache:'no-store',
    // IMPORTANTE: usamos text/plain para evitar preflight CORS (Apps Script + GitHub Pages).
    headers:{ 'Content-Type':'text/plain;charset=utf-8' },
    body: JSON.stringify(payload||{})
  });
  return await r.json();
}

// ================================
// Estado pÃºblico (oculta registro)
// ================================
async function loadPublicState(){
  try{
    const d = await jget({action:'estadoPublico'});
    if(d && d.ok){
      const reg = !!d.registroHabilitado;
      const bloq = !!d.sitioBloqueado;
      SESSION.registroHabilitado = reg;
      SESSION.sitioBloqueado = bloq;

      document.getElementById('registerLink').style.display = reg ? 'block' : 'none';
      const msg = document.getElementById('publicMsg');
      msg.textContent = bloq
        ? 'âš ï¸ El sitio estÃ¡ bloqueado por administraciÃ³n.'
        : (reg ? '' : 'ðŸ›ˆ El registro estÃ¡ deshabilitado. Si necesitÃ¡s usuario, pedilo a tu jefe/admin.');
    }
  }catch(e){
    // silencioso
  }
}
loadPublicState();

// ================================
// Login / Register
// ================================
async function doLogin(){
  error.textContent='';
  try{
    const d = await jget({action:'login', email: email.value, clave: clave.value});
    if(!d.ok){
      error.textContent = d.error || 'No se pudo iniciar sesiÃ³n';
      showToast(d.error || 'No se pudo iniciar sesiÃ³n','err');
      return;
    }

    // session
    SESSION.token = d.token;
    SESSION.email = d.email;
    SESSION.rol = d.rol;

    if(SESSION.rol === 'admin') localStorage.setItem('last_admin', SESSION.email);

    localStorage.setItem('he_token', SESSION.token);
    localStorage.setItem('he_email', SESSION.email);

    // cargar config (cap + cortes + estado)
    await refreshConfig();

    usuario.value = SESSION.email;
    who.textContent = SESSION.email;
    rolePill.textContent = SESSION.rol;

    // autocompletar TK
    const lastTK = localStorage.getItem('lastTK_'+SESSION.email) || '';
    tk.value = lastTK;

    // fecha hoy
    fecha.value = hoyISO();
    setMaxFechaHoy();

    loginBox.style.display='none';
    app.style.display='block';

    pintarPorcentajeSelect();
    validarFormulario();
    setupPanelTabs();
    cargar();

    startKeepAlive();

  }catch(e){
    error.textContent='Error de conexiÃ³n';
    showToast('Error de conexiÃ³n','err');
  }
}

async function doRegister(){
  error.textContent='';
  const em = String(email.value||'').trim().toLowerCase();
  if(!em.endsWith('@osde.com.ar')){
    showToast('Solo se permiten registros @osde.com.ar', 'err');
    error.textContent = 'Solo se permiten registros @osde.com.ar';
    return;
  }
  try{
    const d = await jget({action:'register', email: em, clave: clave.value});
    if(!d.ok){
      error.textContent = d.error || 'No se pudo registrar';
      showToast(d.error || 'No se pudo registrar','err');
      return;
    }
    error.textContent = 'Usuario registrado âœ…';
    showToast('Usuario registrado âœ…','ok');
  }catch(e){
    error.textContent='Error de conexiÃ³n';
    showToast('Error de conexiÃ³n','err');
  }
}

function logout(){
  stopKeepAlive();
  SESSION = { token:"", email:"", rol:"", cap:30, cortes:{}, registroHabilitado:true, sitioBloqueado:false };
  localStorage.removeItem('he_token');
  localStorage.removeItem('he_email');
  app.style.display='none';
  panelBox.style.display='none';
  loginBox.style.display='flex';
  showToast('SesiÃ³n cerrada.','ok');
  loadPublicState();
}

// auto-reanudar sesiÃ³n
(async function tryResume(){
  const t = localStorage.getItem('he_token') || '';
  const em = localStorage.getItem('he_email') || '';
  if(!t || !em) return;
  try{
    SESSION.token = t;
    SESSION.email = em;
    const cfg = await jget({action:'config', token: SESSION.token});
    if(!cfg.ok) return;
    SESSION.rol = cfg.rol;
    await refreshConfig(cfg);

    usuario.value = SESSION.email;
    who.textContent = SESSION.email;
    rolePill.textContent = SESSION.rol;

    // autocompletar TK
    const lastTK = localStorage.getItem('lastTK_'+SESSION.email) || '';
    tk.value = lastTK;

    fecha.value = hoyISO();
    setMaxFechaHoy();

    loginBox.style.display='none';
    app.style.display='block';

    pintarPorcentajeSelect();
    validarFormulario();
    setupPanelTabs();
    cargar();

    startKeepAlive();
  }catch(e){
    // no reanudar
  }
})();

async function refreshConfig(prefetched){
  const cfg = prefetched || await jget({action:'config', token: SESSION.token});
  if(!cfg.ok){
    showToast(cfg.error || 'SesiÃ³n expirada','err');
    logout();
    return;
  }
  SESSION.rol = cfg.rol;
  SESSION.cap = cfg.cap || 30;
  SESSION.cortes = cfg.cortes || {};
  SESSION.registroHabilitado = !!cfg.registroHabilitado;
  SESSION.sitioBloqueado = !!cfg.sitioBloqueado;

  document.getElementById('btnPanel').style.display = (SESSION.rol==='admin' || SESSION.rol==='jefe') ? 'inline-flex' : 'none';

  // nota en barra
  const note = document.getElementById('barNote');
  note.textContent = `Cap mensual: ${SESSION.cap} hs Â· Corte configurable por mes.`;
}

function startKeepAlive(){
  stopKeepAlive();
  keepAliveTimer = setInterval(async ()=>{
    if(!SESSION.token) return;
    try{
      const d = await jget({action:'ping', token: SESSION.token});
      if(!d.ok){
        showToast('SesiÃ³n expirada. VolvÃ© a iniciar sesiÃ³n.','err');
        logout();
      }
    }catch(e){
      // si falla momentÃ¡neo, no cerramos
    }
  }, 180000); // 3 min
}
function stopKeepAlive(){
  if(keepAliveTimer){ clearInterval(keepAliveTimer); keepAliveTimer=null; }
}

// ================================
// Selector hora/minuto
// ================================
function fillTimeSelects(){
  const hours=[...Array(24)].map((_,i)=>String(i).padStart(2,'0'));
  const minutes=[];
  for(let m=0;m<60;m+=minuteStep) minutes.push(String(m).padStart(2,'0'));

  [desdeH,hastaH].forEach(sel=>{
    sel.innerHTML = `<option value="">--</option>` + hours.map(h=>`<option value="${h}">${h}</option>`).join('');
  });
  [desdeM,hastaM].forEach(sel=>{
    sel.innerHTML = `<option value="">--</option>` + minutes.map(m=>`<option value="${m}">${m}</option>`).join('');
  });

  [desdeH,desdeM,hastaH,hastaM,fecha,tk,porcentaje,sugerencia].forEach(el=>{
    el.addEventListener('input', validarFormulario);
    el.addEventListener('change', validarFormulario);
  });
}
fillTimeSelects();

function getDesdeStr(){ return (desdeH.value && desdeM.value) ? `${desdeH.value}:${desdeM.value}` : ""; }
function getHastaStr(){ return (hastaH.value && hastaM.value) ? `${hastaH.value}:${hastaM.value}` : ""; }

function setMaxFechaHoy(){
  fecha.max = hoyISO();
}
fecha.addEventListener('change', ()=>{
  setMaxFechaHoy();
  validarFormulario();
  // al cambiar fecha, recalcular barra/mes activo
  cargar();
});

// ================================
// Porcentaje (estilo)
// ================================
function pintarPorcentajeSelect(){
  porcentaje.classList.remove('porcentaje-100','porcentaje-50');
  if(porcentaje.value==='50%') porcentaje.classList.add('porcentaje-50');
  else porcentaje.classList.add('porcentaje-100');
}

// ================================
// ValidaciÃ³n
// ================================
function horasEntre(desdeStr,hastaStr){
  const a=new Date(`1970-01-01T${desdeStr}:00`);
  const b=new Date(`1970-01-01T${hastaStr}:00`);
  return (b-a)/3600000;
}
function validarFormulario(){
  const d=fecha.value;
  const ds=getDesdeStr();
  const hs=getHastaStr();
  let ok=true;

  if(!d || !ds || !hs) ok=false;
  if(d && isFutureDate(d)) ok=false;

  if(ok){
    const h=horasEntre(ds,hs);
    if(!(h>0 && isFinite(h))) ok=false;
  }

  btnGuardar.disabled = !ok;
}

// ================================
// Guardar horas
// ================================
async function guardar(){
  const d=fecha.value;
  if(isFutureDate(d)){
    showToast('No se pueden cargar horas a futuro.','err');
    return;
  }

  const desde=getDesdeStr();
  const hasta=getHastaStr();
  const hReal=horasEntre(desde,hasta);
  if(!(hReal>0)){
    showToast('Horario invÃ¡lido.','err');
    return;
  }

  // guardar TK para autocompletar
  localStorage.setItem('lastTK_'+SESSION.email, tk.value || '');

  const payload = {
    token: SESSION.token,
    fecha: d,
    desde,
    hasta,
    horas: hReal,
    porcentaje: porcentaje.value,
    sugerencia: sugerencia.value,
    tk: tk.value
  };

  try{
    // Nota: usamos GET para evitar problemas intermitentes de POST/CORS en algunos navegadores.
    const res = await jget({action:'cargarHoras', ...payload});
    if(!res.ok){
      showToast(res.error || 'No se pudo guardar.','err');
      return;
    }
    showToast('Guardado âœ…','ok');
    sugerencia.value='';
    validarFormulario();
    await refreshConfig();
    cargar();
  }catch(e){
    showToast('No se pudo guardar. RevisÃ¡ conexiÃ³n.','err');
  }
}

// Atajos
addEventListener('keydown',(e)=>{
  if(app.style.display!=='block') return;

  if(e.key==='Enter'){
    if(document.activeElement && document.activeElement.tagName==='TEXTAREA') return;
    if(!btnGuardar.disabled) guardar();
  }
  if(e.key==='Escape'){
    tk.value='';
    sugerencia.value='';
    showToast('TK y sugerencia limpiados.','ok');
    validarFormulario();
  }
});

// ================================
// CÃ¡lculos 50%/100%
// ================================
function pesoPorcentaje(v){
  if(!v) return 1;
  if(String(v).includes('50')) return 0.5;
  return 1;
}
function labelPorcentaje(v){
  if(String(v).includes('50')) return '50%';
  return '100%';
}

// ================================
// Barra disponibilidad
// ================================
function pintarBarra(mesLabel, totalComputable){
  const cap = Number(SESSION.cap)||30;
  const left = Math.max(0, cap - totalComputable);
  const pct = Math.min(100, (totalComputable/cap)*100);

  barCard.style.display='block';
  barTitle.textContent = `Disponibilidad â€” ${mesLabel}`;
  barSub.textContent = `Te quedan ${round1(left)} hs para cargar este mes.`;
  barRight.textContent = `${round1(totalComputable)} / ${cap} hs`;

  barFill.style.width = pct + '%';
  barFill.classList.remove('p-green','p-yellow','p-red');
  if(totalComputable <= cap*0.5) barFill.classList.add('p-green');
  else if(totalComputable <= cap*0.85) barFill.classList.add('p-yellow');
  else barFill.classList.add('p-red');
}

// ================================
// Listado
// ================================
async function cargar(){
  if(!SESSION.token) return;

  try{
    const data = await jget({action:'listar', token: SESSION.token});
    if(!data.ok){
      showToast(data.error || 'No se pudo cargar el listado.','err');
      return;
    }

    listado.innerHTML='';
    const deleted = getDeleted();

    // Mes activo segÃºn fecha seleccionada + cortes
    const refISO = fecha.value || hoyISO();
    const mesRef = monthKeyByCutFromISO(refISO);

    // Agrupar por mesKey (servidor manda mesKey por cada registro)
    const porMes = {};
    (data.rows||[]).forEach((row)=>{
      if(deleted.includes(row.id)) return;
      const mes = String(row.mesKey || '').toLowerCase();
      if(!porMes[mes]) porMes[mes]=[];
      porMes[mes].push(row);
    });

    // Orden meses desc
    const mesesOrdenados = Object.keys(porMes).sort((a,b)=> parseMesAnio(b)-parseMesAnio(a));

    const solo = document.getElementById('soloMes').checked;
    const mesesParaMostrar = solo ? mesesOrdenados.filter(m=>m===mesRef) : mesesOrdenados;

    let totalMesComputable = 0;

    mesesParaMostrar.forEach(m=>{
      let thReal=0;
      let thComp=0;
      let tkSum=0;

      porMes[m].forEach(row=>{
        const horasReal = Number(row.horas)||0;
        const p = pesoPorcentaje(row.porcentaje);
        thReal += horasReal;
        thComp += horasReal * p;
        const tkVal = Number(row.tk)||0;
        tkSum += tkVal;
      });

      if(m===mesRef) totalMesComputable = round1(thComp);

      listado.innerHTML += `<div class="mes">${escapeHtml(m)}</div>`;

      porMes[m].forEach(row=>{
        const pLab = labelPorcentaje(row.porcentaje);
        const pClass = (pLab==='50%') ? 'p50' : '';
        const badgeClass = (pLab==='50%') ? 'badge-50' : 'badge-100';

        const tkVal = Number(row.tk)||0;
        const tkTxt = tkVal>0 ? `TK ${tkVal}` : 'TK -';
        const sug = row.sugerencia ? String(row.sugerencia) : '';

        listado.innerHTML += `
          <div class="registro ${pClass}">
            <div class="left">
              <div class="meta">
                <b>${fFechaISO(row.fecha)}</b> Â· ${fHoraHHMM(row.desde)} a ${fHoraHHMM(row.hasta)}
                Â· <b>${round1(row.horas)} hs</b> Â· ${tkTxt}
                ${sug ? `<br><small>${escapeHtml(sug)}</small>` : ``}
              </div>
              <div style="display:flex;gap:10px;align-items:center">
                <span class="badge ${badgeClass}">${pLab}</span>
                <button title="Eliminar (no suma)" onclick="markDeleted('${row.id}')">âœ–</button>
              </div>
            </div>
          </div>
        `;
      });

      listado.innerHTML += `
        <div class="resumen">
          Total mes: ${round1(thComp)} hs <small>(reales ${round1(thReal)} hs)</small> Â· ${tkSum} TK
        </div>
      `;
    });

    pintarBarra(mesRef, totalMesComputable);

  }catch(e){
    showToast('No se pudo cargar el listado.','err');
  }
}

function parseMesAnio(label){
  const s = String(label||'').replace(' de ',' ').trim().toLowerCase();
  const parts = s.split(/\s+/);
  const mes = parts[0];
  const anio = parseInt(parts[1]||'1970',10);
  const idx = MESES_ES.indexOf(mes);
  if(idx<0) return 0;
  return new Date(anio, idx, 1).getTime();
}

// ================================
// Panel: tabs & contenido
// ================================
function togglePanel(show){
  if(show){
    panelBox.style.display='block';
    // refrescar siempre
    renderActiveTab();
  }else{
    panelBox.style.display='none';
  }
}

let ACTIVE_TAB = 'auditoria';
function setupPanelTabs(){
  const tabs = [];
  // auditorÃ­a para admin y jefe
  if(SESSION.rol==='admin' || SESSION.rol==='jefe') tabs.push({id:'auditoria', label:'AuditorÃ­a'});
  if(SESSION.rol==='admin'){
    tabs.push({id:'usuarios', label:'Usuarios'});
    tabs.push({id:'cortes', label:'Cortes'});
    tabs.push({id:'sitio', label:'Sitio'});
    tabs.push({id:'backup', label:'Backup'});
  }

  const tEl = document.getElementById('tabs');
  tEl.innerHTML = tabs.map(t=>`<div class="tab" id="tab_${t.id}" onclick="setTab('${t.id}')">${t.label}</div>`).join('');

  if(!tabs.find(t=>t.id===ACTIVE_TAB)) ACTIVE_TAB = tabs[0]?.id || 'auditoria';
  highlightTab();
}

function setTab(id){
  ACTIVE_TAB = id;
  highlightTab();
  renderActiveTab();
}

function highlightTab(){
  document.querySelectorAll('.tab').forEach(el=>el.classList.remove('active'));
  const el = document.getElementById('tab_'+ACTIVE_TAB);
  if(el) el.classList.add('active');
}

async function renderActiveTab(){
  if(!(SESSION.rol==='admin' || SESSION.rol==='jefe')) return;

  if(ACTIVE_TAB==='auditoria') return renderAuditoria();
  if(ACTIVE_TAB==='usuarios') return renderUsuarios();
  if(ACTIVE_TAB==='cortes') return renderCortes();
  if(ACTIVE_TAB==='sitio') return renderSitio();
  if(ACTIVE_TAB==='backup') return renderBackup();
}

// ===== AuditorÃ­a =====
let AUDI = { months:[], summary:[], selectedMonth:'', details:[] };

function semaforoClass(pct){
  if(pct<=50) return 'p-green';
  if(pct<=85) return 'p-yellow';
  return 'p-red';
}

async function renderAuditoria(){
  const el = document.getElementById('tabContent');
  el.innerHTML = `<div style="font-weight:900">Cargando auditorÃ­a...</div>`;

  const res = await jget({action:'auditoriaResumen', token: SESSION.token});
  if(!res.ok){
    el.innerHTML = `<div style="color:#b91c1c;font-weight:900">${escapeHtml(res.error||'Error')}</div>`;
    return;
  }

  AUDI.months = res.months || [];
  AUDI.summary = res.summary || [];
  if(!AUDI.selectedMonth){
    // por defecto mes actual de facturaciÃ³n
    AUDI.selectedMonth = monthKeyByCutFromISO(hoyISO());
    if(!AUDI.months.includes(AUDI.selectedMonth) && AUDI.months.length) AUDI.selectedMonth = AUDI.months[0];
  }

  const chipsHtml = AUDI.months.map(m=>`<div class="chip ${m===AUDI.selectedMonth?'active':''}" onclick="selectAudMonth('${m.replaceAll("'","\\'")}')">${escapeHtml(m)}</div>`).join('');

  const rows = AUDI.summary.filter(x=> x.mesKey === AUDI.selectedMonth);

  const tableHtml = `
    <table class="table">
      <thead>
        <tr>
          <th>Usuario</th>
          <th>Hs (computables)</th>
          <th>Hs reales</th>
          <th>TK</th>
          <th>Tope</th>
        </tr>
      </thead>
      <tbody>
        ${rows.map(r=>{
          const pct = (Number(r.pct)||0);
          const cls = semaforoClass(pct);
          return `
            <tr>
              <td><b>${escapeHtml(r.email)}</b></td>
              <td>${round1(r.horasComp)}</td>
              <td>${round1(r.horasReal)}</td>
              <td>${Number(r.tkSum)||0}</td>
              <td>
                <div class="progress" style="height:12px">
                  <div class="${cls}" style="width:${Math.min(100,pct)}%"></div>
                </div>
                <div class="small-note">${round1(r.horasComp)} / ${r.cap} hs</div>
              </td>
            </tr>
          `;
        }).join('')}
      </tbody>
    </table>
  `;

  el.innerHTML = `
    <div style="font-weight:900;font-size:18px">AuditorÃ­a por mes</div>
    <div class="small-note">Se calcula con cortes configurables. El 50% suma 0,5 por hora.</div>

    <div class="chips">${chipsHtml || '<small>No hay datos aÃºn</small>'}</div>

    <div class="hr"></div>

    ${tableHtml}

    <div class="hr"></div>

    <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
      <button class="btn-sec" onclick="verDetalleAud()">Ver detalle del mes</button>
      <small>Mes seleccionado: <b>${escapeHtml(AUDI.selectedMonth||'â€”')}</b></small>
    </div>

    <div id="audDetalle" style="margin-top:12px"></div>
  `;
}

async function selectAudMonth(m){
  AUDI.selectedMonth = m;
  await renderAuditoria();
}

async function verDetalleAud(){
  const box = document.getElementById('audDetalle');
  box.innerHTML = `<div style="font-weight:900">Cargando detalle...</div>`;
  const res = await jget({action:'auditoriaDetalle', token: SESSION.token, mesKey: AUDI.selectedMonth});
  if(!res.ok){
    box.innerHTML = `<div style="color:#b91c1c;font-weight:900">${escapeHtml(res.error||'Error')}</div>`;
    return;
  }
  const rows = res.rows || [];
  if(!rows.length){ box.innerHTML = '<small>Sin registros en este mes.</small>'; return; }

  // agrupar por usuario
  const byUser = {};
  rows.forEach(r=>{
    if(!byUser[r.email]) byUser[r.email]=[];
    byUser[r.email].push(r);
  });

  let html = '';
  Object.keys(byUser).sort().forEach(email=>{
    html += `<div class="mes" style="background:#dfeaff">${escapeHtml(email)}</div>`;
    byUser[email].forEach(r=>{
      const pLab = labelPorcentaje(r.porcentaje);
      const badgeClass = (pLab==='50%') ? 'badge-50' : 'badge-100';
      html += `
        <div class="registro ${(pLab==='50%')?'p50':''}">
          <div class="left">
            <div class="meta">
              <b>${fFechaISO(r.fecha)}</b> Â· ${fHoraHHMM(r.desde)} a ${fHoraHHMM(r.hasta)}
              Â· <b>${round1(r.horas)} hs</b> Â· ${Number(r.tk)||0 ? ('TK '+Number(r.tk)) : 'TK -'}
              ${r.sugerencia ? `<br><small>${escapeHtml(r.sugerencia)}</small>` : ``}
            </div>
            <div style="display:flex;gap:10px;align-items:center">
              <span class="badge ${badgeClass}">${pLab}</span>
            </div>
          </div>
        </div>
      `;
    });
  });

  box.innerHTML = html;
}

// ===== Usuarios (admin) =====
async function renderUsuarios(){
  const el = document.getElementById('tabContent');
  el.innerHTML = `<div style="font-weight:900">Cargando usuarios...</div>`;

  const res = await jget({action:'adminListUsuarios', token: SESSION.token});
  if(!res.ok){
    el.innerHTML = `<div style="color:#b91c1c;font-weight:900">${escapeHtml(res.error||'Error')}</div>`;
    return;
  }

  const users = res.users || [];

  el.innerHTML = `
    <div style="font-weight:900;font-size:18px">GestiÃ³n de usuarios</div>
    <div class="small-note">RecomendaciÃ³n: crear usuarios desde acÃ¡ (mÃ¡s seguro que el link de registro).</div>

    <div class="hr"></div>

    <div class="grid2">
      <div class="card" style="margin:0">
        <div style="font-weight:900">Alta rÃ¡pida</div>
        <div class="small-note">Email + clave + rol</div>
        <div style="display:grid;gap:10px;margin-top:10px">
          <input class="input" id="nu_email" placeholder="email">
          <input class="input" id="nu_clave" placeholder="clave" type="password">
          <select class="input" id="nu_rol">
            <option value="usuario">usuario</option>
            <option value="jefe">jefe</option>
            <option value="admin">admin</option>
          </select>
          <button class="btn-guardar" onclick="adminCrearUsuario()">Crear usuario</button>
          <small>Tip: si el registro pÃºblico estÃ¡ deshabilitado, igual podÃ©s dar de alta desde acÃ¡.</small>
        </div>
      </div>

      <div class="card" style="margin:0">
        <div style="font-weight:900">Acciones</div>
        <div class="small-note">Cambiar rol / activar / desactivar</div>
        <div style="margin-top:10px">
          <button class="btn-sec" onclick="renderUsuarios()">Refrescar lista</button>
        </div>
      </div>
    </div>

    <div class="hr"></div>

    <table class="table">
      <thead>
        <tr>
          <th>Email</th>
          <th>Rol</th>
          <th>Activo</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        ${users.map(u=>{
          const act = u.activo ? 'SÃ­' : 'No';
          return `
            <tr>
              <td><b>${escapeHtml(u.email)}</b></td>
              <td>${escapeHtml(u.rol)}</td>
              <td>${act}</td>
              <td>
                <select class="input" style="padding:8px;border-radius:10px" onchange="adminSetRol('${u.email}', this.value)">
                  <option value="usuario" ${u.rol==='usuario'?'selected':''}>usuario</option>
                  <option value="jefe" ${u.rol==='jefe'?'selected':''}>jefe</option>
                  <option value="admin" ${u.rol==='admin'?'selected':''}>admin</option>
                </select>
                <button class="btn-sec" style="margin-left:8px" onclick="adminToggleActivo('${u.email}', ${u.activo?0:1})">${u.activo?'Desactivar':'Activar'}</button>
              </td>
            </tr>
          `;
        }).join('')}
      </tbody>
    </table>
  `;
}

async function adminCrearUsuario(){
  const em = String(document.getElementById('nu_email').value||'').trim().toLowerCase();
  const cl = String(document.getElementById('nu_clave').value||'');
  const rol = String(document.getElementById('nu_rol').value||'usuario');
  if(!em || !cl){ showToast('Email y clave son obligatorios.','err'); return; }

  const res = await jpost('adminCrearUsuario', { token: SESSION.token, email: em, clave: cl, rol });
  if(!res.ok){ showToast(res.error||'No se pudo crear usuario.','err'); return; }
  showToast('Usuario creado âœ…','ok');
  document.getElementById('nu_email').value='';
  document.getElementById('nu_clave').value='';
  renderUsuarios();
}

async function adminSetRol(email, rol){
  const res = await jpost('adminSetRol', { token: SESSION.token, email, rol });
  if(!res.ok){ showToast(res.error||'No se pudo cambiar rol.','err'); return; }
  showToast('Rol actualizado âœ…','ok');
}

async function adminToggleActivo(email, activo){
  const res = await jpost('adminSetActivo', { token: SESSION.token, email, activo: !!activo });
  if(!res.ok){ showToast(res.error||'No se pudo actualizar usuario.','err'); return; }
  showToast('Estado actualizado âœ…','ok');
  renderUsuarios();
}

// ===== Cortes (admin) =====
async function renderCortes(){
  const el = document.getElementById('tabContent');
  el.innerHTML = `<div style="font-weight:900">Cargando cortes...</div>`;

  const res = await jget({action:'listarCortes', token: SESSION.token});
  if(!res.ok){
    el.innerHTML = `<div style="color:#b91c1c;font-weight:900">${escapeHtml(res.error||'Error')}</div>`;
    return;
  }

  const cortes = res.cortes || SESSION.cortes || {};

  const inputs = MESES_ES.map(m=>{
    const v = Number(cortes[m]||24);
    return `
      <div class="pill" style="justify-content:space-between;width:100%">
        <div style="text-transform:capitalize">${m}</div>
        <input class="input" style="width:90px;padding:8px" type="number" min="1" max="31" id="corte_${m}" value="${v}">
      </div>
    `;
  }).join('');

  el.innerHTML = `
    <div style="font-weight:900;font-size:18px">Cortes mensuales</div>
    <div class="small-note">
      La fecha de corte define el <b>mes de cobro</b>. Por defecto, lo trabajado en un mes se cobra el <b>mes siguiente</b>.
      Si la fecha supera el corte, pasa a cobrarse <b>dos meses despuÃ©s</b>.
      <br>Ejemplo: si <b>enero cierra el 16</b>, entonces <b>01â€“16/01 â†’ febrero</b> y <b>17â€“31/01 â†’ marzo</b>.
    </div>

    <div class="hr"></div>

    <div class="grid2">${inputs}</div>

    <div class="hr"></div>

    <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
      <button class="btn-guardar" onclick="guardarCortes()">Guardar cortes</button>
      <button class="btn-sec" onclick="renderCortes()">Releer desde servidor</button>
      <small>Consejo: tras cambiar cortes, refrescÃ¡ auditorÃ­a para ver el recÃ¡lculo.</small>
    </div>
  `;
}

async function guardarCortes(){
  const cortes = {};
  MESES_ES.forEach(m=>{
    cortes[m] = Number(document.getElementById('corte_'+m).value||24);
  });
  const res = await jpost('setCortes', { token: SESSION.token, cortes });
  if(!res.ok){ showToast(res.error||'No se pudieron guardar los cortes.','err'); return; }
  showToast('Cortes guardados âœ…','ok');
  await refreshConfig();
  renderCortes();
}

// ===== Sitio (admin) =====
async function renderSitio(){
  const el = document.getElementById('tabContent');
  el.innerHTML = `<div style="font-weight:900">Cargando estado...</div>`;

  const res = await jget({action:'adminEstadoGet', token: SESSION.token});
  if(!res.ok){
    el.innerHTML = `<div style="color:#b91c1c;font-weight:900">${escapeHtml(res.error||'Error')}</div>`;
    return;
  }

  el.innerHTML = `
    <div style="font-weight:900;font-size:18px">Estado del sitio</div>
    <div class="small-note">Bloqueo general + habilitar/deshabilitar registro desde la web.</div>

    <div class="hr"></div>

    <div class="grid2">
      <div class="card" style="margin:0">
        <div style="font-weight:900">Bloqueo del sitio</div>
        <div class="small-note">Si estÃ¡ activo, solo pueden entrar admins.</div>
        <div style="margin-top:10px" class="toggle">
          <input type="checkbox" id="st_bloq" ${res.sitioBloqueado?'checked':''}>
          <label for="st_bloq"><b>Sitio bloqueado</b></label>
        </div>
      </div>

      <div class="card" style="margin:0">
        <div style="font-weight:900">Registro</div>
        <div class="small-note">Si estÃ¡ apagado, se oculta el link de registro.</div>
        <div style="margin-top:10px" class="toggle">
          <input type="checkbox" id="st_reg" ${res.registroHabilitado?'checked':''}>
          <label for="st_reg"><b>Registro habilitado</b></label>
        </div>
      </div>
    </div>

    <div class="hr"></div>

    <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
      <button class="btn-guardar" onclick="guardarEstadoSitio()">Guardar</button>
      <small>Los cambios aplican inmediatamente. Si alguien no lo ve, que haga Ctrl+F5.</small>
    </div>
  `;
}

async function guardarEstadoSitio(){
  const sitioBloqueado = !!document.getElementById('st_bloq').checked;
  const registroHabilitado = !!document.getElementById('st_reg').checked;
  const res = await jpost('adminEstadoSet', { token: SESSION.token, sitioBloqueado, registroHabilitado });
  if(!res.ok){ showToast(res.error||'No se pudo guardar.','err'); return; }
  showToast('Estado guardado âœ…','ok');
  await refreshConfig();
  // tambiÃ©n refresca el estado pÃºblico del login cuando alguien recargue
}

// ===== Backup (admin) =====
async function renderBackup(){
  const el = document.getElementById('tabContent');
  el.innerHTML = `
    <div style="font-weight:900;font-size:18px">Backup / Importar</div>
    <div class="small-note">Exporta un JSON con Usuarios, Horas, Estado y Cortes. Importar reemplaza el contenido (con cuidado).</div>

    <div class="hr"></div>

    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn-guardar" onclick="hacerBackup()">Generar backup</button>
      <button class="btn-sec" onclick="mostrarImport()">Importar backup</button>
    </div>

    <div id="backupOut" style="margin-top:12px"></div>
  `;
}

async function hacerBackup(){
  const out = document.getElementById('backupOut');
  out.innerHTML = `<div style="font-weight:900">Generando...</div>`;
  const res = await jget({action:'adminBackup', token: SESSION.token});
  if(!res.ok){ out.innerHTML = `<div style="color:#b91c1c;font-weight:900">${escapeHtml(res.error||'Error')}</div>`; return; }
  const json = JSON.stringify(res.backup||{}, null, 2);
  out.innerHTML = `
    <div style="font-weight:900">Backup listo</div>
    <textarea class="input" style="min-height:240px">${escapeHtml(json)}</textarea>
    <div class="small-note">CopiÃ¡ y guardÃ¡ este JSON en un archivo .txt.</div>
  `;
}

function mostrarImport(){
  const out = document.getElementById('backupOut');
  out.innerHTML = `
    <div style="font-weight:900">Importar backup</div>
    <div class="small-note">PegÃ¡ el JSON completo y confirmÃ¡. Esto reemplaza el contenido.</div>
    <textarea class="input" id="impJson" style="min-height:240px" placeholder="PegÃ¡ acÃ¡ el JSON..."></textarea>
    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
      <button class="btn-guardar" onclick="importarBackup()">Importar (reemplaza)</button>
      <button class="btn-sec" onclick="renderBackup()">Cancelar</button>
    </div>
  `;
}

async function importarBackup(){
  const txt = document.getElementById('impJson').value || '';
  let obj=null;
  try{ obj = JSON.parse(txt); }catch(e){ showToast('JSON invÃ¡lido.','err'); return; }
  const res = await jpost('adminImport', { token: SESSION.token, backup: obj });
  if(!res.ok){ showToast(res.error||'No se pudo importar.','err'); return; }
  showToast('Importado âœ…','ok');
  await refreshConfig();
  renderBackup();
}

// ================================
// Inicial
// ================================
setMaxFechaHoy();
pintarPorcentajeSelect();
validarFormulario();

</script>

</body>
</html>
