<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>OSDE - Panel Seguro</title>
    <style>
        :root { --osde: #00548f; --danger: #d9534f; }
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 12px; max-width: 600px; margin: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        input, button, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        button { background: var(--osde); color: white; border: none; font-weight: bold; cursor: pointer; }
        .badge-azul { background: var(--osde); color: white; padding: 6px 12px; border-radius: 20px; font-size: 13px; display: inline-block; margin: 4px; }
        .registro { border-left: 5px solid var(--osde); background: #f8faff; padding: 15px; margin-top: 10px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="card" id="login-box">
        <h2 style="color: var(--osde)">Ingreso Seguro</h2>
        <input type="email" id="email" placeholder="Email @osde.com.ar">
        <input type="password" id="pass" placeholder="Contrase√±a">
        <button onclick="login()">INGRESAR</button>
    </div>

    <div class="card hidden" id="panel-box">
        <h2 id="saludo"></h2>
        <div id="user-form">
            <input type="text" id="tk" placeholder="ID Ticket">
            <input type="number" id="hs" placeholder="Horas">
            <select id="mes">
                <option value="Enero">Enero 2026</option>
                <option value="Febrero">Febrero 2026</option>
            </select>
            <button onclick="cargar()">Cargar Horas</button>
        </div>

        <hr style="margin: 20px 0">
        
        <h3>Auditor√≠a de Horas</h3>
        <div id="badges"></div>
        <div id="lista"></div>
    </div>

    <script>
        const URL_API = "https://script.google.com/macros/s/AKfycbzKXpDmcxfYlFduTz4vI3lrhJQNqx_2KodissD_37io-kucnkvj2OjZrCaYv-6-CciS/exec"; // <-- REEMPLAZAR
        let userLogueado = "";
        let nombreLogueado = "";

        async function login() {
            const u = document.getElementById('email').value.toLowerCase().trim();
            const p = document.getElementById('pass').value;

            const res = await fetch(URL_API, {
                method: 'POST',
                body: JSON.stringify({type: "login", u: u, p: p})
            });
            const data = await res.json();

            if (data.status === "OK") {
                userLogueado = u;
                nombreLogueado = u.split('@')[0].toUpperCase();
                document.getElementById('login-box').classList.add('hidden');
                document.getElementById('panel-box').classList.remove('hidden');
                document.getElementById('saludo').innerText = "Bienvenido " + nombreLogueado;
                actualizarVista();
            } else {
                alert("Email o contrase√±a incorrectos");
            }
        }

        async function cargar() {
            const payload = {
                type: "carga",
                n: nombreLogueado,
                u: userLogueado,
                tk: document.getElementById('tk').value,
                h: document.getElementById('hs').value,
                mes: document.getElementById('mes').value
            };
            await fetch(URL_API, { method: 'POST', body: JSON.stringify(payload) });
            alert("Carga exitosa");
            actualizarVista();
        }

        async function actualizarVista() {
            const res = await fetch(URL_API + "?action=read");
            const filas = await res.json();
            const lista = document.getElementById('lista');
            const badges = document.getElementById('badges');
            lista.innerHTML = ""; badges.innerHTML = "";
            
            let sumas = {};

            filas.forEach(f => {
                if (f[0] === "DATA") {
                    const [tag, nom, em, mes, fec, tk, hs] = f;
                    const key = nom + " (" + mes + ")";
                    sumas[key] = (sumas[key] || 0) + parseFloat(hs);

                    const item = document.createElement('div');
                    item.className = "registro";
                    item.innerHTML = `<div><strong>${nom}</strong><br><small>${em}</small><br>TK: ${tk} | ${hs}hs</div>
                                      <button style="width:auto; background:none; color:red" onclick="borrar('${em}','${fec}','${hs}')">üóëÔ∏è</button>`;
                    lista.appendChild(item);
                }
            });

            for (let k in sumas) {
                const b = document.createElement('div');
                b.className = "badge-azul";
                b.innerText = `üîµ ${k}: ${sumas[k]}hs`;
                badges.appendChild(b);
            }
        }

        async function borrar(u, f, h) {
            if(!confirm("¬øBorrar?")) return;
            await fetch(URL_API, { method: 'POST', body: JSON.stringify({type:"borrar_registro", u:u, f:f, h:h}) });
            actualizarVista();
        }
    </script>
</body>
</html>
