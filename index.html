<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA OSDE</title>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; display: flex; justify-content: center; padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); width: 100%; max-width: 400px; }
        input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        button { width: 100%; padding: 10px; background: #2c3e50; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .oculto { display: none; }
    </style>
</head>
<body>
    <div id="auth" class="card">
        <h2>Ingreso OSDE</h2>
        <div id="login-form">
            <input type="email" id="l_email" placeholder="Email corporativo">
            <input type="password" id="l_pass" placeholder="Contraseña">
            <button onclick="app.login()">INGRESAR</button>
            <p onclick="app.toggle()" style="color:blue; cursor:pointer; text-align:center">Registrarse</p>
        </div>
        <div id="reg-form" class="oculto">
            <input type="text" id="r_name" placeholder="Nombre completo">
            <input type="email" id="r_email" placeholder="Email @osde.com.ar">
            <input type="password" id="r_pass" placeholder="Contraseña">
            <button onclick="app.register()" style="background: green;">CREAR CUENTA</button>
            <p onclick="app.toggle()" style="text-align:center; cursor:pointer">Volver</p>
        </div>
    </div>

    <div id="dash" class="card oculto">
        <h3 id="bienvenida"></h3>
        <input type="text" id="c_det" placeholder="¿Qué hiciste hoy?">
        <button onclick="app.save()" style="background: orange;">GUARDAR JORNADA</button>
        <button onclick="location.reload()" style="margin-top:10px; background: #999;">SALIR</button>
    </div>

    <script>
        const URL = "https://script.google.com/macros/s/AKfycbwxFZXkbBdKbFWNI5w1j0rs95n-OmOLRXC7izXoAh8U3q1abFVdPqt86hScKNBasusC/exec";

        const app = {
            user: null,
            toggle() { 
                document.getElementById('login-form').classList.toggle('oculto');
                document.getElementById('reg-form').classList.toggle('oculto');
            },
            async register() {
                const n = document.getElementById('r_name').value;
                const m = document.getElementById('r_email').value.toLowerCase().trim();
                const p = document.getElementById('r_pass').value;
                if(!m.endsWith("@osde.com.ar")) return alert("Solo @osde.com.ar");
                
                await fetch(URL, {
                    method: 'POST',
                    mode: 'no-cors', // Esto evita el error de CORS
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({type: "registro", n, m, p})
                });
                alert("Registrado. Intenta loguearte.");
                this.toggle();
            },
            async login() {
                const m = document.getElementById('l_email').value.toLowerCase().trim();
                const p = document.getElementById('l_pass').value;
                
                if(m === "rodri@gmx.com" && p === "1234") {
                    return this.entrar({n: "Admin", m});
                }

                try {
                    const res = await fetch(URL);
                    const db = await res.json();
                    const u = db.find(r => r[2] === m && String(r[3]) === String(p));
                    if(u) this.entrar({n: u[1], m: u[2]});
                    else alert("Usuario no encontrado.");
                } catch(e) { alert("Error de base de datos."); }
            },
            entrar(u) {
                this.user = u;
                document.getElementById('auth').classList.add('oculto');
                document.getElementById('dash').classList.remove('oculto');
                document.getElementById('bienvenida').innerText = "Hola, " + u.n;
            },
            async save() {
                await fetch(URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({
                        type: "carga", n: this.user.n, u: this.user.m, d: document.getElementById('c_det').value
                    })
                });
                alert("Guardado!");
                document.getElementById('c_det').value = "";
            }
        };
    </script>
</body>
</html>
