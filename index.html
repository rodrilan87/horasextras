<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA CONTROL OSDE</title>
    <style>
        :root { --navy: #003057; --sky: #0076BE; --orange: #E87722; --red: #dc3545; --green: #27ae60; }
        body { font-family: 'Segoe UI', sans-serif; background: #dfe4ea; padding: 15px; margin: 0; }
        .container { max-width: 900px; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .btn-salir { background: var(--red); color: white; border: none; padding: 8px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        
        .progreso-container { margin-bottom: 25px; font-size: 14px; }
        .bar-bg { background: #eee; height: 12px; border-radius: 10px; margin-top: 5px; overflow: hidden; }
        .bar-fill { height: 100%; width: 0%; transition: 1s; background: var(--green); }

        .grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        label { display: block; font-size: 14px; margin-bottom: 5px; font-weight: 500; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
        
        /* ESTILOS SEGÚN IMAGEN */
        .box-rosa { border: 2px solid #ff00ff66; padding: 10px; border-radius: 10px; background: #fffaff; }
        .box-verde { border: 2px solid #00ff0066; padding: 10px; border-radius: 10px; background: #fafffa; }
        .box-naranja { border: 2px solid var(--orange); padding: 10px; border-radius: 10px; }

        .btn-guardar { background: var(--orange); color: white; border: none; width: 100%; padding: 15px; border-radius: 8px; font-weight: bold; cursor: pointer; text-transform: uppercase; margin-top: 10px; }
        
        .oculto { display: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 13px; }
        th { text-align: left; padding: 10px; border-bottom: 2px solid #eee; background: #f8f9fa; }
        td { padding: 10px; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>

<div class="container">
    <div id="auth-section">
        <h2 style="text-align:center; color: var(--navy);">SISTEMA DE JORNADA</h2>
        <input type="email" id="l_email" placeholder="usuario@osde.com.ar">
        <input type="password" id="l_pass" placeholder="Contraseña" style="margin-top:10px;">
        <button class="btn-guardar" onclick="app.login()">Entrar</button>
    </div>

    <div id="main-app" class="oculto">
        <div class="header">
            <h2 id="saludo">Hola</h2>
            <button class="btn-salir" onclick="location.reload()">CERRAR SESIÓN</button>
        </div>

        <div class="progreso-container">
            <div style="display:flex; justify-content:space-between">
                <span>Horas consumidas este mes:</span>
                <b id="hs-txt">0 / 30hs</b>
            </div>
            <div class="bar-bg"><div id="hs-bar" class="bar-fill"></div></div>
        </div>

        <h3>Nueva Jornada</h3>
        <div class="grid">
            <div>
                <label>Fecha:</label>
                <input type="date" id="c_fecha">
            </div>
            <div class="box-rosa" style="grid-column: span 2; display: flex; gap: 10px;">
                <div style="flex:1"><label>Desde:</label><input type="time" id="c_desde"></div>
                <div style="flex:1"><label>Hasta:</label><input type="time" id="c_hasta"></div>
                <div style="flex:1"><label>Horas:</label><input type="number" id="c_hs" step="0.5"></div>
            </div>
        </div>

        <div class="grid">
            <div class="box-verde">
                <label>Tipo (%):</label>
                <select id="c_tipo"><option value="50">50%</option><option value="100">100%</option></select>
            </div>
            <div class="box-naranja" style="grid-column: span 2;">
                <label>Tarea / Ticket:</label>
                <input type="text" id="c_tk" placeholder="Descripción del ticket">
            </div>
        </div>

        <div style="margin-top:10px;">
            <label>Sugerencias (Máx 50 palabras):</label>
            <textarea id="c_sugerencia" rows="2" maxlength="300"></textarea>
        </div>

        <button class="btn-guardar" id="btn-save" onclick="app.save()">Guardar Jornada</button>

        <h3>Mis Registros</h3>
        <div id="historial"></div>
    </div>
</div>

<script>
    // REEMPLAZAR CON TU URL DE APPS SCRIPT
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxAdtPbH_oRza_aOXyyvM4d7PGZ35APimsr3OoIaL9EfnmaBqdJsJvlOxPjjJycPFUh/exec";

    const app = {
        user: null, db: [],

        async login() {
            const m = document.getElementById('l_email').value.toLowerCase().trim();
            const p = document.getElementById('l_pass').value;

            // EXCEPCIÓN RODRI@GMX.COM SEGÚN INSTRUCCIONES
            if ((m.endsWith("@osde.com.ar") || m === "rodri@gmx.com") && p !== "") {
                try {
                    const res = await fetch(WEB_APP_URL);
                    this.db = await res.json();
                    this.user = { n: m.split('@')[0], m: m };
                    document.getElementById('auth-section').classList.add('oculto');
                    document.getElementById('main-app').classList.remove('oculto');
                    document.getElementById('saludo').innerText = "Bienvenido, " + this.user.n;
                    this.render();
                } catch(e) { alert("Error al conectar con la base de datos."); }
            } else {
                alert("Email no autorizado.");
            }
        },

        async save() {
            const btn = document.getElementById('btn-save');
            const data = {
                type: "carga",
                n: this.user.n,
                u: this.user.m,
                fecha: document.getElementById('c_fecha').value,
                h: document.getElementById('c_hs').value,
                tk: document.getElementById('c_tk').value,
                p: document.getElementById('c_tipo').value,
                desde: document.getElementById('c_desde').value,
                hasta: document.getElementById('c_hasta').value,
                sugerencia: document.getElementById('c_sugerencia').value,
                mes: new Date().getMonth()
            };

            if(!data.fecha || !data.h || !data.tk) return alert("Completar campos obligatorios.");

            btn.innerText = "PROCESANDO...";
            btn.disabled = true;

            await fetch(WEB_APP_URL, {method:'POST', mode:'no-cors', body:JSON.stringify(data)});
            alert("¡Guardado!");
            location.reload();
        },

        render() {
            const mesActual = new Date().getMonth();
            const logs = this.db.filter(r => r[0] === "DATA" && r[2] === this.user.m && r[3] == mesActual);
            const totalHs = logs.reduce((s, r) => s + parseFloat(r[6] || 0), 0);
            
            document.getElementById('hs-txt').innerText = `${totalHs} / 30hs`;
            document.getElementById('hs-bar').style.width = Math.min((totalHs/30*100), 100) + "%";

            let h = `<table><thead><tr><th>Fecha</th><th>Tarea</th><th>Hs</th><th>Horario</th></tr></thead><tbody>`;
            logs.forEach(r => {
                h += `<tr><td>${r[4]}</td><td>${r[5]}</td><td>${r[6]} (${r[7]}%)</td><td>${r[8]} - ${r[9]}</td></tr>`;
            });
            document.getElementById('historial').innerHTML = h + "</tbody></table>";
        }
    }
</script>
</body>
</html>
