<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Sistema OSDE - Gesti√≥n de Horas</title>
    <style>
        /* CSS: DISE√ëO Y SEM√ÅFORO */
        :root { --osde: #00548f; --rojo: #d9534f; --verde: #5cb85c; }
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f9; padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 12px; max-width: 750px; margin: auto; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        /* SEM√ÅFORO */
        .semaforo { padding: 15px; border-radius: 8px; color: white; font-weight: bold; text-align: center; margin-bottom: 20px; }
        .verde { background: var(--verde); }
        .rojo { background: var(--rojo); }

        /* FORMULARIO */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        input, select, textarea, button { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        button { background: var(--osde); color: white; border: none; font-weight: bold; cursor: pointer; }
        
        /* AUDITOR√çA */
        .audit-item { background: #f9f9f9; border-left: 5px solid var(--osde); padding: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border-radius: 4px; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="card" id="login-section">
        <h2 style="color:var(--osde)">Ingreso Seguro OSDE</h2>
        <input type="email" id="email" placeholder="Usuario (@osde.com.ar / @gmx.com)">
        <input type="password" id="pass" placeholder="Contrase√±a">
        <button onclick="ejecutarLogin()">INGRESAR</button>
    </div>

    <div class="card hidden" id="panel-principal">
        <h2 id="saludo">Panel de Gesti√≥n</h2>
        
        <div id="semaforo" class="semaforo verde">Horas este mes: 0hs</div>

        <div id="formulario-carga">
            <div class="grid">
                <div><label>Fecha:</label><input type="date" id="fecha-h"></div>
                <div><label>Ticket ID:</label><input type="text" id="tk-h" placeholder="N¬∞ Ticket"></div>
                <div><label>Desde:</label><input type="time" id="desde-h"></div>
                <div><label>Hasta:</label><input type="time" id="hasta-h"></div>
                <div><label>Total Horas:</label><input type="number" id="cant-h" placeholder="Ej: 2.5"></div>
                <div><label>Recargo:</label>
                    <select id="tipo-h">
                        <option value="100%">Al 100%</option>
                        <option value="50%">Al 50%</option>
                    </select>
                </div>
            </div>
            <select id="mes-h">
                <option value="Enero">Enero 2026</option>
                <option value="Febrero">Febrero 2026</option>
            </select>
            <textarea id="sug-h" maxlength="300" placeholder="Sugerencias o comentarios (m√°x 50 palabras)"></textarea>
            <button onclick="cargarHoras()">CARGAR REGISTRO</button>
        </div>

        <div id="admin-controls" class="hidden" style="margin-top:20px; border-top: 2px solid #eee; padding-top:10px;">
            <h3 style="color:var(--rojo)">Control de Administrador</h3>
            <button onclick="cambiarEstadoSitio('BLOQUEADO')" style="background:#e67e22; margin-bottom: 5px;">Bloquear Sitio</button>
            <button onclick="cambiarEstadoSitio('ACTIVO')" style="background:#27ae60">Activar Sitio</button>
        </div>

        <h3 style="margin-top:30px">Historial y Auditor√≠a</h3>
        <div id="lista-auditoria"></div>
    </div>

    <script>
        const URL_API = "https://script.google.com/macros/s/AKfycbywl__MWMfFaitVEkHXnnOd8c5V4F5TbRtTNQqS72qs-77kN4yRft2exQOvCjAgNxjH/exec"; // REEMPLAZAR CON TU URL /exec
        let sessionEmail = ""; let sessionNombre = ""; let sessionRol = "";

        // 1. LOGIN: Valida email, clave y obtiene el ROL (Admin/User)
        async function ejecutarLogin() {
            const u = document.getElementById('email').value.trim();
            const p = document.getElementById('pass').value;
            const res = await fetch(URL_API, { method: 'POST', body: JSON.stringify({type: "login", u, p}) });
            const data = await res.json();

            if (data.status === "OK") {
                sessionEmail = u; sessionRol = data.rol;
                sessionNombre = u.split('@')[0].toUpperCase();
                
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('panel-principal').classList.remove('hidden');
                document.getElementById('saludo').innerText = `Bienvenido, ${sessionNombre}`;
                document.getElementById('fecha-h').valueAsDate = new Date(); // Bot√≥n "Hoy" autom√°tico

                // Si es ADMIN, mostrar controles de bloqueo
                if (sessionRol === "ADMIN") document.getElementById('admin-controls').classList.remove('hidden');
                
                actualizarVista();
            } else { alert("Credenciales incorrectas."); }
        }

        // 2. CARGA: Env√≠a todos los campos a la planilla
        async function cargarHoras() {
            const payload = {
                type: "carga", n: sessionNombre, u: sessionEmail,
                fecha: document.getElementById('fecha-h').value,
                tk: document.getElementById('tk-h').value,
                desde: document.getElementById('desde-h').value,
                hasta: document.getElementById('hasta-h').value,
                h: document.getElementById('cant-h').value,
                tipo: document.getElementById('tipo-h').value,
                mes: document.getElementById('mes-h').value,
                sug: document.getElementById('sug-h').value
            };
            await fetch(URL_API, { method: 'POST', body: JSON.stringify(payload) });
            alert("Registro cargado.");
            actualizarVista();
        }

        // 3. AUDITOR√çA Y SEM√ÅFORO: Filtra por usuario y suma horas
        async function actualizarVista() {
            const res = await fetch(URL_API + "?action=read");
            const registros = await res.json();
            const lista = document.getElementById('lista-auditoria');
            const semaforo = document.getElementById('semaforo');
            const mesSeleccionado = document.getElementById('mes-h').value;
            
            lista.innerHTML = "";
            let totalHorasMes = 0;

            registros.forEach(r => {
                if (r[0] === "DATA") {
                    const [tag, nombre, email, mes, fecha, tk, ini, fin, horas, tipo, sug] = r;

                    // REGLA: Admin ve todo. Usuario com√∫n solo lo suyo.
                    if (sessionRol === "ADMIN" || email === sessionEmail) {
                        
                        // Suma para el sem√°foro si coincide el mes
                        if (mes === mesSeleccionado) totalHorasMes += parseFloat(horas);

                        lista.innerHTML += `
                            <div class="audit-item">
                                <div>
                                    <strong>${nombre}</strong> (${mes})<br>
                                    <small>${fecha} | TK: ${tk} | ${horas}hs (${tipo})</small><br>
                                    <i style="font-size:0.8em; color:#666;">${sug || ""}</i>
                                </div>
                                ${sessionRol === "ADMIN" ? `<button style="width:auto; background:red" onclick="borrarRegistro('${email}','${tk}')">üóëÔ∏è</button>` : ''}
                            </div>`;
                    }
                }
            });

            // L√ìGICA SEM√ÅFORO (Tope 30hs)
            semaforo.innerText = `Total ${mesSeleccionado}: ${totalHorasMes}hs`;
            if (totalHorasMes > 30) {
                semaforo.className = "semaforo rojo";
                semaforo.innerText += " - ¬°L√çMITE DE 30HS SUPERADO!";
            } else {
                semaforo.className = "semaforo verde";
            }
        }

        // 4. FUNCIONES DE ADMIN (Borrar y Bloquear)
        async function borrarRegistro(u, tk) {
            if(!confirm("¬øBorrar registro?")) return;
            await fetch(URL_API, { method: 'POST', body: JSON.stringify({type: "borrar_registro", u, tk}) });
            actualizarVista();
        }

        async function cambiarEstadoSitio(nuevoEstado) {
            await fetch(URL_API, { method: 'POST', body: JSON.stringify({type: "toggle_sitio", estado: nuevoEstado}) });
            alert("El sitio ahora est√°: " + nuevoEstado);
        }
    </script>
</body>
</html>
