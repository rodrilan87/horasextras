<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Horas Extras</title>

<style>
body{font-family:Arial;background:#f1f6fd;margin:0;padding:20px}
.container{background:#fff;border-radius:12px;padding:20px;margin-bottom:20px}
.row{display:flex;gap:10px;flex-wrap:wrap}
input,select,textarea,button{padding:8px;font-size:14px}
textarea{width:100%;height:90px;resize:none}
.logout{position:fixed;top:10px;right:10px}
.semaforo{display:flex;gap:10px;margin-top:10px}
.box{flex:1;padding:12px;text-align:center;border-radius:10px;opacity:.3}
.verde{background:#c9f7d1}
.amarillo{background:#fff2c2}
.rojo{background:#ffd3d3}
.activo{opacity:1;outline:2px solid #333}
.mes{background:#c9f7d1;padding:8px;border-radius:8px;font-weight:bold;margin-top:20px}
.item{background:#eefdf0;padding:8px;border-radius:8px;margin-top:6px;position:relative}
.item small{color:#666;display:block}
.borrar{position:absolute;right:10px;top:10px;color:red;cursor:pointer}
.total{text-align:right;font-weight:bold;margin-top:6px}
</style>
</head>

<body>

<button class="logout" onclick="logout()">Cerrar sesión</button>

<div class="container">
  <div class="row">
    <input id="usuario" readonly>
    <input type="date" id="fecha">
    <input type="time" id="desde">
    <input type="time" id="hasta">
    <input id="tk" placeholder="TK">
    <select id="porcentaje">
      <option value="50">50%</option>
      <option value="100">100%</option>
    </select>
    <button onclick="guardar()">Guardar</button>
  </div>

  <textarea id="sugerencia" placeholder="Sugerencias (hasta 50 palabras)"></textarea>

  <div class="semaforo">
    <div id="s0" class="box verde">0–15 hs</div>
    <div id="s1" class="box amarillo">16–25 hs</div>
    <div id="s2" class="box rojo">26+ hs</div>
  </div>
</div>

<div id="listado" class="container"></div>

<script>
const API = "PEGÁ_ACÁ_TU_URL_DE_APPS_SCRIPT";

const usuario = document.getElementById("usuario");
const fecha = document.getElementById("fecha");
usuario.value = localStorage.getItem("email");

function logout(){
  localStorage.clear();
  location.reload();
}

function guardar(){
  if(!fecha.value) return alert("Seleccioná fecha");

  const hoy = new Date().toISOString().split("T")[0];
  if(fecha.value > hoy) return alert("No se pueden cargar horas a futuro");

  const desde = document.getElementById("desde").value;
  const hasta = document.getElementById("hasta").value;

  const horas =
    (new Date("1970-01-01T"+hasta) -
     new Date("1970-01-01T"+desde)) / 3600000;

  if(horas<=0 || isNaN(horas)) return alert("Horario inválido");

  const params = new URLSearchParams({
    action:"cargarHoras",
    email:usuario.value,
    fecha:fecha.value,
    desde, hasta,
    horas,
    tk:document.getElementById("tk").value,
    porcentaje:document.getElementById("porcentaje").value,
    sugerencia:document.getElementById("sugerencia").value
  });

  fetch(API+"?"+params).then(()=>cargar());
}

function borrar(id){
  fetch(API+"?action=anular&id="+id).then(()=>cargar());
}

function cargar(){
  fetch(API+"?action=listar&email="+usuario.value)
    .then(r=>r.json())
    .then(datos=>render(datos));
}

function render(datos){
  listado.innerHTML="";
  let meses = {};
  let mesActivo = fecha.value?.slice(0,7); // YYYY-MM

  datos.forEach(r=>{
    if(!meses[r.mes]) meses[r.mes]={h:0,tk:0,items:[]};
    if(r.horas>0){meses[r.mes].h+=r.horas;meses[r.mes].tk++}
    meses[r.mes].items.push(r);
  });

  Object.entries(meses).forEach(([m,d])=>{
    listado.innerHTML+=`<div class="mes">${m}</div>`;
    d.items.forEach(i=>{
      listado.innerHTML+=`
      <div class="item">
        ${i.texto}
        ${i.horas==0?'<small>Este registro se puso en 0 y no se suma a tus horas cargadas</small>':''}
        <span class="borrar" onclick="borrar('${i.id}')">✖</span>
      </div>`;
    });
    listado.innerHTML+=`<div class="total">Total mes: ${d.h} hs · ${d.tk} TK</div>`;

    if(m.startsWith(mesActivo)) activarSemaforo(d.h);
  });
}

function activarSemaforo(h){
  document.querySelectorAll(".box").forEach(b=>b.classList.remove("activo"));
  if(h<=15) s0.classList.add("activo");
  else if(h<=25) s1.classList.add("activo");
  else s2.classList.add("activo");
}

cargar();
</script>

</body>
</html>
