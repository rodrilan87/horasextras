<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Horas Extras</title>

<!--
  Este archivo combina la interfaz de carga de horas con un panel de
  administración.  Los administradores pueden crear usuarios (con
  roles usuario, jefe o admin), ver auditoría, bloquear/desbloquear
  el sitio y realizar backups.  Los usuarios no administradores
  seguirán viendo únicamente el formulario de carga de horas y el
  listado de sus propios registros.

  Para que el registro funcione correctamente con correos
  corporativos, se valida que la dirección termine en
  “@osde.com.ar”.  Si la política cambia, ajuste la condición en la
  función `doRegister`.

  **Nota**: El backend (Apps Script) debe implementar las acciones
  invocadas desde este front‑end (`register`, `listarUsuarios`,
  `setRol`, `deleteUser`, `auditoria`, `bloquear`, `backup`,
  `importar`, etc.).  Si las acciones no existen, las funciones del
  panel de administración no funcionarán.  Consulte la
  documentación del servidor para más detalles.
-->

<style>
/* Paleta de colores y variables CSS */
:root{
  --azul:#0a1a2f;
  --azul-2:#0b2340;
  --azul-claro:#eef3fb;

  --verde:#c7f5cf;
  --verde-2:#36b37e;

  --rosa:#ffd1dc;
  --rosa-2:#ff4d7d;

  --gris:#e9eef7;
  --texto:#0b1220;
  --muted:#6b7280;

  --card:#ffffff;
  --shadow:0 12px 30px rgba(0,0,0,.10);
  --radius:16px;
}

*{box-sizing:border-box;font-family:Arial,system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
body{margin:0;background:var(--azul-claro);color:var(--texto)}
a{color:#1e5eff;text-decoration:none}
button{cursor:pointer}
small{color:var(--muted)}

/* Estilos del login */
#loginBox{
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  padding:24px;
}
.login-card{
  background:var(--card);
  width:min(420px,100%);
  padding:30px;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  text-align:center;
}
.login-card input{
  width:100%;
  padding:12px;
  margin-bottom:12px;
  border-radius:10px;
  border:1px solid #cbd5e1;
  outline:none;
}
.login-card button{
  width:100%;
  padding:12px;
  background:var(--azul);
  color:#fff;
  border:none;
  border-radius:10px;
}
.login-card .link{margin-top:10px;font-size:14px}
.login-card .link span{
  color:#1e5eff;
  cursor:pointer;
  font-weight:800;
}
.login-card .link span:hover{text-decoration:underline}
#error{color:#b91c1c;margin-top:10px;min-height:18px}

/* Estilos comunes a tarjetas y formularios */
#app{display:none;padding:25px}
.card{
  background:var(--card);
  border-radius:var(--radius);
  padding:20px;
  margin-bottom:20px;
  box-shadow:var(--shadow);
}
.topbar{
  display:flex;
  justify-content:flex-end;
  margin-bottom:15px;
}
.btn-logout{
  background:var(--azul);
  color:#fff;
  border:none;
  padding:10px 16px;
  border-radius:999px;
  box-shadow:0 10px 24px rgba(10,26,47,.25);
}
.btn-logout:hover{background:var(--azul-2)}

.form-row{
  display:grid;
  grid-template-columns: 1.2fr .9fr .8fr .8fr .8fr .9fr 1fr;
  gap:10px;
  align-items:center;
}
@media (max-width: 1100px){
  .form-row{grid-template-columns: 1fr 1fr 1fr; }
}
.input, select, textarea{
  padding:12px;
  border-radius:12px;
  border:1px solid #cbd5e1;
  outline:none;
  background:#fff;
}
#usuario{background:#f3f6fb}

.btn-guardar{
  background:var(--azul);
  color:#fff;
  border:none;
  border-radius:14px;
  padding:12px 16px;
  font-weight:700;
  min-height:44px;
}
.btn-guardar:hover{background:var(--azul-2)}
.btn-guardar:disabled{
  opacity:.45;
  cursor:not-allowed;
}

textarea{
  width:100%;
  min-height:110px;
  margin-top:10px;
  resize:vertical;
}

.porcentaje-100{border:2px solid rgba(54,179,126,.35); background:rgba(54,179,126,.08)}
.porcentaje-50{border:2px solid rgba(255,77,125,.35); background:rgba(255,77,125,.08); color:#7a0b2a}

.hr{height:1px;background:#e6edf7;margin:14px 0}

.bar-card{
  margin-top:12px;
  padding:16px;
  border-radius:14px;
  border:1px solid #d7e3f5;
  background:#fff;
}
.bar-head{
  display:flex;
  justify-content:space-between;
  align-items:flex-end;
  gap:10px;
}
.bar-title{font-size:28px;font-weight:800}
.bar-sub{margin-top:6px;color:var(--muted)}
.progress{
  margin-top:14px;
  width:100%;
  height:16px;
  background:var(--gris);
  border-radius:999px;
  overflow:hidden;
  border:1px solid #d7e3f5;
}
.progress > div{
  height:100%;
  width:0%;
  transition:width .25s ease;
}
.p-green{background:var(--verde-2)}
.p-yellow{background:#f4b400}
.p-red{background:#ef4444}

.toolbar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
}
.toggle{
  display:flex;
  gap:8px;
  align-items:center;
  padding:10px 12px;
  border-radius:999px;
  border:1px solid #d7e3f5;
  background:#fff;
}
.toggle input{transform:scale(1.2)}
.badge{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  min-width:54px;
  padding:6px 10px;
  border-radius:999px;
  font-weight:800;
  font-size:12px;
  border:1px solid transparent;
}
.badge-100{
  background:rgba(54,179,126,.14);
  color:#0b5b3d;
  border-color:rgba(54,179,126,.35);
}
.badge-50{
  background:rgba(255,77,125,.14);
  color:#7a0b2a;
  border-color:rgba(255,77,125,.35);
}

.mes{
  background:var(--verde);
  padding:12px;
  border-radius:12px;
  font-weight:800;
  text-align:center;
  margin-top:18px;
  text-transform:lowercase;
}
.registro{
  background:#ecfff0;
  padding:14px;
  border-radius:14px;
  margin-top:10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:14px;
  border-left:6px solid rgba(54,179,126,.55);
}
.registro.p50{
  border-left-color: rgba(255,77,125,.60);
}
.registro .left{
  flex:1;
  display:flex;
  gap:14px;
  align-items:flex-start;
  justify-content:space-between;
}
.registro .meta{
  flex:1;
}
.registro button{
  border:none;
  background:transparent;
  color:#ef4444;
  font-size:22px;
  padding:6px 10px;
  border-radius:10px;
}
.registro button:hover{background:rgba(239,68,68,.08)}

.resumen{
  margin-top:10px;
  font-weight:800;
  text-align:right;
  font-size:18px;
}
.resumen small{font-weight:600}

.toast{
  position:fixed;
  right:18px;
  bottom:18px;
  z-index:9999;
  display:none;
  background:#0b1220;
  color:#fff;
  padding:12px 14px;
  border-radius:14px;
  box-shadow:0 14px 40px rgba(0,0,0,.25);
  max-width:360px;
}
.toast.ok{background:#0b3b2b}
.toast.err{background:#4a0b0b}

.undo{
  margin-top:10px;
  display:flex;
  gap:10px;
  align-items:center;
}
.btn-undo{
  background:#fff;
  border:1px solid rgba(255,255,255,.35);
  color:#fff;
  padding:8px 12px;
  border-radius:999px;
  font-weight:800;
}

/* Estilos del panel de administración */
#adminPanel{
  display:none;
  margin-top:30px;
  padding:20px;
  border:2px dashed var(--azul-2);
  border-radius:var(--radius);
  background:#fff;
}
#adminPanel h3{
  margin-top:0;
  font-size:24px;
}
#adminPanel section{
  margin-bottom:30px;
}
#adminPanel section h4{
  margin-bottom:10px;
  font-size:20px;
}
#adminPanel input[type="text"],
#adminPanel input[type="password"],
#adminPanel select{
  width:100%;
  padding:10px;
  margin-bottom:8px;
  border:1px solid #cbd5e1;
  border-radius:8px;
}
#adminPanel button{
  padding:8px 14px;
  margin-right:8px;
  border:none;
  border-radius:8px;
  font-weight:bold;
  background:var(--azul);
  color:#fff;
}
#adminPanel button:hover{background:var(--azul-2)}
</style>
</head>

<body>

<!-- Tarjeta de login/registro -->
<div id="loginBox">
  <div class="login-card">
    <h2>Bienvenido</h2>
    <p>Ingresá para gestionar tus horas extras</p>
    <input id="email" placeholder="email">
    <input id="clave" type="password" placeholder="clave">
    <button onclick="doLogin()">Iniciar sesión</button>
    <div class="link">¿No tenés cuenta?
      <span onclick="doRegister()">Registrate aquí</span>
    </div>
    <!-- Nota de acceso para administradores -->
    <div style="margin-top:8px;font-size:13px;color:var(--muted)">
      ¿Sos administrador? Ingresá con tu correo autorizado y tu clave.
    </div>
    <div id="error"></div>
  </div>
</div>

<!-- Aplicación principal -->
<div id="app">

  <div class="topbar">
    <button class="btn-logout" onclick="logout()">Cerrar sesión</button>
  </div>

  <div class="card">
    <div class="form-row">
      <input class="input" id="usuario" disabled>
      <input class="input" type="date" id="fecha">
      <!-- Selector hora/minuto (sin reloj nativo) -->
      <div style="display:flex;gap:8px">
        <select class="input" id="desdeH" aria-label="Hora desde"></select>
        <select class="input" id="desdeM" aria-label="Min desde"></select>
      </div>
      <div style="display:flex;gap:8px">
        <select class="input" id="hastaH" aria-label="Hora hasta"></select>
        <select class="input" id="hastaM" aria-label="Min hasta"></select>
      </div>

      <input class="input" id="tk" placeholder="TK">
      <select class="input" id="porcentaje" onchange="pintarPorcentajeSelect()">
        <option value="100">100%</option>
        <option value="50">50%</option>
      </select>
      <button class="btn-guardar" id="btnGuardar" onclick="guardar()" disabled>Guardar</button>
    </div>

    <textarea id="sugerencia" maxlength="50" placeholder="Sugerencias (hasta 50 palabras)"></textarea>

    <div class="hr"></div>

    <div class="bar-card" id="barCard" style="display:none">
      <div class="bar-head">
        <div>
          <div class="bar-title" id="barTitle">Disponibilidad —</div>
          <div class="bar-sub" id="barSub"></div>
        </div>
        <div style="font-weight:900;font-size:18px" id="barRight"></div>
      </div>
      <div class="progress" aria-label="barra de progreso">
        <div id="barFill" class="p-green"></div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="toolbar">
      <div class="toggle">
        <input type="checkbox" id="soloMes" onchange="cargar()">
        <label for="soloMes"><b>Ver solo mes activo</b></label>
      </div>
      <small>Tip: Enter = Guardar · Esc = limpiar TK y sugerencia</small>
    </div>

    <div id="listado"></div>
  </div>

  <!-- Panel de administración -->
  <div id="adminPanel">
    <h3>Panel de Administración</h3>

    <!-- Alta de usuarios -->
    <section id="admin-crear">
      <h4>Alta de usuario</h4>
      <p>Crear nuevos usuarios indicando su rol. El rol puede ser <em>usuario</em>, <em>jefe</em> (permite aprobar horas) o <em>admin</em> (acceso completo a este panel).</p>
      <input id="newEmail" type="text" placeholder="Correo electrónico">
      <input id="newClave" type="password" placeholder="Contraseña">
      <select id="newRole">
        <option value="usuario">usuario</option>
        <option value="jefe">jefe</option>
        <option value="admin">admin</option>
      </select>
      <button onclick="crearUsuario()">Crear usuario</button>
    </section>

    <!-- Listado y gestión de usuarios -->
    <section id="admin-usuarios">
      <h4>Gestión de usuarios</h4>
      <p>Lista de todos los usuarios existentes. Desde aquí podés ascender a jefe, otorgar privilegios de admin o eliminar usuarios.</p>
      <div id="usuariosTabla">Cargando usuarios…</div>
    </section>

    <!-- Auditoría global -->
    <section id="admin-auditoria">
      <h4>Auditoría</h4>
      <p>Visualizá las horas cargadas por todos los usuarios, agrupadas por mes. Se resalta en rojo cuando superan el tope de 30 horas mensuales.</p>
      <div id="auditoriaTabla">Cargando auditoría…</div>
    </section>

    <!-- Bloqueo del sitio -->
    <section id="admin-sitio">
      <h4>Bloquear/desbloquear el sitio</h4>
      <p>Al bloquear el sitio, los usuarios comunes no podrán ingresar ni cargar horas. Solo se desactivará el front‑end; los datos permanecerán intactos.</p>
      <button onclick="bloquearSitio()" id="btnBloquear">Bloquear sitio</button>
    </section>

    <!-- Respaldo e importación -->
    <section id="admin-backup">
      <h4>Respaldo e importación</h4>
      <p>Descargá un respaldo completo de los datos o importá un archivo previamente exportado.</p>
      <button onclick="hacerBackup()">Descargar respaldo</button>
      <br><br>
      <input id="importFile" type="file" accept=".csv,.json">
      <button onclick="importarBackup()">Importar respaldo</button>
    </section>
  </div>

</div> <!-- fin de #app -->

<div id="toast" class="toast"></div>

<script>
// URL de tu Apps Script
const API="https://script.google.com/macros/s/AKfycbyiFERs6AduXngSs4XnY1CwzTPJjtqv5G-dFut2GqBtmPwjZh5HnO1dE_s3jIYpSaUXHQ/exec";

// Lista de correos con rol de administrador por defecto (siempre en minúsculas)
const ADMIN_EMAILS = [
  "admin@osde.com.ar",
  // Se añade el correo del usuario Rodri como administrador para permitir acceso al panel
  "rodri@gmx.com"
];
// Estado que indica si el usuario actual posee rol de administrador
let isAdmin = false;

// ====== Helpers de fecha/hora ======
function fFecha(v){
  try{
    const iso = isoDateFromCell(v);
    if(iso) return new Date(iso+"T00:00:00").toLocaleDateString("es-AR");
    const d = new Date(v);
    if(!isNaN(d)) return d.toLocaleDateString("es-AR");
    return String(v);
  }catch(e){ return String(v); }
}
function fHora(v){
  try{
    const d = new Date(v);
    if(!isNaN(d)) return d.toLocaleTimeString("es-AR",{hour:"2-digit",minute:"2-digit"});
    return String(v);
  }catch(e){ return String(v); }
}
function monthKeyFromISO(isoDate){
  // Convierte una fecha ISO a la etiqueta "mes año" en español.
  // Respeta un corte de mes configurable: si el día del mes es >= CORTE_DIA, se considera parte del siguiente mes.
  try{
    const d = new Date(String(isoDate || "") + "T00:00:00");
    if(isNaN(d)) return "fecha inválida";
    const corte = typeof CORTE_DIA !== 'undefined' ? Number(CORTE_DIA) : 24;
    let year = d.getFullYear();
    let month = d.getMonth();
    if(d.getDate() >= corte){
      month += 1;
      if(month > 11){ month = 0; year += 1; }
    }
    const mDate = new Date(year, month, 1);
    return mDate.toLocaleString('es-AR',{ month:'long', year:'numeric' }).toLowerCase();
  }catch(e){
    return 'fecha inválida';
  }
}
function hoyISO(){ const d=new Date(); const z=new Date(d.getTime()-d.getTimezoneOffset()*60000); return z.toISOString().slice(0,10); }
function isFutureDate(isoDate){ return isoDate > hoyISO(); }

// ====== Parsing robusto de fechas ======
// Convierte distintos formatos de celda de fecha a ISO (yyyy-mm-dd).
// Si no puede interpretarse, devuelve cadena vacía para evitar "Invalid Date".
function isoDateFromCell(v){
  if(!v) return "";
  const s = String(v).trim();
  // Si ya viene en formato ISO yyyy-mm-dd
  if(/^\d{4}-\d{2}-\d{2}/.test(s)) return s.slice(0,10);
  // Intentar construir un Date a partir del string
  const d = new Date(s);
  if(!isNaN(d)){
    const z = new Date(d.getTime() - d.getTimezoneOffset()*60000);
    return z.toISOString().slice(0,10);
  }
  return "";
}

// ====== Toast ======
function showToast(msg,type="ok",withUndo=false){
  const t=document.getElementById("toast");
  t.className="toast "+(type==="ok"?"ok":"err");
  t.innerHTML = `<div style="font-weight:800">${msg}</div>` + (withUndo ? `
    <div class="undo">
      <button class="btn-undo" onclick="undoDelete()">Deshacer</button>
      <small style="opacity:.85">10s</small>
    </div>` : ``);
  t.style.display="block";
  clearTimeout(t._hide);
  t._hide=setTimeout(()=>{ t.style.display="none"; }, withUndo?10000:2200);
}

// ====== Eliminación local de registros ======
function getDeleted(){return JSON.parse(localStorage.getItem("deletedRows")||"[]");}
function setDeleted(arr){localStorage.setItem("deletedRows",JSON.stringify(arr));}
let undoTimer=null;
let undoData=null;
function markDeleted(id){
  const d=getDeleted();
  if(!d.includes(id)) d.push(id);
  setDeleted(d);
  undoData={id};
  clearTimeout(undoTimer);
  showToast("Registro eliminado (no suma).", "ok", true);
  undoTimer=setTimeout(()=>{ undoData=null; }, 10000);
  cargar();
}
function undoDelete(){
  if(!undoData) return;
  const d=getDeleted().filter(x=>x!==undoData.id);
  setDeleted(d);
  undoData=null;
  showToast("Listo: se deshizo la eliminación.", "ok", false);
  cargar();
}

// ====== Login / Register ======
function doLogin(){
  error.textContent="";
  fetch(`${API}?action=login&email=${encodeURIComponent(email.value)}&clave=${encodeURIComponent(clave.value)}`)
    .then(r=>r.json())
    .then(d=>{
      if(!d.ok){ error.textContent=d.error||"No se pudo iniciar sesión"; return; }
      usuario.value=d.email;
      const lastTK = localStorage.getItem("lastTK_"+d.email) || "";
      tk.value = lastTK;
      fecha.value = hoyISO();
      setMaxFechaHoy();
      loginBox.style.display="none";
      app.style.display="block";
      pintarPorcentajeSelect();
      validarFormulario();
      cargar();
      // Reiniciamos el estado admin y determinamos si el usuario lo es
      isAdmin = false;
      // Si el backend devuelve explícitamente admin=true
      try{
        if(d.admin === true) isAdmin = true;
      }catch(e){}
      // Convertimos el correo del usuario a minúsculas
      const userEmail = String(d.email || "").toLowerCase();
      // Si aún no es admin, verificamos la lista local de correos admin (también en minúsculas)
      if(!isAdmin){
        const adminsLower = ADMIN_EMAILS.map(e => e.toLowerCase());
        if(adminsLower.includes(userEmail)) isAdmin = true;
      }
      // Si es administrador, mostramos el panel
      if(isAdmin){ showAdminPanel(); }
    })
    .catch(()=>{ error.textContent="Error de conexión"; });
}
function doRegister(){
  error.textContent="";
  // normalizamos a minúsculas para evitar errores con el dominio
  const em = email.value.trim().toLowerCase();
  const pw = clave.value.trim();
  // Solo permitimos registros con dominio corporativo.  Ajustar según necesidad.
  // Permitimos correos corporativos o correos listados como administradores por defecto
  const adminsLower = ADMIN_EMAILS.map(e => e.toLowerCase());
  if(!em.endsWith("@osde.com.ar") && !adminsLower.includes(em)){
    showToast("El registro está limitado a correos @osde.com.ar", "err");
    return;
  }
  if(!em || !pw){
    showToast("Completá email y clave", "err");
    return;
  }
  fetch(`${API}?action=register&email=${encodeURIComponent(em)}&clave=${encodeURIComponent(pw)}`)
    .then(r=>r.json())
    .then(d=>{
      error.textContent = d.ok ? "Usuario registrado ✅" : (d.error||"No se pudo registrar");
      if(d.ok) showToast("Usuario registrado ✅", "ok");
      else showToast(d.error||"No se pudo registrar", "err");
    })
    .catch(()=>{ error.textContent="Error de conexión"; });
}
function logout(){
  app.style.display="none";
  loginBox.style.display="flex";
  usuario.value="";
  email.value="";
  clave.value="";
  listado.innerHTML="";
  barCard.style.display="none";
  adminPanel.style.display="none";
  isAdmin = false;
}

// ====== Selector de hora/minuto ======
const minuteStep = 10;
function fillTimeSelects(){
  const desdeH=document.getElementById("desdeH");
  const hastaH=document.getElementById("hastaH");
  const desdeM=document.getElementById("desdeM");
  const hastaM=document.getElementById("hastaM");
  const hours=[...Array(24)].map((_,i)=>String(i).padStart(2,"0"));
  const minutes=[];
  for(let m=0;m<60;m+=minuteStep) minutes.push(String(m).padStart(2,"0"));
  [desdeH,hastaH].forEach(sel=>{
    sel.innerHTML = `<option value="">--</option>` + hours.map(h=>`<option value="${h}">${h}</option>`).join("");
  });
  [desdeM,hastaM].forEach(sel=>{
    sel.innerHTML = `<option value="">--</option>` + minutes.map(m=>`<option value="${m}">${m}</option>`).join("");
  });
  [desdeH,desdeM,hastaH,hastaM,fecha,tk,porcentaje,sugerencia].forEach(el=>{
    el.addEventListener("input", validarFormulario);
    el.addEventListener("change", validarFormulario);
  });
}
fillTimeSelects();

function getDesdeStr(){ return (desdeH.value && desdeM.value) ? `${desdeH.value}:${desdeM.value}` : ""; }
function getHastaStr(){ return (hastaH.value && hastaM.value) ? `${hastaH.value}:${hastaM.value}` : ""; }

function setMaxFechaHoy(){ fecha.max = hoyISO(); }
fecha.addEventListener("change", ()=>{
  setMaxFechaHoy();
  validarFormulario();
});

// ====== Estilo del select porcentaje ======
function pintarPorcentajeSelect(){
  porcentaje.classList.remove("porcentaje-100","porcentaje-50");
  if(String(porcentaje.value)==="50") porcentaje.classList.add("porcentaje-50");
  else porcentaje.classList.add("porcentaje-100");
}

// ====== Validación / botón guardar ======
function horasEntre(desdeStr,hastaStr){
  const a=new Date(`1970-01-01T${desdeStr}:00`);
  const b=new Date(`1970-01-01T${hastaStr}:00`);
  return (b-a)/3600000;
}
function validarFormulario(){
  const d=fecha.value;
  const ds=getDesdeStr();
  const hs=getHastaStr();
  let ok=true;
  if(!d || !ds || !hs) ok=false;
  if(d && isFutureDate(d)) ok=false;
  if(ok){
    const h=horasEntre(ds,hs);
    if(!(h>0 && isFinite(h))) ok=false;
  }
  document.getElementById("btnGuardar").disabled = !ok;
}

// ====== Guardar registro de horas ======
function guardar(){
  const d=fecha.value;
  if(isFutureDate(d)){
    showToast("No se pueden cargar horas a futuro.", "err");
    return;
  }
  const desde=getDesdeStr();
  const hasta=getHastaStr();
  const hReal=horasEntre(desde,hasta);
  if(!(hReal>0)){
    showToast("Horario inválido.", "err");
    return;
  }
  // guardar TK para autocompletar
  localStorage.setItem("lastTK_"+usuario.value, tk.value || "");
  // Si el usuario eligió 50 se envía como "50"; el backend debería interpretarlo correctamente
  const pct = porcentaje.value;
  // Enviamos sugerencia tal cual
  const url = `${API}?action=cargarHoras&email=${encodeURIComponent(usuario.value)}&fecha=${encodeURIComponent(d)}&desde=${encodeURIComponent(desde)}&hasta=${encodeURIComponent(hasta)}&horas=${encodeURIComponent(hReal)}&porcentaje=${encodeURIComponent(pct)}&sugerencia=${encodeURIComponent(sugerencia.value)}&tk=${encodeURIComponent(tk.value)}`;
  fetch(url)
    .then(()=> {
      showToast("Guardado ✅", "ok");
      // limpiar sugerencia pero no TK (lo autocompletamos)
      tk.value = localStorage.getItem("lastTK_"+usuario.value) || tk.value;
      sugerencia.value = "";
      cargar();
    })
    .catch(()=> showToast("No se pudo guardar. Revisá conexión.", "err"));
}

// ====== Atajos teclado ======
document.addEventListener("keydown",(e)=>{
  if(app.style.display!=="block") return;
  if(e.key==="Enter"){
    if(document.activeElement && document.activeElement.tagName==="TEXTAREA") return;
    if(!btnGuardar.disabled) guardar();
  }
  if(e.key==="Escape"){
    tk.value="";
    sugerencia.value="";
    showToast("TK y sugerencia limpiados.", "ok");
    validarFormulario();
  }
});

// ====== Cálculos: reales vs computables ======
function pesoPorcentaje(v){
  const s=String(v??"").trim();
  if(s==="50" || s==="50%") return 0.5;
  if(s==="100" || s==="100%") return 1;
  if(s.includes("50")) return 0.5;
  return 1;
}
function labelPorcentaje(v){
  const s=String(v??"").trim();
  if(s==="50" || s==="50%") return "50%";
  return "100%";
}
function percentFromRow(r){
  try{
    for(const c of r){
      const s=String(c??"").trim();
      if(s==="50" || s==="50%") return "50";
      if(s==="100" || s==="100%") return "100";
    }
  }catch(e){}
  return String((r && r[7]) ? r[7] : "100").trim();
}

// ====== Barra de disponibilidad ======
function pintarBarra(mesLabel, totalComputable){
  // Obtenemos los elementos de la barra cada vez para evitar depender de variables implícitas
  const cap = 30;
  const left = Math.max(0, cap - totalComputable);
  const pct  = Math.min(100, (totalComputable / cap) * 100);
  const barCardEl  = document.getElementById('barCard');
  const barTitleEl = document.getElementById('barTitle');
  const barSubEl   = document.getElementById('barSub');
  const barRightEl = document.getElementById('barRight');
  const barFillEl  = document.getElementById('barFill');
  barCardEl.style.display = 'block';
  barTitleEl.textContent = `Disponibilidad — ${mesLabel}`;
  barSubEl.textContent   = `Te quedan ${left} hs para cargar este mes.`;
  barRightEl.textContent = `${totalComputable} / ${cap} hs`;
  barFillEl.style.width  = pct + '%';
  barFillEl.classList.remove('p-green','p-yellow','p-red');
  if(totalComputable <= 15) barFillEl.classList.add('p-green');
  else if(totalComputable <= 25) barFillEl.classList.add('p-yellow');
  else barFillEl.classList.add('p-red');
}

// ====== Listado de horas del usuario ======
function cargar(){
  if(!usuario.value) return;
  fetch(`${API}?action=listar&email=${encodeURIComponent(usuario.value)}`)
    .then(r=>r.json())
    .then(data=>{
      listado.innerHTML="";
      const deleted=getDeleted();
      const refISO = fecha.value || hoyISO();
      const mesRef = monthKeyFromISO(refISO);
      const porMes={};
      data.forEach((r,i)=>{
        // omitir filas marcadas como eliminadas
        if(deleted.includes(i)) return;
        // Filtrar para mostrar solo las horas del usuario actual.  Algunas implementaciones del backend
        // devuelven todas las filas sin filtrar por email; por eso verificamos que la fila contenga el
        // correo del usuario logueado.  Convertimos todo a minúsculas para comparar.
        try {
          const userEmailLc = String(usuario.value||"").trim().toLowerCase();
          const rowHasEmail = r.some(c => String(c||"").trim().toLowerCase() === userEmailLc);
          if(!rowHasEmail) return;
        } catch(e) {
          // Si ocurre un error al iterar, continuamos la fila (mejor no mostrarla)
          return;
        }
        // Calculamos el mes a partir de la fecha de la fila.  Usamos isoDateFromCell para ser robustos y
        // siempre obtenemos un nombre de mes en español.  Descartamos r[9] porque puede venir en inglés.
        const iso = isoDateFromCell(r[3]);
        let mes = monthKeyFromISO(iso || hoyISO()).toLowerCase();
        if(!porMes[mes]) porMes[mes] = [];
        porMes[mes].push({r,id:i});
      });
      const mesesOrdenados = Object.keys(porMes).sort((a,b)=>{
        const pa=parseMesAnio(a);
        const pb=parseMesAnio(b);
        return pb - pa;
      });
      const solo = document.getElementById("soloMes").checked;
      const mesesParaMostrar = solo ? mesesOrdenados.filter(m=>m===mesRef) : mesesOrdenados;
      let totalMesComputable=0;
      mesesParaMostrar.forEach(m=>{
        let thReal=0;
        let thComp=0;
        let tkSum=0;
        porMes[m].forEach(o=>{
          const r=o.r;
          const horasReal = Number(r[6])||0;
          const pStr = percentFromRow(r);
          const p2 = pesoPorcentaje(pStr);
          thReal += horasReal;
          thComp += horasReal * p2;
          const tkVal = Number(r[10]) || 0;
          tkSum += tkVal;
        });
        if(m===mesRef) totalMesComputable = round1(thComp);
        listado.innerHTML += `<div class="mes">${m}</div>`;
        porMes[m].forEach(o=>{
          const r=o.r;
          const pStr = percentFromRow(r);
          const pLab = labelPorcentaje(pStr);
          const pClass = pLab==="50%" ? "p50" : "";
          const badgeClass = pLab==="50%" ? "badge-50" : "badge-100";
          const tkVal = (Number(r[10])||0);
          const tkTxt = tkVal>0 ? `TK ${tkVal}` : `TK -`;
          const sug = r[8] ? String(r[8]) : "";
          listado.innerHTML += `
            <div class="registro ${pClass}">
              <div class="left">
                <div class="meta">
                  <b>${fFecha(r[3])}</b> · ${fHora(r[4])} a ${fHora(r[5])}
                  · <b>${r[6]} hs</b> · ${tkTxt}
                  ${sug ? `<br><small>${escapeHtml(sug)}</small>` : ``}
                </div>
                <div style="display:flex;gap:10px;align-items:center">
                  <span class="badge ${badgeClass}">${pLab}</span>
                  <button title="Eliminar (no suma)" onclick="markDeleted(${o.id})">✖</button>
                </div>
              </div>
            </div>`;
        });
        listado.innerHTML += `
          <div class="resumen">
            Total mes: ${round1(thComp)} hs <small>(reales ${round1(thReal)} hs)</small> · ${tkSum} TK
          </div>
        `;
      });
      pintarBarra(mesRef, totalMesComputable);
    })
    .catch(()=> showToast("No se pudo cargar el listado.", "err"));
}

// ====== Utilidades ======
const mesesMap = {
  "enero":0,"febrero":1,"marzo":2,"abril":3,"mayo":4,"junio":5,
  "julio":6,"agosto":7,"septiembre":8,"setiembre":8,"octubre":9,"noviembre":10,"diciembre":11
};
function parseMesAnio(label){
  const s=String(label).replace(" de "," ").trim().toLowerCase();
  const parts=s.split(/\s+/);
  const mes=mesesMap[parts[0]] ?? 0;
  const anio=parseInt(parts[1]||"1970",10);
  return new Date(anio,mes,1).getTime();
}
function round1(n){ return Math.round((Number(n)||0)*10)/10; }
function escapeHtml(str){ return String(str||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"','&quot;')
    .replaceAll("'","&#039;"); }

// ====== Funciones de administración ======
function showAdminPanel(){
  adminPanel.style.display = "block";
  cargarUsuarios();
  cargarAuditoria();
  fetch(`${API}?action=estadoSitio`)
    .then(r=>r.json())
    .then(d=>{
      if(d.bloqueado){
        document.getElementById('btnBloquear').textContent = 'Desbloquear sitio';
      }else{
        document.getElementById('btnBloquear').textContent = 'Bloquear sitio';
      }
    })
    .catch(()=>{});
}

function crearUsuario(){
  // Convertimos el correo a minúsculas para validar el dominio correctamente
  const email = document.getElementById('newEmail').value.trim().toLowerCase();
  const clave = document.getElementById('newClave').value.trim();
  const rol = document.getElementById('newRole').value;
  if(!email || !clave){
    showToast('Completá email y contraseña', 'err');
    return;
  }
  // Permitir crear usuarios solo con dominio corporativo
  if(!email.endsWith('@osde.com.ar')){
    showToast('El correo debe terminar en @osde.com.ar', 'err');
    return;
  }
  const url = `${API}?action=register&email=${encodeURIComponent(email)}&clave=${encodeURIComponent(clave)}&rol=${encodeURIComponent(rol)}`;
  fetch(url)
    .then(r=>r.json())
    .then(d=>{
      if(d.ok){
        showToast('Usuario creado ✅');
        document.getElementById('newEmail').value='';
        document.getElementById('newClave').value='';
        cargarUsuarios();
      }else{
        showToast(d.error||'No se pudo crear el usuario','err');
      }
    })
    .catch(()=> showToast('Error al crear usuario','err'));
}

function cargarUsuarios(){
  const cont = document.getElementById('usuariosTabla');
  cont.innerHTML = 'Cargando usuarios…';
  fetch(`${API}?action=listarUsuarios`)
    .then(r=>r.json())
    .then(data=>{
      if(!Array.isArray(data) || data.length===0){
        cont.innerHTML = '<i>No hay usuarios.</i>';
        return;
      }
      let html = '<table style="width:100%;border-collapse:collapse"><thead><tr><th style="text-align:left;padding:8px">Email</th><th style="text-align:left;padding:8px">Rol</th><th style="padding:8px">Acciones</th></tr></thead><tbody>';
      data.forEach(u=>{
        const rol = u.rol || 'usuario';
        html += `<tr style="border-bottom:1px solid #e5e7eb">
          <td style="padding:8px">${escapeHtml(u.email)}</td>
          <td style="padding:8px">${escapeHtml(rol)}</td>
          <td style="padding:8px">
            ${rol!=='jefe' ? `<button onclick=\"cambiarRol('${u.email}','jefe')\">Hacer jefe</button>` : ''}
            ${rol!=='admin' ? `<button onclick=\"cambiarRol('${u.email}','admin')\">Hacer admin</button>` : ''}
            ${u.email!==usuario.value ? `<button onclick=\"borrarUsuario('${u.email}')\">Borrar</button>` : ''}
          </td>
        </tr>`;
      });
      html += '</tbody></table>';
      cont.innerHTML = html;
    })
    .catch(()=>{ cont.innerHTML = '<i>Error al obtener usuarios</i>'; });
}

function cambiarRol(email, rol){
  if(!confirm(`¿Cambiar rol de ${email} a ${rol}?`)) return;
  fetch(`${API}?action=setRol&email=${encodeURIComponent(email)}&rol=${encodeURIComponent(rol)}`)
    .then(r=>r.json())
    .then(d=>{
      if(d.ok) showToast('Rol actualizado ✅');
      else showToast(d.error||'No se pudo actualizar rol','err');
      cargarUsuarios();
    })
    .catch(()=> showToast('Error al actualizar rol','err'));
}

function borrarUsuario(email){
  if(!confirm(`¿Eliminar definitivamente a ${email}?`)) return;
  fetch(`${API}?action=deleteUser&email=${encodeURIComponent(email)}`)
    .then(r=>r.json())
    .then(d=>{
      if(d.ok) showToast('Usuario eliminado ✅');
      else showToast(d.error||'No se pudo eliminar usuario','err');
      cargarUsuarios();
    })
    .catch(()=> showToast('Error al eliminar usuario','err'));
}

function cargarAuditoria(){
  const cont = document.getElementById('auditoriaTabla');
  cont.innerHTML = 'Cargando auditoría…';
  fetch(`${API}?action=auditoria`)
    .then(r=>r.json())
    .then(data=>{
      if(!Array.isArray(data) || data.length===0){
        cont.innerHTML = '<i>No hay datos de auditoría.</i>';
        return;
      }
      let html = '<table style="width:100%;border-collapse:collapse"><thead><tr><th style="text-align:left;padding:8px">Usuario</th><th style="padding:8px">Mes</th><th style="padding:8px">Horas reales</th><th style="padding:8px">Horas computables</th></tr></thead><tbody>';
      data.forEach(reg=>{
        const semaforo = reg.horasComp >= 30 ? 'color:#ef4444' : (reg.horasComp >= 25 ? 'color:#f4b400' : 'color:#36b37e');
        html += `<tr style="border-bottom:1px solid #e5e7eb">
          <td style="padding:8px">${escapeHtml(reg.email)}</td>
          <td style="padding:8px">${escapeHtml(reg.mes)}</td>
          <td style="padding:8px">${Number(reg.horasReal).toFixed(1)}</td>
          <td style="padding:8px;${semaforo}">${Number(reg.horasComp).toFixed(1)}</td>
        </tr>`;
      });
      html += '</tbody></table>';
      cont.innerHTML = html;
    })
    .catch(()=>{ cont.innerHTML = '<i>Error al obtener auditoría</i>'; });
}

function bloquearSitio(){
  fetch(`${API}?action=bloquear`)
    .then(r=>r.json())
    .then(d=>{
      if(d.bloqueado){
        showToast('Sitio bloqueado');
        document.getElementById('btnBloquear').textContent = 'Desbloquear sitio';
      }else{
        showToast('Sitio desbloqueado');
        document.getElementById('btnBloquear').textContent = 'Bloquear sitio';
      }
    })
    .catch(()=> showToast('Error al bloquear/desbloquear','err'));
}

function hacerBackup(){
  fetch(`${API}?action=backup`)
    .then(r=>r.text())
    .then(csv=>{
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `respaldo_horas_${new Date().toISOString().slice(0,10)}.csv`;
      a.style.display='none';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showToast('Respaldo descargado ✅');
    })
    .catch(()=> showToast('Error al generar respaldo','err'));
}

function importarBackup(){
  const fileInput = document.getElementById('importFile');
  const file = fileInput.files[0];
  if(!file){ showToast('Seleccioná un archivo', 'err'); return; }
  const form = new FormData();
  form.append('file', file);
  fetch(`${API}?action=importar`, { method:'POST', body:form })
    .then(r=>r.json())
    .then(d=>{
      if(d.ok){ showToast('Importación completada ✅'); cargar(); cargarAuditoria(); }
      else showToast(d.error||'No se pudo importar','err');
    })
    .catch(()=> showToast('Error al importar','err'));
}

// ====== Mantenimiento de sesión ======
// Algunas implementaciones de Apps Script expiran la sesión o conexión luego de unos minutos de inactividad.
// Para evitar que la aplicación se desconecte de la hoja de cálculo tras un tiempo, enviamos una solicitud
// ligera cada 4 minutos cuando hay un usuario logueado.  Esto actúa como un "keep‑alive".
function keepAlive(){
  // Solo si hay usuario autenticado
  if(usuario && usuario.value){
    // Llamamos al listado sin usar el resultado para mantener la sesión activa
    fetch(`${API}?action=listar&email=${encodeURIComponent(usuario.value)}`).catch(()=>{});
  }
}
// Ejecutamos el keep‑alive cada 4 minutos (240000 ms)
setInterval(keepAlive, 240000);
</script>

</body>
</html>
