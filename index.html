<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Horas Extras</title>

<style>
:root{
  --azul:#0a1a2f;
  --azul-claro:#eef3fb;
  --verde:#c7f5cf;
  --amarillo:#ffe9a6;
  --rojo:#ffb3b3;
}
*{box-sizing:border-box;font-family:Arial,sans-serif}
body{margin:0;background:var(--azul-claro)}

#loginBox{
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
}
.login-card{
  background:#fff;
  width:380px;
  padding:30px;
  border-radius:16px;
  box-shadow:0 10px 30px rgba(0,0,0,.15);
  text-align:center;
}
.login-card input{
  width:100%;
  padding:12px;
  margin-bottom:12px;
  border-radius:8px;
  border:1px solid #ccc;
}
.login-card button{
  width:100%;
  padding:12px;
  background:var(--azul);
  color:#fff;
  border:none;
  border-radius:8px;
  cursor:pointer;
}
.login-card .link{margin-top:10px;font-size:14px}
.login-card .link span{color:#1e5eff;cursor:pointer}
#error{color:red;margin-top:10px}

#app{display:none;padding:25px}
.card{background:#fff;border-radius:14px;padding:20px;margin-bottom:20px}

.form-row{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:10px;
}
.form-row input,.form-row select{
  padding:10px;border-radius:8px;border:1px solid #ccc
}
.form-row button{
  background:var(--azul);color:#fff;border:none;border-radius:8px;cursor:pointer
}

textarea{
  width:100%;min-height:80px;margin-top:10px;
  padding:12px;border-radius:10px;border:1px solid #ccc
}

/* BARRA */
.disponibleBox{
  margin-top:15px;
  padding:14px;
  border-radius:12px;
  background:#f7f9ff;
  border:1px solid #dfe7ff;
}
.disponibleTop{
  display:flex;
  justify-content:space-between;
  gap:10px;
  flex-wrap:wrap;
  font-weight:bold;
}
.progressOuter{
  width:100%;
  height:14px;
  border-radius:999px;
  background:#e8eefc;
  overflow:hidden;
  margin-top:10px;
}
.progressInner{
  height:100%;
  width:0%;
  border-radius:999px;
  transition:width .25s ease;
  background:#36a853;
}
.progressInner.warn{background:#f1b400;}
.progressInner.danger{background:#e14444;}
.progressText{
  margin-top:8px;
  font-size:13px;
  color:#333;
}

.mes{
  background:var(--verde);
  padding:10px;border-radius:10px;
  font-weight:bold;text-align:center;margin-top:25px
}
.registro{
  background:#ecfff0;padding:12px;border-radius:10px;
  margin-top:10px;display:flex;
  justify-content:space-between;align-items:center
}
.registro button{
  border:none;background:transparent;color:red;
  font-size:18px;cursor:pointer
}
.resumen{
  margin-top:8px;font-weight:bold;text-align:right
}
.small-muted{color:#666;font-size:12px;margin-top:6px}
</style>
</head>

<body>

<div id="loginBox">
  <div class="login-card">
    <h2>Bienvenido</h2>
    <p>Ingresá para gestionar tus horas extras</p>
    <input id="email" placeholder="email">
    <input id="clave" type="password" placeholder="clave">
    <button onclick="doLogin()">Iniciar sesión</button>
    <div class="link">¿No tenés cuenta?
      <span onclick="doRegister()">Registrate aquí</span>
    </div>
    <div id="error"></div>
  </div>
</div>

<div id="app">

  <div style="display:flex;justify-content:flex-end;margin-bottom:15px">
    <button onclick="logout()" style="background:#ddd;border:none;padding:8px 14px;border-radius:8px">
      Cerrar sesión
    </button>
  </div>

  <div class="card">
    <div class="form-row">
      <input id="usuario" disabled>
      <input type="date" id="fecha">

      <!-- ✅ CAMBIO: en vez de reloj nativo, selects con minutos cada 10 -->
      <select id="desde"></select>
      <select id="hasta"></select>

      <input id="tk" placeholder="TK">
      <select id="porcentaje">
        <option value="50%">50%</option>
        <option value="100%">100%</option>
      </select>
      <button onclick="guardar()">Guardar</button>
    </div>

    <textarea id="sugerencia" maxlength="50"
      placeholder="Sugerencias (hasta 50 palabras)"></textarea>

    <!-- Barra disponibilidad -->
    <div class="disponibleBox">
      <div class="disponibleTop">
        <div id="mesActivoLabel">Mes activo: —</div>
        <div id="hsLabel">Cargadas: 0 hs · Disponibles: 30 hs</div>
      </div>
      <div class="progressOuter">
        <div class="progressInner" id="progressBar"></div>
      </div>
      <div class="progressText" id="progressText">—</div>
    </div>
  </div>

  <div class="card" id="listado"></div>
</div>

<script>
const API="https://script.google.com/macros/s/AKfycbyiFERs6AduXngSs4XnY1CwzTPJjtqv5G-dFut2GqBtmPwjZh5HnO1dE_s3jIYpSaUXHQ/exec";
const TOPE = 30;

/* ====== SELECTS HORAS (minutos cada 10) ====== */
function fillTimeSelects(sel){
  sel.innerHTML = "";
  for(let h=0; h<24; h++){
    for(let m=0; m<60; m+=10){
      const hh=String(h).padStart(2,"0");
      const mm=String(m).padStart(2,"0");
      const v=`${hh}:${mm}`;
      const opt=document.createElement("option");
      opt.value=v; opt.textContent=v;
      sel.appendChild(opt);
    }
  }
}
fillTimeSelects(desde);
fillTimeSelects(hasta);

/* defaults */
desde.value="09:00";
hasta.value="10:00";

/* Login */
function doLogin(){
  error.textContent="";
  fetch(`${API}?action=login&email=${encodeURIComponent(email.value)}&clave=${encodeURIComponent(clave.value)}`)
  .then(r=>r.json())
  .then(d=>{
    if(!d.ok){error.textContent=d.error;return}
    usuario.value=d.email;
    loginBox.style.display="none";
    app.style.display="block";
    // fecha por defecto hoy
    fecha.value = new Date().toISOString().split("T")[0];
    cargar();
  });
}
function doRegister(){
  fetch(`${API}?action=register&email=${encodeURIComponent(email.value)}&clave=${encodeURIComponent(clave.value)}`)
  .then(r=>r.json())
  .then(d=>error.textContent=d.ok?"Usuario registrado":d.error);
}
function logout(){
  app.style.display="none";
  loginBox.style.display="flex";
}

/* Guardar */
function guardar(){
  // bloquear futuro
  const hoyStr = new Date().toISOString().split("T")[0];
  if(fecha.value > hoyStr){
    alert("No se pueden cargar horas a futuro");
    return;
  }

  const h1=new Date(`1970-01-01T${desde.value}`);
  const h2=new Date(`1970-01-01T${hasta.value}`);
  let horas=(h2-h1)/3600000;
  if(horas<=0) return alert("Horario inválido");

  // factor por porcentaje (siempre computable)
  const factor = (porcentaje.value==="100%") ? 1 : 0.5;
  const horasComputables = horas*factor;

  fetch(`${API}?action=cargarHoras&email=${encodeURIComponent(usuario.value)}&fecha=${encodeURIComponent(fecha.value)}&desde=${encodeURIComponent(desde.value)}&hasta=${encodeURIComponent(hasta.value)}&horas=${encodeURIComponent(horasComputables)}&porcentaje=${encodeURIComponent(porcentaje.value)}&sugerencia=${encodeURIComponent(sugerencia.value)}&tk=${encodeURIComponent(tk.value||"")}`)
  .then(()=>cargar());
}

/* Render barra */
function renderBar(mesLabel, total){
  const usados = Math.max(0, Number(total)||0);
  const disp = Math.max(0, TOPE - usados);
  const pct = Math.min(100, (usados/TOPE)*100);

  mesActivoLabel.textContent = `Mes activo: ${mesLabel}`;
  hsLabel.textContent = `Cargadas: ${usados} hs · Disponibles: ${disp} hs`;
  progressBar.style.width = pct+"%";

  progressBar.classList.remove("warn","danger");
  if(usados>=26) progressBar.classList.add("danger");
  else if(usados>=16) progressBar.classList.add("warn");

  progressText.textContent = usados>TOPE
    ? `Te pasaste por ${Math.round((usados-TOPE)*10)/10} hs.`
    : `Te quedan ${disp} hs para cargar este mes.`;
}

/* Cargar listado */
function cargar(){
  fetch(`${API}?action=listar&email=${encodeURIComponent(usuario.value)}`)
  .then(r=>r.json())
  .then(data=>{
    listado.innerHTML="";

    // mes activo = el del input fecha
    const d = new Date(fecha.value+"T00:00:00");
    const mesRef = d.toLocaleString("es-AR",{month:"long",year:"numeric"}).toLowerCase();

    let totalMes=0;
    const porMes={};

    data.forEach(r=>{
      const mes = (r[9] ? String(r[9]).toLowerCase() : mesRef);
      if(!porMes[mes]) porMes[mes]=[];
      porMes[mes].push(r);

      // sumar solo el mes activo
      if(mes===mesRef) totalMes += Number(r[6])||0;
    });

    renderBar(mesRef, Math.round(totalMes*10)/10);

    Object.keys(porMes).forEach(m=>{
      let th=0, tkSum=0;
      listado.innerHTML += `<div class="mes">${m}</div>`;
      porMes[m].forEach(r=>{
        th += Number(r[6])||0;
        tkSum += Number(r[10])||0;
        listado.innerHTML += `
          <div class="registro">
            <div>
              <b>${r[3]}</b> · ${r[4]} a ${r[5]} · ${r[6]} hs · TK ${r[10]||"-"}
              <br><small>${r[8]||""}</small>
            </div>
            <button onclick="alert('borrado local como antes')">✖</button>
          </div>`;
      });
      listado.innerHTML += `<div class="resumen">Total mes: ${Math.round(th*10)/10} hs · ${tkSum} TK</div>`;
    });
  });
}
</script>

</body>
</html>
