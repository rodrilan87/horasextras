<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Horas Extras</title>

<style>
:root{
  --azul:#0a1a2f;
  --azul-claro:#eef3fb;
  --verde:#c7f5cf;
  --amarillo:#ffe9a6;
  --rojo:#ffb3b3;
  --gris:#e9eef6;
  --texto:#0b1220;
}
*{box-sizing:border-box;font-family:Arial,sans-serif}
body{margin:0;background:var(--azul-claro);color:var(--texto)}

#loginBox{
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
}
.login-card{
  background:#fff;
  width:380px;
  padding:30px;
  border-radius:16px;
  box-shadow:0 10px 30px rgba(0,0,0,.15);
  text-align:center;
}
.login-card input{
  width:100%;
  padding:12px;
  margin-bottom:12px;
  border-radius:8px;
  border:1px solid #ccc;
}
.login-card button{
  width:100%;
  padding:12px;
  background:var(--azul);
  color:#fff;
  border:none;
  border-radius:8px;
  cursor:pointer;
}
.login-card .link{margin-top:10px;font-size:14px}
.login-card .link span{color:#1e5eff;cursor:pointer}
#error{color:red;margin-top:10px}

#app{display:none;padding:25px}
.card{
  background:#fff;border-radius:14px;padding:20px;margin-bottom:20px;
  box-shadow:0 6px 18px rgba(10,26,47,.06);
}

.topbar{
  display:flex;
  justify-content:flex-end;
  align-items:center;
  margin-bottom:15px;
}
.topbar button{
  background:#ddd;border:none;padding:8px 14px;border-radius:8px;cursor:pointer
}

.form-row{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:10px;
}
.form-row input,.form-row select{
  padding:10px;border-radius:10px;border:1px solid #d5dbe6;
  outline:none;
}
.form-row input:disabled{background:#f4f6fb}
.form-row button{
  background:var(--azul);color:#fff;border:none;border-radius:10px;cursor:pointer;
  font-weight:700;
}

textarea{
  width:100%;
  min-height:96px;
  margin-top:10px;
  padding:12px;
  border-radius:12px;
  border:1px solid #d5dbe6;
  resize:vertical;
}

/* Disponibilidad */
.avail{
  margin-top:14px;
  border:1px solid #e6ebf4;
  border-radius:14px;
  padding:14px;
  background:#fff;
}
.avail-head{
  display:flex;
  justify-content:space-between;
  align-items:flex-end;
  gap:10px;
  margin-bottom:6px;
}
.avail-title{
  font-size:18px;
  font-weight:800;
}
.avail-sub{
  font-size:13px;color:#45526a;margin-bottom:10px;
}
.avail-right{
  font-weight:800;
  font-size:16px;
}
.progress{
  height:16px;
  border-radius:999px;
  background:var(--gris);
  overflow:hidden;
  border:1px solid #e0e6f2;
}
.progress > div{
  height:100%;
  width:0%;
  background:#36a853; /* verde por defecto */
  transition:width .25s ease;
}
.progress.warn > div{ background:#f1b400; } /* amarillo */
.progress.danger > div{ background:#e14444; } /* rojo */

.mes{
  background:var(--verde);
  padding:10px;border-radius:12px;
  font-weight:800;text-align:center;margin-top:20px;
  text-transform:lowercase;
}
.registro{
  background:#ecfff0;
  padding:12px 14px;
  border-radius:12px;
  margin-top:10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
}
.registro small{color:#5b6b7e}
.registro .mainline{font-weight:700}
.registro button{
  border:none;background:transparent;color:#e00;
  font-size:20px;cursor:pointer;line-height:1;
}
.registro.zeroed{
  opacity:.72;
}
.registro.zeroed .mainline{
  text-decoration:line-through;
}
.resumen{
  margin-top:10px;font-weight:800;text-align:right
}
</style>
</head>

<body>

<div id="loginBox">
  <div class="login-card">
    <h2>Bienvenido</h2>
    <p>Ingresá para gestionar tus horas extras</p>
    <input id="email" placeholder="email" autocomplete="username">
    <input id="clave" type="password" placeholder="clave" autocomplete="current-password">
    <button onclick="doLogin()">Iniciar sesión</button>
    <div class="link">¿No tenés cuenta?
      <span onclick="doRegister()">Registrate aquí</span>
    </div>
    <div id="error"></div>
  </div>
</div>

<div id="app">

  <div class="topbar">
    <button onclick="logout()">Cerrar sesión</button>
  </div>

  <div class="card">
    <div class="form-row">
      <input id="usuario" disabled>
      <input type="date" id="fecha" max="">
      <input type="time" id="desde">
      <input type="time" id="hasta">
      <input id="tk" placeholder="TK">
      <select id="porcentaje">
        <option value="50%">50%</option>
        <option value="100%">100%</option>
      </select>
      <button onclick="guardar()">Guardar</button>
    </div>

    <textarea id="sugerencia" placeholder="Sugerencias (hasta 50 palabras)"></textarea>

    <div class="avail" id="availBox" style="display:none">
      <div class="avail-head">
        <div class="avail-title" id="availTitle">Disponibilidad</div>
        <div class="avail-right" id="availRight">0 / 30 hs</div>
      </div>
      <div class="avail-sub" id="availSub">Te quedan 30 hs para cargar este mes.</div>
      <div class="progress" id="prog">
        <div id="progFill"></div>
      </div>
    </div>
  </div>

  <div class="card" id="listado"></div>
</div>

<script>
const API="https://script.google.com/macros/s/AKfycbyiFERs6AduXngSs4XnY1CwzTPJjtqv5G-dFut2GqBtmPwjZh5HnO1dE_s3jIYpSaUXHQ/exec";
const TOPE_MENSUAL = 30;

// ===== Helpers de formato (ES-AR) =====
function fFecha(v){
  try { return new Date(v).toLocaleDateString("es-AR"); }
  catch { return String(v || ""); }
}
function fHora(v){
  try { return new Date(v).toLocaleTimeString("es-AR",{hour:"2-digit",minute:"2-digit"}); }
  catch { return ""; }
}
function monthLabelFromDate(dateStr){
  // dateStr: "YYYY-MM-DD"
  const d = new Date(dateStr + "T00:00:00");
  return d.toLocaleString("es-AR",{month:"long",year:"numeric"}).toLowerCase();
}
function todayISO(){
  return new Date().toISOString().split("T")[0];
}

// ===== "Borrado" local por índice (sin tocar Code.gs) =====
function getDeleted(){
  return JSON.parse(localStorage.getItem("deletedRows")||"[]");
}
function markDeleted(id){
  const d=getDeleted();
  if(!d.includes(id)){ d.push(id); }
  localStorage.setItem("deletedRows",JSON.stringify(d));
  cargar();
}

// ===== Reglas: no cargar a futuro =====
function setDateLimits(){
  const f = document.getElementById("fecha");
  f.max = todayISO();
}

// ===== Login =====
function doLogin(){
  error.textContent = "";
  fetch(`${API}?action=login&email=${encodeURIComponent(email.value)}&clave=${encodeURIComponent(clave.value)}`)
    .then(r=>r.json())
    .then(d=>{
      if(!d.ok){ error.textContent=d.error || "Credenciales inválidas"; return; }
      usuario.value=d.email;
      loginBox.style.display="none";
      app.style.display="block";
      setDateLimits();
      // seteo por defecto fecha hoy (si querés)
      if(!fecha.value) fecha.value = todayISO();
      cargar();
    })
    .catch(()=> error.textContent="No se pudo conectar al servidor.");
}
function doRegister(){
  error.textContent = "";
  fetch(`${API}?action=register&email=${encodeURIComponent(email.value)}&clave=${encodeURIComponent(clave.value)}`)
    .then(r=>r.json())
    .then(d=> error.textContent = d.ok ? "Usuario registrado" : (d.error || "Error al registrar"))
    .catch(()=> error.textContent="No se pudo conectar al servidor.");
}
function logout(){
  app.style.display="none";
  loginBox.style.display="flex";
}

// ===== Guardar =====
function guardar(){
  // Validación base
  if(!usuario.value) return alert("No hay usuario logueado.");

  if(!fecha.value) return alert("Ingresá una fecha.");
  // Bloqueo futuro
  const hoy = new Date(todayISO() + "T00:00:00");
  const f = new Date(fecha.value + "T00:00:00");
  if(f > hoy){
    alert("No se pueden cargar horas a futuro.");
    return;
  }

  if(!desde.value || !hasta.value) return alert("Completá desde/hasta.");

  const h=(new Date(`1970-01-01T${hasta.value}`)-new Date(`1970-01-01T${desde.value}`))/3600000;
  if(!(h>0)) return alert("Horario inválido.");

  // sugerencia: solo por longitud (no palabras) porque HTML no sabe contar palabras sin lógica extra
  const sug = (sugerencia.value || "").trim();

  // Nota: tk puede venir vacío, lo mandamos igual
  fetch(`${API}?action=cargarHoras&email=${encodeURIComponent(usuario.value)}&fecha=${encodeURIComponent(fecha.value)}&desde=${encodeURIComponent(desde.value)}&hasta=${encodeURIComponent(hasta.value)}&horas=${encodeURIComponent(h)}&porcentaje=${encodeURIComponent(porcentaje.value)}&sugerencia=${encodeURIComponent(sug)}&tk=${encodeURIComponent(tk.value||"")}`)
    .then(r=>r.json().catch(()=>({ok:true})))
    .then(()=> {
      // opcional: limpiar inputs
      // desde.value=""; hasta.value=""; tk.value=""; sugerencia.value="";
      cargar();
    })
    .catch(()=> alert("No se pudo guardar. Revisá la conexión."));
}

// ===== UI: Barra de disponibilidad =====
function setDisponibilidadUI(mesRef, totalMes){
  const box = document.getElementById("availBox");
  const title = document.getElementById("availTitle");
  const right = document.getElementById("availRight");
  const sub = document.getElementById("availSub");
  const prog = document.getElementById("prog");
  const fill = document.getElementById("progFill");

  box.style.display = mesRef ? "block" : "none";
  if(!mesRef) return;

  const usado = Math.max(0, Number(totalMes)||0);
  const restante = Math.max(0, TOPE_MENSUAL - usado);
  const pct = Math.min(100, (usado/TOPE_MENSUAL)*100);

  title.textContent = `Disponibilidad — ${mesRef}`;
  right.textContent = `${usado} / ${TOPE_MENSUAL} hs`;
  sub.textContent = `Te quedan ${restante} hs para cargar este mes.`;

  fill.style.width = pct + "%";

  prog.classList.remove("warn","danger");
  // colores por rangos
  if(usado >= 26) prog.classList.add("danger");
  else if(usado >= 16) prog.classList.add("warn");
}

// ===== Listado =====
function cargar(){
  if(!usuario.value) return;

  fetch(`${API}?action=listar&email=${encodeURIComponent(usuario.value)}`)
    .then(r=>r.json())
    .then(data=>{
      listado.innerHTML="";
      const deleted=getDeleted();

      // Mes activo = el de la fecha seleccionada (en español)
      let mesRef = null;
      if(fecha.value){
        mesRef = monthLabelFromDate(fecha.value);
      }

      // Agrupar por mes
      const porMes={};
      let totalMesRef=0;

      // data: array de filas, asumiendo índices:
      // [0]=TIPO [1]=email [2]=clave [3]=fecha [4]=desde [5]=hasta [6]=horas [7]=porcentaje [8]=sugerencia [9]=mes [10]=tk
      data.forEach((r,i)=>{
        if(deleted.includes(i)) return;

        const mes = (r[9] ? String(r[9]).toLowerCase() : "");
        porMes[mes]=porMes[mes]||[];
        porMes[mes].push({r,id:i});
      });

      // Ordenar meses (si tus "mes" vienen como "enero de 2026", esto no es trivial).
      // Dejamos el orden como viene desde Sheets.
      const meses = Object.keys(porMes);

      meses.forEach(m=>{
        let th=0, tkSum=0;

        porMes[m].forEach(o=>{
          // Si está "borrado" localmente, no entra acá.
          th += Number(o.r[6]) || 0;
          tkSum += Number(o.r[10]) || 0; // SUMA de TK, no conteo
        });

        if(mesRef && m === mesRef) totalMesRef = th;

        // Encabezado mes
        listado.innerHTML += `<div class="mes">${m || "sin mes"}</div>`;

        // Registros
        porMes[m].forEach(o=>{
          const r=o.r;
          const pct = r[7] || ""; // 50% / 100%
          const sug = (r[8] || "").trim();

          listado.innerHTML += `
            <div class="registro">
              <div>
                <div class="mainline">
                  <b>${fFecha(r[3])}</b> · ${fHora(r[4])} a ${fHora(r[5])}
                  · ${r[6]} hs · ${pct} · TK ${r[10] || 0}
                </div>
                ${sug ? `<small>${sug}</small>` : ``}
              </div>
              <button title="Poner este registro en 0 (no se suma)" onclick="markDeleted(${o.id})">✖</button>
            </div>`;
        });

        // Resumen por mes
        listado.innerHTML += `<div class="resumen">Total mes: ${th} hs · ${tkSum} TK</div>`;
      });

      // Barra de disponibilidad del mes activo
      setDisponibilidadUI(mesRef, totalMesRef);
    })
    .catch(()=> {
      listado.innerHTML = "<b>No se pudo cargar el listado.</b>";
    });
}

// Inicial
setDateLimits();
</script>

</body>
</html>
