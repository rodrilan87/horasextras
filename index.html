<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Horas Extras</title>
<style>
:root{
  --azul:#0a1a2f; --azul-2:#0b2340; --azul-claro:#eef3fb;
  --verde:#c7f5cf; --verde-2:#36b37e;
  --gris:#e9eef7; --texto:#0b1220; --muted:#6b7280;
  --card:#fff; --shadow:0 12px 30px rgba(0,0,0,.10); --radius:16px;
}
*{box-sizing:border-box;font-family:Arial,system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
body{margin:0;background:var(--azul-claro);color:var(--texto)}
button{cursor:pointer}
small{color:var(--muted)}
.card{background:var(--card);border-radius:var(--radius);padding:20px;margin-bottom:20px;box-shadow:var(--shadow)}
.input, select, textarea{padding:12px;border-radius:12px;border:1px solid #cbd5e1;outline:none;background:#fff}
.btn{background:var(--azul);color:#fff;border:none;border-radius:14px;padding:12px 16px;font-weight:700}
.btn:disabled{opacity:.45;cursor:not-allowed}
#loginBox{min-height:100vh;display:flex;justify-content:center;align-items:center;padding:24px}
.login-card{background:var(--card);width:min(460px,100%);padding:30px;border-radius:var(--radius);box-shadow:var(--shadow);text-align:center}
.login-card input{width:100%;padding:12px;margin-bottom:12px;border-radius:10px;border:1px solid #cbd5e1}
.link{margin-top:10px;font-size:14px}
.link span{color:#1e5eff;cursor:pointer;font-weight:700}
#error{color:#b91c1c;margin-top:10px;min-height:18px}
#app{display:none;padding:25px}
.topbar{display:flex;justify-content:flex-end;margin-bottom:15px}
.btn-logout{background:var(--azul);color:#fff;border:none;padding:10px 16px;border-radius:999px}
.form-row{display:grid;grid-template-columns: 1.2fr .9fr .9fr .9fr .9fr .9fr 1fr;gap:10px;align-items:center}
@media (max-width:1100px){.form-row{grid-template-columns:1fr 1fr 1fr}}
#usuario{background:#f3f6fb}
.hr{height:1px;background:#e6edf7;margin:14px 0}
.bar-card{margin-top:12px;padding:16px;border-radius:14px;border:1px solid #d7e3f5;background:#fff}
.bar-head{display:flex;justify-content:space-between;align-items:flex-end;gap:10px}
.bar-title{font-size:28px;font-weight:800}
.progress{margin-top:14px;width:100%;height:16px;background:var(--gris);border-radius:999px;overflow:hidden;border:1px solid #d7e3f5}
.progress>div{height:100%;width:0%;transition:width .25s ease;background:var(--verde-2)}
.mes{background:var(--verde);padding:12px;border-radius:12px;font-weight:800;text-align:center;margin-top:18px;text-transform:lowercase}
.registro{background:#ecfff0;padding:14px;border-radius:14px;margin-top:10px;display:flex;justify-content:space-between;gap:14px;border-left:6px solid rgba(54,179,126,.55)}
.badge{display:inline-flex;align-items:center;justify-content:center;min-width:54px;padding:6px 10px;border-radius:999px;font-weight:800;font-size:12px;border:1px solid rgba(0,0,0,.08)}
.badge-50{background:rgba(255,77,125,.14);color:#7a0b2a;border-color:rgba(255,77,125,.35)}
.badge-100{background:rgba(54,179,126,.14);color:#0b5b3d;border-color:rgba(54,179,126,.35)}
.resumen{margin-top:10px;font-weight:800;text-align:right;font-size:18px}
.toast{position:fixed;right:18px;bottom:18px;z-index:9999;display:none;background:#0b1220;color:#fff;padding:12px 14px;border-radius:14px;box-shadow:0 14px 40px rgba(0,0,0,.25);max-width:360px}
.toast.ok{background:#0b3b2b}
.toast.err{background:#4a0b0b}
#adminPanel{display:none}
table{border-collapse:collapse;width:100%}
th,td{padding:10px;border-bottom:1px solid #e6edf7;text-align:left}
.chip{display:inline-block;padding:6px 10px;border:1px solid #d7e3f5;border-radius:999px;margin:4px;cursor:pointer;background:#fff}
.chip.active{background:var(--azul);color:#fff;border-color:var(--azul)}
</style>
</head>
<body>

<div id="loginBox">
  <div class="login-card">
    <h2>Bienvenido</h2>
    <p>IngresÃ¡ para gestionar tus horas extras</p>
    <input id="email" placeholder="email">
    <input id="clave" type="password" placeholder="clave">
    <button class="btn" style="width:100%" onclick="doLogin()">Iniciar sesiÃ³n</button>

    <div class="link" id="registerBox" style="display:none">Â¿No tenÃ©s cuenta?
      <span onclick="doRegister()">Registrate aquÃ­</span>
    </div>

    <div class="link" style="margin-top:8px">
      <small>Si sos administrador o jefe, usÃ¡ tu usuario normal.</small>
    </div>

    <div id="error"></div>
  </div>
</div>

<div id="app">
  <div class="topbar">
    <button class="btn-logout" onclick="logout()">Cerrar sesiÃ³n</button>
  </div>

  <div class="card">
    <div class="form-row">
      <input class="input" id="usuario" disabled>
      <input class="input" type="date" id="fecha">
      <select class="input" id="desdeH"></select>
      <select class="input" id="desdeM"></select>
      <select class="input" id="hastaH"></select>
      <select class="input" id="hastaM"></select>
      <button class="btn" id="btnGuardar" onclick="guardar()" disabled>Guardar</button>
    </div>

    <div style="display:grid;grid-template-columns:1fr 160px 160px;gap:10px;margin-top:10px">
      <textarea class="input" id="sugerencia" maxlength="50" placeholder="Sugerencias (hasta 50 palabras)"></textarea>
      <input class="input" id="tk" placeholder="TK">
      <select class="input" id="porcentaje">
        <option value="100%">100%</option>
        <option value="50%">50%</option>
      </select>
    </div>

    <div class="hr"></div>

    <div class="bar-card" id="barCard" style="display:none">
      <div class="bar-head">
        <div>
          <div class="bar-title" id="barTitle">Disponibilidad â€”</div>
          <div class="bar-sub" id="barSub" style="color:var(--muted)"></div>
        </div>
        <div style="font-weight:900;font-size:18px" id="barRight"></div>
      </div>
      <div class="progress"><div id="barFill"></div></div>
    </div>
  </div>

  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
      <label style="display:flex;gap:8px;align-items:center">
        <input type="checkbox" id="soloMes" onchange="cargarListado()">
        <b>Ver solo mes activo</b>
      </label>
      <small>Tip: Enter = Guardar Â· Esc = limpiar TK y sugerencia</small>
    </div>
    <div id="listado"></div>
  </div>

  <div id="adminPanel" class="card">
    <h2>Panel de AdministraciÃ³n</h2>
    <small id="adminRoleInfo"></small>

    <div class="hr"></div>

    <div id="adminEstadoBox" style="display:none">
      <h3>Estado del sitio</h3>
      <label style="display:flex;gap:10px;align-items:center;margin:8px 0">
        <input type="checkbox" id="chkBloqueado">
        <b>Bloquear sitio</b>
      </label>
      <label style="display:flex;gap:10px;align-items:center;margin:8px 0">
        <input type="checkbox" id="chkRegistro">
        <b>Habilitar registro</b>
      </label>
      <button class="btn" onclick="guardarEstado()">Guardar estado</button>
    </div>

    <div class="hr"></div>

    <div id="adminCortesBox" style="display:none">
      <h3>Cortes mensuales</h3>
      <small>Regla: si el dÃ­a es <b>mayor</b> al corte, cuenta para el mes siguiente.</small>
      <div style="margin-top:10px">
        <table>
          <thead><tr><th>Mes</th><th>DÃ­a de corte</th></tr></thead>
          <tbody id="cortesBody"></tbody>
        </table>
      </div>
      <button class="btn" style="margin-top:10px" onclick="guardarCortes()">Guardar cortes</button>
    </div>

    <div class="hr"></div>

    <div id="adminUsuariosBox" style="display:none">
      <h3>Usuarios</h3>
      <table>
        <thead><tr><th>Email</th><th>Rol</th><th>Activo</th><th>Acciones</th></tr></thead>
        <tbody id="usuariosBody"></tbody>
      </table>
    </div>

    <div class="hr"></div>

    <div>
      <h3>AuditorÃ­a</h3>
      <small>Horas reales y computables por usuario y por mes (segÃºn cortes).</small>
      <div id="chipsMeses" style="margin-top:10px"></div>
      <table style="margin-top:10px">
        <thead><tr><th>Usuario</th><th>Mes</th><th>Horas reales</th><th>Horas computables</th><th>Tope</th></tr></thead>
        <tbody id="auditoriaBody"></tbody>
      </table>

      <div id="detalleBox" style="margin-top:14px;display:none">
        <h4 id="detalleTitle"></h4>
        <table>
          <thead><tr><th>Fecha</th><th>Desde</th><th>Hasta</th><th>Hs</th><th>%</th><th>TK</th><th>Email</th></tr></thead>
          <tbody id="detalleBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
const API = "https://script.google.com/macros/s/AKfycbw293ze16Qn6-mlNLpmCiWYT4vHMYowwU92_8_LUg7MUMbKhdCmEPQGooEgl3RQj3Wd/exec";

let session = null; // {email, rol, token}
let cortes = {};    // {enero: 24, ...}
let estado = {bloqueado:false, registro:true};
let selectedMes = "";

function showToast(msg,type="ok"){
  const t=document.getElementById("toast");
  t.className="toast "+(type==="ok"?"ok":"err");
  t.textContent=msg;
  t.style.display="block";
  clearTimeout(t._hide);
  t._hide=setTimeout(()=>t.style.display="none", 2200);
}

function qs(obj){
  return Object.keys(obj).map(k=>encodeURIComponent(k)+"="+encodeURIComponent(obj[k])).join("&");
}

async function api(action, params={}, raw=false){
  const p = {...params, action};
  if(session?.token) p.token = session.token;
  const url = API + "?" + qs(p);
  const r = await fetch(url);
  const data = await r.json();
  if(raw) return data;
  if(data && data.ok===false) throw new Error(data.error||"Error");
  return data;
}

async function loadEstado(){
  try{
    const d = await api("estado");
    estado.bloqueado = !!d.bloqueado;
    estado.registro = !!d.registro;
    document.getElementById("registerBox").style.display = estado.registro ? "block":"none";
  }catch(e){
    // si falla, no bloqueamos UI
  }
}

async function loadCortes(){
  const d = await api("listarCortes");
  cortes = {};
  (d.data||[]).forEach(it=>{ cortes[it.mes]=Number(it.corte)||24; });
}

function hoyISO(){
  const d=new Date();
  const z=new Date(d.getTime()-d.getTimezoneOffset()*60000);
  return z.toISOString().slice(0,10);
}

function fillTimeSelects(){
  const desdeH=document.getElementById("desdeH");
  const hastaH=document.getElementById("hastaH");
  const desdeM=document.getElementById("desdeM");
  const hastaM=document.getElementById("hastaM");
  const hours=[...Array(24)].map((_,i)=>String(i).padStart(2,"0"));
  const minutes=["00","10","20","30","40","50"];
  const optH = `<option value="">--</option>` + hours.map(h=>`<option value="${h}">${h}</option>`).join("");
  const optM = `<option value="">--</option>` + minutes.map(m=>`<option value="${m}">${m}</option>`).join("");
  desdeH.innerHTML=optH; hastaH.innerHTML=optH;
  desdeM.innerHTML=optM; hastaM.innerHTML=optM;
}
fillTimeSelects();

function getDesde(){ return (desdeH.value && desdeM.value) ? `${desdeH.value}:${desdeM.value}`:""; }
function getHasta(){ return (hastaH.value && hastaM.value) ? `${hastaH.value}:${hastaM.value}`:""; }

function horasEntre(desde,hasta){
  const a=new Date(`1970-01-01T${desde}:00`);
  const b=new Date(`1970-01-01T${hasta}:00`);
  return (b-a)/3600000;
}

function mesKeyFromISO(iso){
  const [y,mo,d] = iso.split("-").map(Number);
  const mIdx = mo-1;
  const mesNombre = ["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"][mIdx];
  const corte = cortes[mesNombre] || 24;
  let outIdx=mIdx, outY=y;
  if(d > corte){
    outIdx = mIdx+1;
    if(outIdx===12){ outIdx=0; outY=y+1; }
  }
  const outMes = ["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"][outIdx];
  return `${outMes} de ${outY}`;
}

function validar(){
  const d=fecha.value;
  const ds=getDesde();
  const hs=getHasta();
  let ok=!!(d && ds && hs);
  if(ok){
    const h=horasEntre(ds,hs);
    if(!(h>0 && isFinite(h))) ok=false;
    if(d>hoyISO()) ok=false;
  }
  btnGuardar.disabled=!ok;
}

["fecha","desdeH","desdeM","hastaH","hastaM","tk","porcentaje","sugerencia"].forEach(id=>{
  document.getElementById(id).addEventListener("change", validar);
  document.getElementById(id).addEventListener("input", validar);
});
fecha.max = hoyISO();

async function doLogin(){
  error.textContent="";
  try{
    const d = await api("login",{email:email.value, clave:clave.value});
    session = {email:d.email, rol:d.rol, token:d.token};
    localStorage.setItem("he_session", JSON.stringify(session));
    usuario.value = session.email;

    loginBox.style.display="none";
    app.style.display="block";

    fecha.value = hoyISO();
    await loadEstado();
    await loadCortes();
    validar();
    await cargarListado();
    await maybeShowAdmin();

    // keep alive
    setInterval(async ()=>{ try{ await api("ping"); }catch(e){} }, 120000);
  }catch(e){
    error.textContent = e.message || "No se pudo iniciar sesiÃ³n";
  }
}

async function doRegister(){
  error.textContent="";
  if(!estado.registro){
    showToast("Registro deshabilitado", "err"); return;
  }
  try{
    const d = await api("register",{email:email.value, clave:clave.value});
    showToast("Usuario registrado âœ…","ok");
  }catch(e){
    showToast(e.message||"No se pudo registrar","err");
  }
}

function logout(){
  session=null;
  localStorage.removeItem("he_session");
  app.style.display="none";
  loginBox.style.display="flex";
}

async function guardar(){
  try{
    const d=fecha.value;
    if(d>hoyISO()){ showToast("No se pueden cargar horas a futuro","err"); return; }
    const desde=getDesde();
    const hasta=getHasta();
    const h=horasEntre(desde,hasta);
    if(!(h>0)){ showToast("Horario invÃ¡lido","err"); return; }

    await api("cargarHoras",{
      fecha:d,
      desde, hasta,
      horas:h,
      porcentaje:porcentaje.value,
      sugerencia:sugerencia.value,
      tk:tk.value
    });
    showToast("Guardado âœ…","ok");
    sugerencia.value="";
    await cargarListado();
    if(session.rol==="admin" || session.rol==="jefe") await cargarAuditoria();
  }catch(e){
    showToast(e.message||"No se pudo guardar","err");
  }
}

function pesoPct(p){ return String(p||"").includes("50") ? 0.5 : 1; }
function badgeClass(p){ return String(p||"").includes("50") ? "badge badge-50" : "badge badge-100"; }

function pintarBarra(mesLabel, totalComp){
  const cap=30;
  const left=Math.max(0, cap-totalComp);
  const pct=Math.min(100,(totalComp/cap)*100);
  barCard.style.display="block";
  barTitle.textContent = `Disponibilidad â€” ${mesLabel}`;
  barSub.textContent = `Te quedan ${left} hs para cargar este mes.`;
  barRight.textContent = `${totalComp} / ${cap} hs`;
  barFill.style.width = pct+"%";
}

async function cargarListado(){
  if(!session) return;
  const data = await api("listar", {}, true); // array
  listado.innerHTML="";
  const refISO = fecha.value || hoyISO();
  const mesRef = mesKeyFromISO(refISO);

  const solo = document.getElementById("soloMes").checked;

  // agrupar por mesKey (r[9])
  const porMes = {};
  data.forEach(r=>{
    const mes = String(r[9]||"").toLowerCase();
    if(!porMes[mes]) porMes[mes]=[];
    porMes[mes].push(r);
  });

  const meses = Object.keys(porMes).sort(); // simple
  const showMeses = solo ? meses.filter(m=>m===mesRef.toLowerCase()) : meses;

  // calcular mes activo computable
  let totalMesComp=0;

  showMeses.forEach(m=>{
    let thReal=0, thComp=0;
    listado.innerHTML += `<div class="mes">${m}</div>`;
    porMes[m].forEach(r=>{
      const horas=Number(r[6])||0;
      const p = r[7]||"100%";
      const comp = horas*pesoPct(p);
      thReal += horas;
      thComp += comp;

      const sug = r[8] ? `<br><small>${escapeHtml(String(r[8]))}</small>` : "";
      listado.innerHTML += `
        <div class="registro">
          <div>
            <b>${r[3]}</b> Â· ${r[4]} a ${r[5]} Â· <b>${horas} hs</b> Â· TK ${r[10]||"-"}
            ${sug}
          </div>
          <span class="${badgeClass(p)}">${String(p).includes("50")?"50%":"100%"}</span>
        </div>`;
    });
    listado.innerHTML += `<div class="resumen">Total mes: ${round1(thComp)} hs <small>(reales ${round1(thReal)} hs)</small></div>`;
    if(m===mesRef.toLowerCase()) totalMesComp = round1(thComp);
  });

  pintarBarra(mesRef, totalMesComp);
}

function round1(n){ return Math.round((Number(n)||0)*10)/10; }
function escapeHtml(str){
  return str.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

async function maybeShowAdmin(){
  const rol = session?.rol;
  if(rol!=="admin" && rol!=="jefe"){
    adminPanel.style.display="none";
    return;
  }
  adminPanel.style.display="block";
  adminRoleInfo.textContent = rol==="admin" ? "Rol: Administrador" : "Rol: Jefe (solo lectura)";

  // Admin: ver estado, cortes, usuarios
  const isAdmin = rol==="admin";
  adminEstadoBox.style.display = isAdmin ? "block":"none";
  adminCortesBox.style.display = isAdmin ? "block":"none";
  adminUsuariosBox.style.display = isAdmin ? "block":"none";

  if(isAdmin){
    await loadEstado();
    chkBloqueado.checked = estado.bloqueado;
    chkRegistro.checked = estado.registro;
    await cargarCortesUI();
    await cargarUsuarios();
  }
  await cargarAuditoria();
}

async function guardarEstado(){
  try{
    const d = await api("setEstado",{bloqueado: chkBloqueado.checked, registro: chkRegistro.checked});
    estado.bloqueado = !!d.bloqueado;
    estado.registro = !!d.registro;
    document.getElementById("registerBox").style.display = estado.registro ? "block":"none";
    showToast("Estado guardado âœ…","ok");
  }catch(e){
    showToast(e.message||"Error guardando estado","err");
  }
}

async function cargarCortesUI(){
  const d = await api("listarCortes");
  cortesBody.innerHTML="";
  (d.data||[]).forEach(it=>{
    const mes = it.mes;
    const val = it.corte;
    cortesBody.innerHTML += `
      <tr>
        <td style="text-transform:capitalize"><b>${mes}</b></td>
        <td><input class="input" style="width:120px" type="number" min="1" max="31" id="corte_${mes}" value="${val}"></td>
      </tr>`;
  });
}
async function guardarCortes(){
  try{
    const list=[];
    Object.keys(cortes).forEach(m=>{
      const v = parseInt(document.getElementById("corte_"+m).value,10);
      list.push({mes:m, corte:v});
    });
    await api("setCortes",{cortes: JSON.stringify(list)});
    await loadCortes();
    showToast("Cortes guardados âœ…","ok");
    await cargarListado();
    await cargarAuditoria();
  }catch(e){
    showToast(e.message||"Error guardando cortes","err");
  }
}

async function cargarUsuarios(){
  const d = await api("listarUsuarios");
  usuariosBody.innerHTML="";
  (d.data||[]).forEach(u=>{
    const opts = ["usuario","jefe","admin"].map(r=>`<option value="${r}" ${u.rol===r?"selected":""}>${r}</option>`).join("");
    usuariosBody.innerHTML += `
      <tr>
        <td>${u.email}</td>
        <td>
          <select class="input" style="width:140px" onchange="cambiarRol('${u.email}', this.value)">${opts}</select>
        </td>
        <td>${u.activo ? "SÃ­":"No"}</td>
        <td><button class="btn" style="background:#b91c1c" onclick="borrarUsuario('${u.email}')">Borrar</button></td>
      </tr>`;
  });
}

async function cambiarRol(email, rol){
  try{
    await api("setRol",{email, rol});
    showToast("Rol actualizado âœ…","ok");
  }catch(e){
    showToast(e.message||"Error cambiando rol","err");
  }
}
async function borrarUsuario(email){
  if(!confirm("Â¿Seguro que querÃ©s borrar el usuario y sus horas?")) return;
  try{
    await api("deleteUser",{email});
    showToast("Usuario borrado âœ…","ok");
    await cargarUsuarios();
    await cargarAuditoria();
  }catch(e){
    showToast(e.message||"Error borrando usuario","err");
  }
}

async function cargarAuditoria(){
  const d = await api("auditoria");
  const rows = d.data||[];
  auditoriaBody.innerHTML="";
  chipsMeses.innerHTML="";
  detalleBox.style.display="none";
  selectedMes="";

  // meses Ãºnicos
  const meses = [...new Set(rows.map(r=>r.mes))];
  meses.forEach(m=>{
    const span=document.createElement("span");
    span.className="chip";
    span.textContent=m;
    span.onclick=()=>selectMes(m);
    chipsMeses.appendChild(span);
  });

  rows.forEach(r=>{
    const sem = r.horasComp >= 30 ? "ðŸ”´" : (r.horasComp >= 25 ? "ðŸŸ¡" : "ðŸŸ¢");
    auditoriaBody.innerHTML += `
      <tr>
        <td>${r.email}</td>
        <td>${r.mes}</td>
        <td>${r.horasReal}</td>
        <td>${r.horasComp}</td>
        <td>${sem}</td>
      </tr>`;
  });

  async function selectMes(mes){
    selectedMes = mes;
    [...chipsMeses.querySelectorAll(".chip")].forEach(c=>c.classList.toggle("active", c.textContent===mes));
    const det = await api("auditoriaDetalle",{mes});
    detalleTitle.textContent = "Detalle: " + mes;
    detalleBody.innerHTML = "";
    (det.data||[]).forEach(x=>{
      detalleBody.innerHTML += `
        <tr>
          <td>${x.fecha}</td><td>${x.desde}</td><td>${x.hasta}</td>
          <td>${x.horas}</td><td>${x.porcentaje}</td><td>${x.tk||"-"}</td>
          <td>${x.email}</td>
        </tr>`;
    });
    detalleBox.style.display="block";
  }
}

(async function boot(){
  await loadEstado();
  const saved = localStorage.getItem("he_session");
  if(saved){
    try{
      session = JSON.parse(saved);
      // intentamos ping para validar
      await api("ping");
      usuario.value = session.email;
      loginBox.style.display="none";
      app.style.display="block";
      fecha.value = hoyISO();
      await loadCortes();
      validar();
      await cargarListado();
      await maybeShowAdmin();
      setInterval(async ()=>{ try{ await api("ping"); }catch(e){} }, 120000);
    }catch(e){
      localStorage.removeItem("he_session");
      session=null;
    }
  }
})();
</script>
</body>
</html>
