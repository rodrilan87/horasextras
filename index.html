<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA OSDE - CONTROL TOTAL</title>
    <style>
        /* --- ESTILOS DE MARCA Y UI --- */
        :root { 
            --navy: #003057; --sky: #0076BE; --orange: #E87722; 
            --green: #27ae60; --red: #dc3545; --gray: #f4f4f4; 
        }
        body { font-family: 'Segoe UI', sans-serif; background: #dfe4ea; margin: 0; padding: 10px; }
        .container { max-width: 950px; margin: auto; }
        .card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin-bottom: 20px; border-top: 8px solid var(--navy); }

        /* Sem√°foro de Horas */
        .semaforo-box { background: #fff; padding: 15px; border-radius: 10px; border: 1px solid #ddd; margin: 15px 0; }
        .bar-bg { background: #eee; height: 16px; border-radius: 10px; overflow: hidden; margin-top: 8px; }
        .bar-fill { height: 100%; transition: 1s ease; width: 0%; background: var(--green); }

        /* CAJAS DE COLORES SOLICITADAS */
        .box-rosa { border: 2px solid #ff00ff66; padding: 15px; border-radius: 10px; background: #fffaff; }
        .box-verde { border: 2px solid #00ff0066; padding: 15px; border-radius: 10px; background: #fafffa; }
        .box-naranja { border: 2px solid var(--orange); padding: 15px; border-radius: 10px; }

        /* Tablas y Navegaci√≥n */
        .tab-nav { display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 2px solid #ddd; }
        .tab-btn { padding: 12px 20px; border: none; background: none; cursor: pointer; font-weight: bold; color: #666; }
        .tab-btn.active { color: var(--sky); border-bottom: 4px solid var(--sky); }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 13px; }
        th { background: #f8f9fa; padding: 12px; text-align: left; border-bottom: 2px solid #ddd; }
        td { padding: 12px; border-bottom: 1px solid #eee; }

        /* Inputs y Botones */
        .oculto { display: none !important; }
        input, select, textarea { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 14px; }
        .btn { padding: 14px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; text-transform: uppercase; width: 100%; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; }
    </style>
</head>
<body>

<div class="container">
    <div id="auth-section" class="card" style="max-width: 400px; margin: 60px auto;">
        <h2 style="text-align:center; color:var(--navy)">OSDE <span style="color:var(--sky)">PORTAL</span></h2>
        <div id="login-form">
            <input type="email" id="l_email" placeholder="usuario@osde.com.ar o rodri@gmx.com">
            <input type="password" id="l_pass" placeholder="Contrase√±a" style="margin-top:10px;">
            <button class="btn" style="background:var(--navy); margin-top:15px;" onclick="app.login()">Entrar</button>
            <p onclick="app.toggleAuth()" style="text-align:center; font-size:12px; color:var(--sky); cursor:pointer; margin-top:20px;">Registrar nueva cuenta</p>
        </div>
        <div id="reg-form" class="oculto">
            <input type="text" id="r_name" placeholder="Nombre completo">
            <input type="email" id="r_email" placeholder="Email @osde.com.ar" style="margin-top:10px;">
            <input type="password" id="r_pass" placeholder="Contrase√±a" style="margin-top:10px;">
            <button class="btn" style="background:var(--green); margin-top:15px;" onclick="app.register()">Crear Cuenta</button>
            <p onclick="app.toggleAuth()" style="text-align:center; font-size:12px; cursor:pointer; margin-top:20px;">Volver al login</p>
        </div>
    </div>

    <div id="main-section" class="oculto">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center">
                <h2 id="u-saludo" style="margin:0; color:var(--navy)"></h2>
                <button class="btn" style="background:var(--red); width:auto; padding:8px 20px;" onclick="app.logout()">CERRAR SESI√ìN</button>
            </div>

            <div class="semaforo-box">
                <div style="display:flex; justify-content:space-between">
                    <span>Estado mensual de Horas Extras:</span>
                    <b id="hs-txt">0 / 30hs</b>
                </div>
                <div class="bar-bg"><div id="hs-bar" class="bar-fill"></div></div>
            </div>

            <div class="tab-nav" id="admin-tabs" class="oculto">
                <button class="tab-btn active" onclick="app.tab(event, 'carga')">Cargar Horas</button>
                <button class="tab-btn" onclick="app.tab(event, 'historial')">Mis Registros</button>
                <button id="jefe-tab-btn" class="tab-btn oculto" onclick="app.tab(event, 'jefe')">Panel Jefe ‚òÖ</button>
            </div>

            <div id="tab-carga" class="tab-content">
                <h3>Nueva Jornada</h3>
                <div class="grid">
                    <div>
                        <label>Fecha:</label>
                        <div style="display:flex; gap:5px;">
                            <input type="date" id="c_fecha">
                            <button class="btn" style="background:var(--sky); width:auto; padding:5px 10px;" onclick="app.setToday()">HOY</button>
                        </div>
                    </div>
                    <div class="box-rosa" style="grid-column: span 2; display:flex; gap:10px;">
                        <div><label>Desde:</label><input type="time" id="c_desde"></div>
                        <div><label>Hasta:</label><input type="time" id="c_hasta"></div>
                        <div><label>Total Hs:</label><input type="number" id="c_hs" step="0.5" placeholder="Ej: 2.5"></div>
                    </div>
                </div>

                <div class="grid" style="margin-top:15px;">
                    <div class="box-verde">
                        <label>Compensaci√≥n:</label>
                        <select id="c_tipo"><option value="50">Al 50%</option><option value="100">Al 100%</option></select>
                    </div>
                    <div class="box-naranja" style="grid-column: span 2;">
                        <label>Detalle de tarea / Ticket:</label>
                        <input type="text" id="c_tk" placeholder="TK-0000 o descripci√≥n">
                    </div>
                </div>

                <div style="margin-top:15px;">
                    <label>Sugerencias (M√°x 50 palabras):</label>
                    <textarea id="c_sug" rows="2" maxlength="250"></textarea>
                </div>
                <button class="btn" style="background:var(--orange); margin-top:20px; font-size:18px;" id="btn-save" onclick="app.save()">GUARDAR JORNADA</button>
            </div>

            <div id="tab-historial" class="tab-content oculto">
                <div id="user-history-table"></div>
            </div>

            <div id="tab-jefe" class="tab-content oculto">
                <div class="tab-nav">
                    <button class="tab-btn active" onclick="app.subTab(event, 'auditoria')">Auditor√≠a</button>
                    <button class="tab-btn" onclick="app.subTab(event, 'usuarios')">Usuarios</button>
                    <button class="tab-btn" onclick="app.subTab(event, 'cierres')">Cierres</button>
                </div>
                <div id="sub-auditoria" class="sub-content">
                    <input type="text" placeholder="üîç Buscar por nombre..." onkeyup="app.filterTable(this.value)">
                    <div id="admin-audit-table"></div>
                </div>
                <div id="sub-usuarios" class="sub-content oculto">
                    <table id="user-list"><thead><tr><th>Nombre</th><th>Email</th><th>Rol</th><th>Acciones</th></tr></thead><tbody id="user-tbody"></tbody></table>
                </div>
                <div id="sub-cierres" class="sub-content oculto">
                    <div class="grid" id="cierres-grid"></div>
                    <button class="btn" style="background:var(--navy); margin-top:20px;" onclick="app.saveCierres()">Actualizar Calendario</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzxMWANRQxkue_jvpKFdzmm3K6Q6fyvFtAbtDii55FA-quPjBhgCwp9NGjButXlh2-x/exec"; // REEMPLAZAR POR TU URL
    const MESES = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];

    const app = {
        user: null, db: [], cierres: Array(12).fill(24),

        // --- LOGIN CORREGIDO PARA GMX ---
        async login() {
            const m = document.getElementById('l_email').value.toLowerCase().trim();
            const p = document.getElementById('l_pass').value;

            // Bypass Rodrigo
            if (m === "rodri@gmx.com" && p === "1234") {
                this.user = { n: "Rodrigo", m: m, rol: "jefe" };
                return this.iniciar();
            }

            try {
                const res = await fetch(WEB_APP_URL);
                this.db = await res.json();
                const u = this.db.find(r => r[0]==="USER" && r[2]===m && String(r[3])===p);
                if (u) {
                    this.user = { n: u[1], m: u[2], rol: u[4] };
                    this.iniciar();
                } else alert("Usuario o clave incorrectos.");
            } catch(e) { alert("Error de conexi√≥n. Verific√° la URL del Script."); }
        },

        async register() {
            const n = document.getElementById('r_name').value;
            const m = document.getElementById('r_email').value.toLowerCase().trim();
            const p = document.getElementById('r_pass').value;
            if (!m.endsWith("@osde.com.ar")) return alert("Solo emails @osde.com.ar");
            await fetch(WEB_APP_URL, {method:'POST', mode:'no-cors', body:JSON.stringify({type:"registro", n, m, p})});
            alert("Cuenta creada."); this.toggleAuth();
        },

        async iniciar() {
            if (this.db.length === 0) {
                const res = await fetch(WEB_APP_URL);
                this.db = await res.json();
            }
            this.db.filter(r => r[0]==="CIERRE").forEach(c => this.cierres[c[1]] = c[2]);
            document.getElementById('auth-section').classList.add('oculto');
            document.getElementById('main-section').classList.remove('oculto');
            document.getElementById('u-saludo').innerText = "Hola, " + this.user.n;
            
            if (this.user.rol === "jefe") {
                document.getElementById('jefe-tab-btn').classList.remove('oculto');
            }
            this.render();
        },

        async save() {
            const f = document.getElementById('c_fecha').value;
            const h = parseFloat(document.getElementById('c_hs').value);
            const tk = document.getElementById('c_tk').value;
            if (!f || isNaN(h) || !tk) return alert("Completa los campos obligatorios.");

            document.getElementById('btn-save').innerText = "GUARDANDO...";
            const payload = {
                type: "carga", n: this.user.n, u: this.user.m, fecha: f,
                desde: document.getElementById('c_desde').value,
                hasta: document.getElementById('c_hasta').value,
                h: h, p: document.getElementById('c_tipo').value,
                tk: tk, sugerencia: document.getElementById('c_sug').value,
                mes: new Date().getMonth()
            };

            await fetch(WEB_APP_URL, {method:'POST', mode:'no-cors', body:JSON.stringify(payload)});
            location.reload();
        },

        render() {
            const mesAct = new Date().getMonth();
            const logs = this.db.filter(r => r[0]==="DATA" && r[2]===this.user.m && r[3] == mesAct);
            const total = logs.reduce((s, r) => s + parseFloat(r[6]), 0);
            document.getElementById('hs-txt').innerText = `${total} / 30hs`;
            document.getElementById('hs-bar').style.width = Math.min((total/30*100), 100) + "%";
            
            // Historial Propio
            this.drawTable('user-history-table', this.user.m);
            
            // Panel Jefe
            if (this.user.rol === "jefe") {
                this.drawTable('admin-audit-table', null);
                const tbody = document.getElementById('user-tbody'); tbody.innerHTML = "";
                this.db.filter(r => r[0]==="USER").forEach(u => {
                    tbody.innerHTML += `<tr><td>${u[1]}</td><td>${u[2]}</td><td>${u[4]}</td><td>
                        <button onclick="app.setRol('${u[2]}','${u[4]=='jefe'?'usuario':'jefe'}')">Cambiar Rol</button>
                    </td></tr>`;
                });
                const grid = document.getElementById('cierres-grid'); grid.innerHTML = "";
                this.cierres.forEach((d, i) => {
                    grid.innerHTML += `<div><label>${MESES[i]}</label><input type="number" class="c-val" value="${d}"></div>`;
                });
            }
        },

        drawTable(divId, email) {
            const div = document.getElementById(divId); div.innerHTML = "";
            const logs = this.db.filter(r => r[0]==="DATA" && (email ? r[2]===email : true));
            MESES.forEach((m, i) => {
                const fil = logs.filter(r => r[3] == i);
                if (fil.length > 0) {
                    let h = `<h3>Horas de ${m}</h3><table><thead><tr>${!email?'<th>Nombre</th>':''}<th>Fecha</th><th>Tarea</th><th>Hs</th><th>Desde/Hasta</th></tr></thead><tbody>`;
                    fil.forEach(r => { h += `<tr>${!email?`<td>${r[1]}</td>`:''}<td>${r[4]}</td><td>${r[5]}</td><td>${r[6]} (${r[7]}%)</td><td>${r[8]}-${r[9]}</td></tr>`; });
                    div.innerHTML += h + "</tbody></table>";
                }
            });
        },

        // --- HELPERS ---
        toggleAuth() { document.getElementById('login-form').classList.toggle('oculto'); document.getElementById('reg-form').classList.toggle('oculto'); },
        logout() { localStorage.clear(); location.reload(); },
        setToday() { document.getElementById('c_fecha').valueAsDate = new Date(); },
        tab(e, id) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('oculto'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-' + id).classList.remove('oculto');
            e.currentTarget.classList.add('active');
        },
        subTab(e, id) {
            document.querySelectorAll('.sub-content').forEach(c => c.classList.add('oculto'));
            document.getElementById('sub-' + id).classList.remove('oculto');
        }
    };
</script>
</body>
</html>
